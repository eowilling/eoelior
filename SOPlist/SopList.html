<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOP 標準作業程序撰寫工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .container-card {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            margin: 2rem auto;
            transition: all 0.3s;
        }
        .input-style {
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-style:focus {
            border-color: #2563EB; /* 藍色焦點 */
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .btn-primary {
            background-color: #2563EB;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #1D4ED8;
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .section-title {
            border-left: 4px solid #F97316; /* 橘色強調 */
            padding-left: 0.75rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

<div id="app" class="container-card">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">⚙️ SOP 標準作業程序撰寫工具</h1>
    <p class="text-center text-gray-500 mb-8">請依照步驟填寫，最後生成標準化 SOP 文件。</p>

    <!-- 區塊 1: 基本資訊 -->
    <div class="mb-10 p-6 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
        <h2 class="text-2xl font-bold text-blue-700 section-title">1. 文件基本資訊</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">程序名稱 (Title)</label>
                <input type="text" id="title" class="input-style" placeholder="產品出貨檢驗程序" oninput="updateHeader('title', this.value)">
            </div>
            <div>
                <label for="id" class="block text-sm font-medium text-gray-700 mb-1">文件編號 (ID)</label>
                <input type="text" id="id" class="input-style" placeholder="SOP-QC-001" oninput="updateHeader('id', this.value)">
            </div>
            <div>
                <label for="version" class="block text-sm font-medium text-gray-700 mb-1">版本/版次 (Version)</label>
                <input type="text" id="version" class="input-style" value="V1.0" oninput="updateHeader('version', this.value)">
            </div>
            <div class="md:col-span-3">
                <label for="date" class="block text-sm font-medium text-gray-700 mb-1">發布日期 (Date)</label>
                <input type="date" id="date" class="input-style" oninput="updateHeader('date', this.value)">
            </div>
        </div>
    </div>

    <!-- 區塊 2: 目的與範圍 -->
    <div class="mb-10 p-6 bg-green-50 border-l-4 border-green-500 rounded-lg">
        <h2 class="text-2xl font-bold text-green-700 section-title">2. 目的與適用範圍</h2>
        <div class="mb-4">
            <label for="purpose" class="block text-sm font-medium text-gray-700 mb-1">目的 (Purpose)</label>
            <textarea id="purpose" class="input-style h-20" placeholder="說明此程序的主要目標與預期結果，例如：標準化檢驗流程，確保產品品質符合客戶要求。" oninput="updateHeader('purpose', this.value)"></textarea>
        </div>
        <div>
            <label for="scope" class="block text-sm font-medium text-gray-700 mb-1">適用範圍 (Scope)</label>
            <textarea id="scope" class="input-style h-16" placeholder="說明此程序適用於哪些部門、人員或產品。" oninput="updateHeader('scope', this.value)"></textarea>
        </div>
        <div class="mt-4">
            <label for="responsibility" class="block text-sm font-medium text-gray-700 mb-1">權責說明 (Responsibility)</label>
            <textarea id="responsibility" class="input-style h-16" placeholder="列出各主要角色的權責，例如：檢驗人員：執行步驟 4.1-4.5；倉儲人員：執行步驟 5.0。" oninput="updateHeader('responsibility', this.value)"></textarea>
        </div>
    </div>

    <!-- 區塊 3: 流程步驟詳述 -->
    <div class="mb-10 p-6 bg-yellow-50 border-l-4 border-yellow-600 rounded-lg">
        <h2 class="text-2xl font-bold text-yellow-700 section-title mb-4">3. 作業流程步驟 (Procedure)</h2>
        <div id="steps-container" class="space-y-4">
            <!-- Steps will be rendered here -->
        </div>
        <button onclick="addStep()" class="mt-6 w-full btn-primary bg-yellow-600 hover:bg-yellow-700 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            新增流程步驟
        </button>
    </div>

    <!-- 區塊 4: 生成 SOP -->
    <div class="p-6 bg-gray-100 rounded-lg text-center">
        <h2 class="text-2xl font-bold text-gray-800 section-title mb-4 border-l-4 border-gray-500">4. SOP 文件生成與輸出</h2>
        <button onclick="generateSOPMarkdown()" class="btn-primary w-full md:w-1/2 mx-auto">
            一鍵生成 SOP 文件 (Markdown 格式)
        </button>
        <div id="output-area" class="mt-6 hidden">
            <h3 class="text-xl font-semibold mb-3 text-left">Generated SOP Output (Markdown)</h3>
            <textarea id="markdown-output" class="input-style h-64 font-mono text-xs" readonly></textarea>
            <button onclick="copyToClipboard()" class="mt-3 w-full btn-primary bg-green-600 hover:bg-green-700">
                複製到剪貼簿
            </button>
        </div>
    </div>
</div>

<script>
    // SOP 數據模型
    let sopData = {
        title: '產品出貨檢驗標準作業程序',
        id: 'SOP-QC-001',
        version: 'V1.0',
        date: new Date().toISOString().split('T')[0],
        purpose: '本程序旨在標準化產品出貨前的最終檢驗流程，確保出貨產品完全符合客戶訂單與質量標準，以避免客訴。',
        scope: '適用於質量管理部所有檢驗人員，以及所有準備出貨的訂單產品。',
        responsibility: '質量管理部檢驗人員：執行檢驗步驟；倉儲人員：負責協助產品移動與包裝；品管主管：最終核准放行。',
        steps: [
            { id: 1, description: '接收倉儲部門提出的「出貨檢驗申請單」。', subSteps: [] },
            { id: 2, description: '確認檢驗工具（卡尺、電表等）已在校正有效期限內。', subSteps: [] },
            { id: 3, description: '根據訂單編號，調閱系統中的「客戶特殊要求」文件。', subSteps: [] },
            {
                id: 4,
                description: '執行外觀與功能抽樣檢測：',
                subSteps: [
                    '抽樣數量：從總數量中隨機抽取 5% 產品。',
                    '外觀檢查：確認顏色、標籤、包裝無破損或錯誤。',
                    '功能測試：依據測試規範進行功能測試，記錄結果。',
                ]
            },
            { id: 5, description: '判斷檢驗結果：若有任何不合格項目，請轉至「異常處理流程 (SOP-QC-009)」；否則繼續步驟 6。', subSteps: [] },
            { id: 6, description: '在「出貨檢驗清單」上簽名並註記「合格」，通知倉儲部門進行打包。', subSteps: [] }
        ]
    };

    // 初始化輸入框
    document.getElementById('date').value = sopData.date;
    document.getElementById('title').value = sopData.title;
    document.getElementById('id').value = sopData.id;
    document.getElementById('version').value = sopData.version;
    document.getElementById('purpose').value = sopData.purpose;
    document.getElementById('scope').value = sopData.scope;
    document.getElementById('responsibility').value = sopData.responsibility;

    // --- 數據管理功能 ---

    // 取得下一個可用的 Step ID
    const getNextStepId = () => {
        return sopData.steps.length > 0 ? Math.max(...sopData.steps.map(s => s.id)) + 1 : 1;
    };

    // 更新基本資訊 (Title, ID, Purpose, etc.)
    const updateHeader = (key, value) => {
        sopData[key] = value;
    };

    // 渲染所有流程步驟
    const renderSteps = () => {
        const container = document.getElementById('steps-container');
        container.innerHTML = '';

        sopData.steps.sort((a, b) => a.id - b.id).forEach((step, index) => {
            const stepElement = document.createElement('div');
            stepElement.className = 'p-4 border border-gray-300 rounded-lg bg-white relative';
            stepElement.setAttribute('data-id', step.id);

            // 步驟標題與操作按鈕
            stepElement.innerHTML = `
                <div class="flex items-center space-x-3 mb-2">
                    <span class="text-lg font-bold text-gray-800 bg-yellow-200 px-3 py-1 rounded-full">${index + 1}.</span>
                    <textarea
                        id="step-desc-${step.id}"
                        class="input-style flex-grow"
                        rows="2"
                        placeholder="請使用動作動詞開頭，例如：執行、確認、記錄..."
                        oninput="updateStepDescription(${step.id}, this.value)"
                    >${step.description}</textarea>

                    <div class="flex flex-col space-y-1">
                        <button onclick="moveStep(${step.id}, 'up')" class="p-1 text-gray-600 hover:text-blue-600 disabled:opacity-50" ${index === 0 ? 'disabled' : ''} title="上移">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <button onclick="moveStep(${step.id}, 'down')" class="p-1 text-gray-600 hover:text-blue-600 disabled:opacity-50" ${index === sopData.steps.length - 1 ? 'disabled' : ''} title="下移">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    <button onclick="removeStep(${step.id})" class="p-2 text-red-500 hover:bg-red-100 rounded-full transition-colors" title="刪除步驟">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <!-- 子步驟區塊 -->
                <div class="pl-10 pt-2 border-t border-dashed border-gray-200 mt-2">
                    <h4 class="text-sm font-semibold mb-1 text-gray-600">子步驟/備註 (可選)</h4>
                    <textarea
                        id="substeps-desc-${step.id}"
                        class="input-style w-full text-sm"
                        rows="${Math.max(2, step.subSteps.length + 1)}"
                        placeholder="每行一個細節或標準。例如：溫度設定在 180°C。使用「若...則...」處理判斷點。"
                        oninput="updateSubSteps(${step.id}, this.value)"
                    >${step.subSteps.join('\n')}</textarea>
                </div>
            `;
            container.appendChild(stepElement);
        });
    };

    // 新增步驟
    const addStep = () => {
        const newId = getNextStepId();
        sopData.steps.push({
            id: newId,
            description: `[新步驟 ${newId}] 請輸入具體操作動作。`,
            subSteps: []
        });
        renderSteps();
        // 滾動到新步驟
        setTimeout(() => {
            const newStepElement = document.querySelector(`[data-id="${newId}"]`);
            newStepElement?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById(`step-desc-${newId}`)?.focus();
        }, 100);
    };

    // 移除步驟
    const removeStep = (id) => {
        if (confirm('確定要移除這個步驟嗎？')) {
            sopData.steps = sopData.steps.filter(s => s.id !== id);
            renderSteps();
        }
    };

    // 更新步驟描述
    const updateStepDescription = (id, description) => {
        const step = sopData.steps.find(s => s.id === id);
        if (step) {
            step.description = description;
        }
    };

    // 更新子步驟
    const updateSubSteps = (id, text) => {
        const step = sopData.steps.find(s => s.id === id);
        if (step) {
            // 將 textarea 內容按換行符號切割成陣列，並過濾空行
            step.subSteps = text.split('\n').map(s => s.trim()).filter(s => s.length > 0);
        }
    };

    // 移動步驟 (上/下)
    const moveStep = (id, direction) => {
        const index = sopData.steps.findIndex(s => s.id === id);
        if (index === -1) return;

        const newIndex = direction === 'up' ? index - 1 : index + 1;

        if (newIndex >= 0 && newIndex < sopData.steps.length) {
            [sopData.steps[index], sopData.steps[newIndex]] = [sopData.steps[newIndex], sopData.steps[index]];
            renderSteps();
        }
    };


    // --- SOP 文件生成 ---

    const generateSOPMarkdown = () => {
        const sortedSteps = sopData.steps.sort((a, b) => a.id - b.id);

        let markdown = `# ${sopData.title}\n\n`;
        markdown += `| 項目 | 內容 | | :--- | :--- |\n`;
        markdown += `| **文件編號** | ${sopData.id || '(未填寫)'} |\n`;
        markdown += `| **版本/版次** | ${sopData.version || 'V1.0'} |\n`;
        markdown += `| **發行日期** | ${sopData.date || '(未填寫)'} |\n`;
        markdown += `| **撰寫人/部門** | (請自行填寫) |\n`;
        markdown += `| **審核/核准人** | (請自行填寫) |\n\n`;

        markdown += `## 1. 目的 (Purpose)\n`;
        markdown += `${sopData.purpose || '(請填寫 SOP 目的)'}\n\n`;

        markdown += `## 2. 適用範圍與權責 (Scope & Responsibility)\n`;
        markdown += `### 2.1 適用範圍\n`;
        markdown += `${sopData.scope || '(請填寫 SOP 適用範圍)'}\n\n`;
        markdown += `### 2.2 權責劃分\n`;
        markdown += `${sopData.responsibility || '(請填寫主要角色與權責)'}\n\n`;

        markdown += `## 3. 作業流程步驟 (Procedure)\n`;

        sortedSteps.forEach((step, index) => {
            // 主步驟 (使用編號 3.1, 3.2, ...)
            markdown += `### 3.${index + 1} ${step.description}\n`;

            // 子步驟 (使用清單項目)
            if (step.subSteps && step.subSteps.length > 0) {
                step.subSteps.forEach(sub => {
                    markdown += `* ${sub}\n`;
                });
                markdown += '\n'; // 增加換行保持清晰
            } else {
                markdown += '\n';
            }
        });

        markdown += `\n---\n`;
        markdown += `## 4. 相關文件與紀錄\n\n`;
        markdown += `* **相關表格**：\n`;
        markdown += `* **參考文件**：\n`;

        document.getElementById('markdown-output').value = markdown;
        document.getElementById('output-area').classList.remove('hidden');
    };

    // 複製到剪貼簿 (使用較為兼容的 execCommand)
    const copyToClipboard = () => {
        const textarea = document.getElementById('markdown-output');
        textarea.select();
        try {
            document.execCommand('copy');
            alertMessage('複製成功！請將 Markdown 文件貼至您的文件系統中。', 'bg-green-500');
        } catch (err) {
            alertMessage('複製失敗，請手動選取並複製。', 'bg-red-500');
        }
    };

    // 替代 alert() 的訊息框
    const alertMessage = (message, bgColor) => {
        let msgBox = document.getElementById('custom-alert');
        if (!msgBox) {
            msgBox = document.createElement('div');
            msgBox.id = 'custom-alert';
            msgBox.className = 'fixed top-5 right-5 z-50 p-4 text-white rounded-lg shadow-xl transition-opacity duration-300';
            document.body.appendChild(msgBox);
        }
        msgBox.className = `fixed top-5 right-5 z-50 p-4 text-white rounded-lg shadow-xl transition-opacity duration-300 ${bgColor}`;
        msgBox.textContent = message;
        msgBox.style.opacity = 1;
        setTimeout(() => {
            msgBox.style.opacity = 0;
        }, 3000);
    };

    // 啟動應用
    window.onload = () => {
        renderSteps();
    };

</script>
</body>
</html>
