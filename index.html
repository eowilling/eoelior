<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eoElior | ç§˜å¯†è½‰ç›¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'Noto Sans TC', 'sans-serif'] },
                    colors: { 'accent-spin': '#fcd34d' }
                }
            }
        }
    </script>
    <style>
        #wheelCanvas {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border-radius: 9999px;
            transition: transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99);
        }
        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #f8fafc;
            z-index: 20;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: auto;
            aspect-ratio: 1 / 1;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col font-sans">

    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="p-6 flex justify-between items-center">
        <a href="../index.html" class="flex items-center gap-2 text-slate-400 hover:text-white transition-all">
            <i class="fa-solid fa-box-open"></i> å›ç©å…·ç›’å­
        </a>
        <div id="dbStatus" class="text-[10px] px-3 py-1 rounded-full bg-slate-800 border border-slate-700 text-slate-500">
            <i class="fa-solid fa-circle text-[8px] mr-1"></i> é›²ç«¯æœªé€£ç·š
        </div>
    </nav>

    <main class="flex-grow flex flex-col items-center justify-center p-4">
        <div class="max-w-4xl w-full grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- å·¦å´ï¼šè½‰ç›¤æœ¬é«” -->
            <div class="lg:col-span-2 glass-card p-8 rounded-3xl relative overflow-hidden">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold gradient-text" id="wheelTitle">å‘½é‹è¼ªç›¤</h2>
                    <p id="wheelDescription" class="text-slate-400 text-sm mt-2"></p>
                </div>

                <div class="canvas-container mb-8">
                    <div class="pointer"></div>
                    <canvas id="wheelCanvas" width="400" height="400" class="w-full h-full"></canvas>
                </div>

                <div class="flex flex-col items-center gap-4">
                    <button id="spinButton" class="w-full md:w-auto px-16 py-4 bg-indigo-600 hover:bg-indigo-500 text-white text-xl font-bold rounded-2xl shadow-lg shadow-indigo-900/40 transition-all transform active:scale-95 disabled:opacity-50">
                        é–‹å§‹æ—‹è½‰ï¼
                    </button>
                    <div id="resultDisplay" class="text-xl font-bold text-indigo-300 min-h-[1.5em]"></div>
                </div>

                <!-- éš±è—çš„æ©Ÿç‡å…¥å£ (é»æ“Šç¸½å’Œé€²å…¥ç®¡ç†å“¡æ¨¡å¼) -->
                <div class="mt-8 pt-6 border-t border-white/5 opacity-40 hover:opacity-100 transition-opacity">
                    <div class="flex justify-between items-center text-xs text-slate-500">
                        <span id="secretEntry">ç¸½æ©Ÿç‡è¨ˆæ•¸ï¼š100% (é»æ“Šè¨­å®š)</span>
                        <a href="admin.html" class="underline">ç°¡æ˜“è¨­å®š</a>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šåŠŸèƒ½å€ -->
            <div class="space-y-6">
                <!-- é›²ç«¯åˆ†äº«å€ -->
                <div class="glass-card p-6 rounded-3xl">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-share-nodes text-indigo-400"></i> é›²ç«¯åˆ†äº«é€£çµ
                    </h3>
                    <div class="space-y-4">
                        <button id="cloudShareBtn" class="w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-xl text-sm font-medium transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-cloud-arrow-up"></i> å­˜å…¥é›²ç«¯ä¸¦åˆ†äº«
                        </button>
                        <div id="shareArea" class="hidden space-y-2">
                            <input type="text" id="shareUrlInput" readonly class="w-full bg-black/30 border border-slate-700 rounded-lg px-3 py-2 text-[10px] text-indigo-300">
                            <button id="copyBtn" class="w-full bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-300 py-2 rounded-lg text-xs transition-all">è¤‡è£½é€£çµ</button>
                        </div>
                    </div>
                </div>

                <!-- æ­·å²ç´€éŒ„ -->
                <div class="glass-card p-6 rounded-3xl flex-grow h-[300px] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-sm uppercase tracking-wider text-slate-500">æ­·å²ç´€éŒ„</h3>
                        <button id="resetHistoryBtn" class="text-[10px] text-rose-400 hover:underline">æ¸…é™¤</button>
                    </div>
                    <div id="historyDisplay" class="overflow-y-auto space-y-2 flex-grow pr-2 text-xs">
                        <p class="text-slate-600 italic text-center py-8">ç›®å‰å°šç„¡ç´€éŒ„</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase åˆå§‹åŒ–
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ä¿®æ­£ appId ä¸­çš„æ–œç·šå•é¡Œï¼Œç¢ºä¿ Firestore è·¯å¾‘æ®µæ•¸æ­£ç¢º
        const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'elior-wheel-v1';
        const appId = rawAppId.replace(/\//g, '_');

        // é è¨­é…ç½®
        const defaultConfig = {
            title: "å‘½é‹è¼ªç›¤",
            description: "é€™æ˜¯ä¸€å€‹å…¬å¹³ã€å…¬æ­£ã€å…¬é–‹çš„è½‰ç›¤ (å¤§æ¦‚å§)",
            segments: [
                { label: "è²·", color: '#10b981', visualPercent: 50, realPercent: 80 },
                { label: "ä¸è²·", color: '#ef4444', visualPercent: 50, realPercent: 20 }
            ]
        };

        let config = JSON.parse(JSON.stringify(defaultConfig));
        let currentUser = null;
        let isSpinning = false;
        let currentRotation = 0;

        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spinButton');
        const resultDisplay = document.getElementById('resultDisplay');
        const historyDisplay = document.getElementById('historyDisplay');
        const dbStatus = document.getElementById('dbStatus');

        // 1. å•Ÿå‹•èº«ä»½é©—è­‰èˆ‡ URL æª¢æŸ¥
        async function init() {
            try {
                // å„ªå…ˆä½¿ç”¨è‡ªå®šç¾© Token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        dbStatus.innerHTML = '<i class="fa-solid fa-circle text-[8px] mr-1 text-emerald-500"></i> é›²ç«¯å·²é€£ç·š';
                        await checkUrlParams();
                        renderUI();
                    }
                });
            } catch (e) {
                console.error("Auth init failed", e);
                dbStatus.innerHTML = '<i class="fa-solid fa-circle text-[8px] mr-1 text-rose-500"></i> é€£ç·šé©—è­‰å¤±æ•—';
            }
        }

        // æª¢æŸ¥ URL åƒæ•¸ (åŒæ™‚æ”¯æ´ c=Base64 å’Œ share=ID)
        async function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const shareId = params.get('share');
            const configParam = params.get('c');

            if (shareId) {
                dbStatus.innerHTML = '<i class="fa-solid fa-spinner animate-spin mr-1"></i> æ­£åœ¨æŠ“å–é›²ç«¯è½‰ç›¤...';
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared_wheels', shareId);
                    const snap = await getDoc(docRef);
                    if (snap.exists()) {
                        config = snap.data();
                        dbStatus.innerHTML = '<i class="fa-solid fa-circle text-[8px] mr-1 text-emerald-500"></i> é›²ç«¯è¼‰å…¥æˆåŠŸ';
                    }
                } catch (e) { console.error("Cloud load fail", e); }
            } else if (configParam) {
                try {
                    const decoded = JSON.parse(atob(configParam.replace(/-/g, '+').replace(/_/g, '/')));
                    config.title = decoded.t || decoded.title;
                    config.segments = (decoded.s || decoded.segments).map(s => ({
                        label: s.l || s.label,
                        color: s.c || s.color,
                        visualPercent: s.v || s.visualPercent,
                        realPercent: s.r !== undefined ? s.r : (s.v || s.visualPercent)
                    }));
                } catch (e) { console.warn("Base64 decode fail"); }
            }
        }

        function renderUI() {
            document.getElementById('wheelTitle').innerText = config.title;
            document.getElementById('wheelDescription').innerText = config.description || "";
            drawWheel();
            renderHistory();
        }

        function drawWheel() {
            const centerX = 200;
            const centerY = 200;
            const radius = 190;
            let currentAngle = 0;

            ctx.clearRect(0, 0, 400, 400);

            config.segments.forEach(seg => {
                const degrees = (seg.visualPercent / 100) * 360;
                const arc = (degrees * Math.PI) / 180;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + arc);
                ctx.fillStyle = seg.color;
                ctx.fill();

                // ç¹ªè£½æ–‡å­—
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(currentAngle + arc / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "white";
                ctx.font = "bold 16px Noto Sans TC";
                ctx.fillText(seg.label, radius - 20, 5);
                ctx.restore();

                currentAngle += arc;
            });

            // ç¹ªè£½åœ“å¿ƒ
            ctx.beginPath();
            ctx.arc(centerX, centerY, 30, 0, Math.PI * 2);
            ctx.fillStyle = "#0f172a";
            ctx.fill();
            ctx.strokeStyle = "rgba(255,255,255,0.1)";
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // è½‰å‹•è½‰ç›¤é‚è¼¯
        function spin() {
            if (isSpinning) return;
            isSpinning = true;
            spinButton.disabled = true;
            resultDisplay.innerText = "æ—‹è½‰ä¸­...";

            const random = Math.random() * 100;
            let cumulative = 0;
            let selectedIndex = 0;
            for (let i = 0; i < config.segments.length; i++) {
                cumulative += config.segments[i].realPercent;
                if (random <= cumulative) {
                    selectedIndex = i;
                    break;
                }
            }

            const segment = config.segments[selectedIndex];
            let visualStartAngle = 0;
            for(let i=0; i<selectedIndex; i++) visualStartAngle += (config.segments[i].visualPercent/100)*360;
            const visualMidAngle = visualStartAngle + (segment.visualPercent/100)*180;

            const targetAngle = (270 - visualMidAngle + 360) % 360;
            const fullRotations = (8 + Math.floor(Math.random() * 5)) * 360;
            const finalRotation = currentRotation + fullRotations + targetAngle - (currentRotation % 360);

            canvas.style.transform = `rotate(${finalRotation}deg)`;
            currentRotation = finalRotation;

            setTimeout(() => {
                isSpinning = false;
                spinButton.disabled = false;
                const result = config.segments[selectedIndex];
                resultDisplay.innerText = `ğŸ‰ çµæœï¼š${result.label}`;
                addHistory(result);
            }, 5000);
        }

        // é›²ç«¯åˆ†äº«åŠŸèƒ½ (Firestore)
        document.getElementById('cloudShareBtn').onclick = async () => {
            if (!currentUser) return;
            const btn = document.getElementById('cloudShareBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> å„²å­˜ä¸­...';

            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'shared_wheels');
                const docRef = await addDoc(colRef, {
                    ...config,
                    createdAt: new Date(),
                    creator: currentUser.uid
                });

                const shareUrl = window.location.origin + window.location.pathname + "?share=" + docRef.id;
                document.getElementById('shareUrlInput').value = shareUrl;
                document.getElementById('shareArea').classList.remove('hidden');
            } catch (e) {
                console.error("Upload failed", e);
                alert("å„²å­˜åˆ°é›²ç«¯å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
            finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> å­˜å…¥é›²ç«¯ä¸¦åˆ†äº«';
            }
        };

        // æ­·å²ç´€éŒ„è™•ç†
        function addHistory(res) {
            const history = JSON.parse(localStorage.getItem('wheel_history') || '[]');
            history.unshift({ label: res.label, color: res.color, time: new Date().toLocaleTimeString() });
            localStorage.setItem('wheel_history', JSON.stringify(history.slice(0, 10)));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('wheel_history') || '[]');
            if (history.length === 0) return;
            historyDisplay.innerHTML = history.map(h => `
                <div class="flex justify-between items-center bg-white/5 p-2 rounded-lg">
                    <span class="font-bold" style="color: ${h.color}">${h.label}</span>
                    <span class="text-[9px] text-slate-600">${h.time}</span>
                </div>
            `).join('');
        }

        // ç§˜å¯†å…¥å£é‚è¼¯
        document.getElementById('secretEntry').ondblclick = () => {
            window.location.href = 'adminplus.html';
        };

        document.getElementById('copyBtn').onclick = () => {
            document.getElementById('shareUrlInput').select();
            document.execCommand('copy');
            document.getElementById('copyBtn').innerText = "å·²è¤‡è£½ï¼";
            setTimeout(() => document.getElementById('copyBtn').innerText = "è¤‡è£½é€£çµ", 2000);
        };

        document.getElementById('resetHistoryBtn').onclick = () => {
            localStorage.removeItem('wheel_history');
            historyDisplay.innerHTML = '<p class="text-slate-600 italic text-center py-8">ç›®å‰å°šç„¡ç´€éŒ„</p>';
        };

        spinButton.onclick = spin;
        init();
    </script>
</body>
</html>
