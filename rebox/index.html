<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼æ¥­çµ‚æ¥µæŠ½çç³»çµ± | Ultimate Rebox</title>
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #7000ff;
            --accent: #ff0055;
            --bg: #050510;
            --card-bg: rgba(20, 20, 35, 0.6);
            --gold: #ffd700;
            --warning: #ff9900;
            --glass: rgba(255, 255, 255, 0.05);
            --neon-glow: 0 0 10px var(--primary), 0 0 20px var(--primary);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Rajdhani', 'Microsoft JhengHei', sans-serif;
        }

        body {
            background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            background-attachment: fixed;
        }

        /* Sci-Fi Grid Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
        }

        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .center {
            align-items: center;
            justify-content: center;
        }

        .gap-4 {
            gap: 1rem;
        }

        .w-full {
            width: 100%;
        }

        /* UI Components */
        .btn {
            padding: 12px 30px;
            border: 1px solid var(--primary);
            background: rgba(0, 242, 255, 0.1);
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }

        .btn:hover {
            background: var(--primary);
            color: #000;
            box-shadow: var(--neon-glow);
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
            font-weight: bold;
        }

        .btn-primary:hover {
            background: #fff;
            box-shadow: 0 0 30px var(--primary);
        }

        .btn-outline {
            border-color: rgba(255, 255, 255, 0.3);
            color: #aaa;
        }

        .btn-outline:hover {
            border-color: #fff;
            color: #fff;
        }

        .btn-danger {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(255, 0, 85, 0.1);
        }

        .btn-danger:hover {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 0 20px var(--accent);
        }

        .btn-warning {
            border-color: var(--warning);
            color: var(--warning);
        }

        .btn-warning:hover {
            background: var(--warning);
            color: #000;
            box-shadow: 0 0 20px var(--warning);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            background: #ff0055;
            box-shadow: 0 0 10px #ff0055;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .status-dot.connected {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        /* Screens */
        section {
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .welcome-wrapper {
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .setup-container {
            max-width: 1000px;
            margin: 40px auto;
            background: rgba(10, 10, 20, 0.9);
            padding: 40px;
            border: 1px solid rgba(0, 242, 255, 0.2);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 4px;
            /* Tech corners */
        }

        /* Typography */
        .main-title {
            font-size: 5rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 10px;
            background: linear-gradient(to bottom, #fff, #aaa);
            -webkit-background-clip: text;
            color: transparent;
            margin-bottom: 0px;
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.5);
        }

        .subtitle {
            color: var(--primary);
            font-size: 1.5rem;
            letter-spacing: 5px;
            margin-bottom: 40px;
            text-transform: uppercase;
        }

        h2,
        h3 {
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        input,
        textarea {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            color: var(--primary);
            padding: 15px;
            width: 100%;
            margin-bottom: 10px;
            font-size: 1.1rem;
            transition: 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }

        /* Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            padding: 40px;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
        }

        .prize-card,
        .showcase-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            position: relative;
            backdrop-filter: blur(5px);
            transition: 0.4s;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .prize-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: var(--primary);
            opacity: 0.2;
            transition: 0.4s;
            z-index: 0;
            pointer-events: none;
        }

        .prize-card:hover::before {
            width: 100%;
        }

        .prize-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .prize-card.special {
            border-color: var(--gold);
        }

        .prize-card.special .stamp {
            border-color: var(--gold);
            color: var(--gold);
        }

        .prize-card.finished {
            opacity: 0.3;
            pointer-events: none;
            filter: grayscale(1);
        }

        /* Modals */
        .modal-overlay,
        .draw-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 90;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: #0a0a15;
            padding: 40px;
            border: 1px solid var(--primary);
            width: 90%;
            max-width: 600px;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.1);
            position: relative;
        }

        .modal-content::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--primary), transparent, var(--secondary));
            z-index: -1;
        }

        /* Draw Area */
        .draw-overlay {
            flex-direction: column;
            background: #000;
        }

        .draw-top {
            padding: 40px;
            text-align: center;
            border-bottom: 1px solid #222;
        }

        .draw-title {
            font-size: 4rem;
            color: #fff;
            text-shadow: 0 0 20px var(--primary);
            font-weight: bold;
        }

        .draw-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-y: auto;
            /* Enable vertical scroll */
            position: relative;
            padding: 20px 0;
            /* Add padding for aesthetics */
            scrollbar-width: thin;
            /* Firefox */
            scrollbar-color: var(--primary) #222;
        }

        .draw-main::-webkit-scrollbar {
            width: 8px;
        }

        .draw-main::-webkit-scrollbar-track {
            background: #222;
        }

        .draw-main::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .result-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
            /* perspective: 1000px; - Removed to simplify layout calc */
            width: 100%;
            max-width: 1600px;
            /* Limit max width on huge screens */
            margin: 0 auto;
        }

        .result-box {
            width: 180px;
            /* Default size */
            height: 140px;
            /* Adjusted height */
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            /* Adjusted font size */
            font-weight: bold;
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.15);
            text-shadow: 0 0 10px var(--primary);
            position: relative;
            border-radius: 8px;
            /* Softer corners */
            transition: all 0.3s ease;
        }

        /* Dynamic sizing classes will be added via JS, but here are modifiers */
        .result-box.small {
            width: 100px;
            height: 80px;
            font-size: 1.5rem;
        }

        .result-box.tiny {
            width: 80px;
            height: 60px;
            font-size: 1rem;
        }

        .result-box.special.revealed {
            background: var(--gold);
            box-shadow: 0 0 60px var(--gold);
        }

        .draw-controls {
            padding: 40px;
            background: linear-gradient(to top, #000, transparent);
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .pool-list {
            position: absolute;
            bottom: 20px;
            left: 20px;
            opacity: 0.3;
            font-size: 0.8rem;
            color: #555;
            max-width: 300px;
            display: none;
            /* Hidden for cleaner look, maybe show on hover? */
        }

        .stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-20deg) scale(3);
            border: 5px solid var(--accent);
            color: var(--accent);
            font-size: 3rem;
            font-weight: 900;
            padding: 10px 40px;
            opacity: 0;
            pointer-events: none;
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            letter-spacing: 5px;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10;
        }

        .stamp.show {
            opacity: 1;
            transform: translate(-50%, -50%) rotate(-20deg) scale(1);
        }

        /* Animations */
        @keyframes glitch {
            0% {
                transform: translate(0);
            }

            20% {
                transform: translate(-2px, 2px);
            }

            40% {
                transform: translate(-2px, -2px);
            }

            60% {
                transform: translate(2px, 2px);
            }

            80% {
                transform: translate(2px, -2px);
            }

            100% {
                transform: translate(0);
            }
        }

        @keyframes revealPop {
            0% {
                transform: scale(0.5) rotateX(90deg);
                opacity: 0;
            }

            100% {
                transform: scale(1) rotateX(0);
                opacity: 1;
            }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #fff;
            animation: fall linear forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(110vh) rotate(720deg);
            }
        }

        .mode-group {
            display: flex;
            background: #222;
            padding: 5px;
            border-radius: 4px;
            margin: 15px 0;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            transition: 0.3s;
        }

        .mode-btn.active {
            background: var(--primary);
            color: #000;
            font-weight: bold;
        }

        .setup-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
            padding: 10px;
        }

        #celebration-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
        }
    </style>
</head>

<body>

    <!-- Effects Layer -->
    <div id="celebration-layer"></div>
    <div id="toast" class="toast"><span id="toast-msg">è¨Šæ¯</span></div>

    <!-- 1. Welcome Screen -->
    <section id="screen-welcome" class="welcome-wrapper">
        <div style="position:absolute; top:20px; right:20px; display:flex; align-items:center;">
            <div id="conn-status" class="status-dot tooltip" title="æœªé€£ç·š"></div>
            <button class="btn btn-outline" onclick="App.showRemoteQR()">ğŸ“± ä¸»æŒäººé™æ§å™¨</button>
            <button class="btn btn-outline" style="margin-left:10px;" onclick="Draw.openDisplay()">ğŸ–¥ï¸ é–‹å•Ÿå¤§è¢å¹•</button>
            <button class="btn btn-outline" style="margin-left:10px;" onclick="App.goToSetup()">âš™ï¸ è¨­å®š</button>
        </div>
        <h1 id="display-activity-name" class="main-title">2024 å¹´åº¦å°¾ç‰™å¤§æŠ½ç</h1>
        <p id="display-subtitle" class="subtitle">Lucky Draw System Pro</p>
        <div
            style="background: rgba(0, 242, 255, 0.1); padding: 15px 40px; border-radius: 50px; display:inline-block; margin-bottom: 30px; border:1px solid var(--primary); box-shadow: 0 0 15px rgba(0,242,255,0.2);">
            å¾…æŠ½äººæ•¸ï¼š<span id="total-people"
                style="color:var(--primary); font-size: 2rem; font-weight:bold; text-shadow:0 0 10px var(--primary);">0</span>
        </div>
        <h3 style="margin-bottom:20px; color:#aaa;">çå“ç¸½è¦½</h3>
        <div id="showcase-grid" class="dashboard-grid" style="padding:0; gap:20px;"></div>
        <button class="btn btn-primary" style="font-size:1.5rem; margin-top:40px; padding: 15px 50px;"
            onclick="App.checkAndStart()">ğŸš€
            é€²å…¥æŠ½çç³»çµ±</button>
    </section>

    <!-- 2. Setup Screen -->
    <section id="screen-setup" class="setup-container hidden">
        <div class="flex" style="justify-content:space-between; margin-bottom:20px;">
            <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
            <button class="btn btn-outline" onclick="App.goToWelcome()">è¿”å›</button>
        </div>
        <div style="margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:20px;">
            <label style="display:block; text-align:left; color:#aaa; margin-bottom:5px;">æ´»å‹•è³‡è¨Š</label>
            <input type="text" id="setup-activity-name" placeholder="æ´»å‹•åç¨±">
            <input type="text" id="setup-subtitle" placeholder="å‰¯æ¨™é¡Œ">
        </div>
        <div style="margin-bottom:20px; text-align:left;">
            <label style="color:#aaa; display:block; margin-bottom:5px;">çé …è¨­å®š</label>
            <div id="prizes-input-list"></div>
            <button class="btn btn-outline w-full" onclick="Setup.addPrizeRow()">+ æ–°å¢çé …</button>
        </div>
        <div style="margin-bottom:20px; text-align:left;">
            <label style="color:#aaa; display:block; margin-bottom:5px;">åƒèˆ‡äººå“¡åå–®</label>
            <div class="flex gap-4">
                <input type="number" id="quick-num" placeholder="è¼¸å…¥äººæ•¸å¿«é€Ÿç”Ÿæˆ (ä¾‹å¦‚: 100)" style="margin-bottom:0;">
                <button class="btn btn-primary" onclick="Setup.quickImport()">ç”Ÿæˆ</button>
            </div>
            <textarea id="participants-input" rows="5" placeholder="è¼¸å…¥åå–®ï¼Œä»¥é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”..."></textarea>
        </div>
        <div class="flex gap-4">
            <button class="btn btn-warning w-full" onclick="Setup.resetWinners()">é‡ç½®æŠ½çç‹€æ…‹</button>
            <button class="btn btn-primary w-full" onclick="Setup.save()">å„²å­˜è¨­å®š</button>
        </div>
    </section>

    <!-- 3. Dashboard -->
    <section id="screen-dashboard" class="hidden">
        <header class="flex"
            style="justify-content:space-between; padding:20px 40px; border-bottom:1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.5);">
            <h2 style="font-size:2rem;">ğŸ‰ æŠ½çæ§åˆ¶å°</h2>
            <div class="flex gap-4">
                <button class="btn btn-outline" style="border-color:var(--primary); color:var(--primary);"
                    onclick="App.showRemoteQR()">ğŸ“± ä¸»æŒäººé™æ§å™¨</button>
                <button class="btn btn-outline" onclick="Draw.openDisplay()">ğŸ–¥ï¸ é–‹å•Ÿå¤§è¢å¹•</button>
                <button class="btn btn-outline" onclick="Results.show()">ğŸ“œ ä¸­çåå–®</button>
                <button class="btn btn-danger" onclick="location.reload()">çµæŸæ´»å‹•</button>
            </div>
        </header>
        <div id="dash-grid" class="dashboard-grid"></div>
    </section>

    <!-- 4. Prep Modal -->
    <section id="screen-prep" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary); margin-bottom: 20px;">æº–å‚™é–‹ç</h3>
            <div
                style="text-align:center; margin-bottom:25px; padding: 20px; background:rgba(0,0,0,0.3); border-radius:10px;">
                <div id="prep-prize-name" style="font-size:2rem; font-weight:bold; color:#fff; margin-bottom:10px;">
                </div>
                <div style="font-size:1rem; color:#aaa;">æœ¬è¼ªå‰©é¤˜åé¡: <span id="prep-remain-count"
                        style="color:var(--primary); font-size:1.5rem; font-weight:bold;">0</span></div>
            </div>

            <label style="display:block; text-align:left; font-size:0.9rem; color:#aaa;">é–‹çå˜‰è³“</label>
            <input type="text" id="prep-host" placeholder="è¼¸å…¥å˜‰è³“å§“å">

            <label style="display:block; text-align:left; font-size:0.9rem; color:#aaa; margin-top:15px;">æŠ½çæ¨¡å¼</label>
            <div class="mode-group">
                <button class="mode-btn active" onclick="Prep.setMode('one', this)">å–®æŠ½ (1)</button>
                <button class="mode-btn" onclick="Prep.setMode('half', this)">åŠé–‹ (1/2)</button>
                <button class="mode-btn" onclick="Prep.setMode('all', this)">å…¨é–‹ (All)</button>
                <button class="mode-btn" onclick="Prep.setMode('custom', this)">è‡ªè¨‚æ•¸é‡</button>
            </div>
            <input type="number" id="prep-custom-num" class="hidden" placeholder="è¼¸å…¥æœ¬è¼ªæŠ½å–æ•¸é‡" style="margin-bottom:20px;">

            <div class="flex gap-4" style="margin-top: 20px;">
                <button class="btn btn-danger w-full" onclick="Prep.close()">å–æ¶ˆ</button>
                <button class="btn btn-primary w-full" onclick="Prep.confirm()">ç¢ºèªä¸¦å‰å¾€</button>
            </div>
        </div>
    </section>

    <!-- 5. Drawing Screen -->
    <section id="screen-draw" class="draw-overlay hidden">
        <div class="draw-top">
            <div id="draw-title" class="draw-title">çé …åç¨±</div>
            <div style="color:#aaa; margin-top:10px; font-size:1.2rem;">
                æœ¬è¼ªæŠ½ç: <span id="draw-count-display" style="color:#fff; font-weight:bold;">0</span> äºº |
                å‰©é¤˜: <span id="draw-remain-count" style="color:var(--primary)">0</span>
            </div>
            <div
                style="color:var(--gold); margin-top:15px; background:rgba(255,215,0,0.1); padding:5px 20px; border-radius:20px; display:inline-block; border:1px solid var(--gold);">
                ğŸ¤ <span id="draw-host-name"></span>
            </div>
        </div>
        <div class="draw-main">
            <div id="result-area" class="result-container"></div>
        </div>
        <div class="draw-controls">
            <button id="btn-draw-action" class="btn btn-primary"
                style="font-size:2rem; padding:15px 60px; min-width: 300px;" onclick="Draw.action()">é–‹å§‹æ»¾å‹•</button>
        </div>

        <!-- Pool Display hidden by default per CSS, but good to keep in DOM -->
        <div id="pool-display" class="pool-list"></div>
    </section>

    <!-- 6. Results Modal -->
    <section id="screen-results" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:800px;">
            <div class="flex" style="justify-content:space-between; margin-bottom:20px;">
                <h2>ğŸ“œ ä¸­çåå–®</h2>
                <button class="btn btn-outline" onclick="Results.close()">é—œé–‰</button>
            </div>
            <div id="results-list" style="max-height:60vh; overflow-y:auto; padding-right: 10px;"></div>
        </div>
    </section>

    <!-- 7. Remote QR Modal -->
    <section id="screen-remote-qr" class="modal-overlay hidden"
        onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="modal-content" style="text-align:center;">
            <h3 style="color:var(--primary); margin-bottom:10px;">ğŸ“± ä¸»æŒäººé™æ§å™¨é€£ç·š</h3>
            <p style="color:#aaa; margin-bottom:20px;">è«‹ä½¿ç”¨æ‰‹æ©Ÿæƒæä¸‹æ–¹ QR Code å³å¯é€£ç·š</p>
            <div style="background:#fff; padding:20px; display:inline-block; border-radius:10px;">
                <img id="remote-qr-img" src="" alt="Remote QR Code" style="width:250px; height:250px;">
            </div>
            <p style="margin-top:20px; color:#666; font-size:0.9rem;">
                é€£çµç¶²å€: <span id="remote-url-text" style="color:var(--primary); word-break:break-all;">...</span>
            </p>
            <button class="btn btn-primary w-full" style="margin-top:20px;"
                onclick="document.getElementById('screen-remote-qr').classList.add('hidden')">é—œé–‰</button>
        </div>
    </section>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase Config - User will need to replace this if they want their own project
        // For now, using a structure that allows external injection or placeholder
        // Firebase Config is now loaded from firebase-config.js
        // Access via window.__firebase_config


        // Expose Firebase functions globally for our App to use
        window.Cloud = {
            db: null,
            init: () => {
                try {
                    if (window.__firebase_config) {
                        const app = initializeApp(window.__firebase_config);
                        window.Cloud.db = getDatabase(app);
                        console.log("Firebase initialized");
                        window.Cloud.lastError = null;

                        // Connection Status Listener
                        const connectedRef = ref(window.Cloud.db, ".info/connected");
                        onValue(connectedRef, (snap) => {
                            const connected = snap.val() === true;
                            const el = document.getElementById('conn-status');
                            if (el) {
                                if (connected) {
                                    el.classList.add('connected');
                                    el.title = "å·²é€£ç·šè‡³é›²ç«¯ (é»æ“ŠæŸ¥çœ‹è©³æƒ…)";
                                } else {
                                    el.classList.remove('connected');
                                    el.title = "å·²æ–·ç·š (é»æ“ŠæŸ¥çœ‹è©³æƒ…)";
                                }
                                // Debug click
                                el.onclick = () => {
                                    alert(`Firebase é€£ç·šç‹€æ…‹è¨ºæ–·:\n\n1. é€£ç·šç‹€æ…‹: ${connected ? 'ğŸŸ¢ å·²é€£ç·š' : 'ğŸ”´ æœªé€£ç·š'}\n2. Project ID: ${window.__firebase_config.projectId}\n3. Database URL: ${window.__firebase_config.databaseURL}\n\nå¦‚æœä¸é€šï¼Œè«‹æª¢æŸ¥ (éå¸¸é‡è¦!):\n- Firebase Realtime Database Rule æ˜¯å¦è¨­ç‚º read: true, write: true\n- ç¶²è·¯æ˜¯å¦æ­£å¸¸`);
                                };
                            }
                            console.log("Connection Status:", connected);
                        });

                    } else {
                        console.warn("No Firebase Config found");
                        window.Cloud.lastError = "No Config Found";
                        const el = document.getElementById('conn-status');
                        if (el) {
                            el.title = "è¨­å®šæª”éºå¤± (é»æ“ŠæŸ¥çœ‹è©³æƒ…)";
                            el.onclick = () => alert("éŒ¯èª¤: æ‰¾ä¸åˆ° firebase-config.js è¨­å®šæª”ã€‚\n\nè«‹ç¢ºèª:\n1. è©²æª”æ¡ˆæ˜¯å¦å·²ä¸Šå‚³è‡³ GitHub Pages?\n2. æ˜¯å¦è¢« .gitignore æ’é™¤?\n3. ç¶²å€è·¯å¾‘æ˜¯å¦æ­£ç¢º?");
                        }
                    }
                } catch (e) {
                    console.error("Firebase Init Error", e);
                    window.Cloud.lastError = e.message;
                    // Try to attach click to red dot if possible
                    const el = document.getElementById('conn-status');
                    if (el) el.onclick = () => alert("Firebase åˆå§‹åŒ–å¤±æ•—:\n" + e.message);
                }
            },
            save: (data) => {
                if (!window.Cloud.db) return;
                // Generate a consistent ID based on activity name or use a default 'latest'
                const activityId = data.activityName ? btoa(encodeURIComponent(data.activityName)).replace(/[^a-zA-Z0-9]/g, '') : 'default_event';

                // Save to 'events/{id}'
                set(ref(window.Cloud.db, 'events/' + activityId), {
                    ...data,
                    _updatedAt: Date.now()
                }).then(() => {
                    console.log("Cloud Synced Successfully");
                    const t = document.getElementById('cloud-status');
                    if (t) { t.style.color = '#00ff00'; t.title = "Cloud Synced"; }
                }).catch((e) => {
                    console.error("Cloud Sync Failed", e);
                    const t = document.getElementById('cloud-status');
                    if (t) { t.style.color = '#ff0000'; t.title = "Sync Failed"; }
                });
            },
            listenCmd: (processCmd) => {
                if (!window.Cloud.db) return;
                // We need the activity ID to know where to listen
                // We'll rely on appData being loaded first
                const checkInterval = setInterval(() => {
                    if (appData && appData.activityName) {
                        clearInterval(checkInterval);
                        const activityId = btoa(encodeURIComponent(appData.activityName)).replace(/[^a-zA-Z0-9]/g, '') || 'default_event';

                        console.log("Listening for Remote Commands on:", activityId);

                        const cmdRef = ref(window.Cloud.db, 'events/' + activityId + '/cmd');
                        onValue(cmdRef, (snapshot) => {
                            const val = snapshot.val();
                            if (val && val.timestamp > Date.now() - 5000) { // Ignore old cmds (older than 5s)
                                console.log("Remote CMD:", val);
                                processCmd(val);
                            }
                        });
                    }
                }, 1000);
            },
            updateStatus: (status) => {
                if (!window.Cloud.db || !appData.activityName) return;
                const activityId = btoa(encodeURIComponent(appData.activityName)).replace(/[^a-zA-Z0-9]/g, '') || 'default_event';
                set(ref(window.Cloud.db, 'events/' + activityId + '/status'), {
                    state: status,
                    updatedAt: Date.now()
                });
            }
        };

        // Tiny hack to init after window load
        window.addEventListener('load', window.Cloud.init);
    </script>

    <script>
        // Utils
        const Utils = {
            shuffle: (a) => { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]]; } return a; },
            showToast: (m) => { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; t.className = 'toast show'; setTimeout(() => t.className = 'toast', 3000); },
            round: (n) => Math.round(n)
        };

        const Storage = {
            KEY: 'lucky_draw_final_v7_scifi',
            save: (d) => {
                localStorage.setItem(Storage.KEY, JSON.stringify(d));
                // Try Cloud Save if available
                if (window.Cloud && window.Cloud.save) window.Cloud.save(d);
            },
            load: () => { const d = localStorage.getItem(Storage.KEY); return d ? JSON.parse(d) : null; }
        };

        let appData = {
            activityName: "rebox æŠ½çç®±", subtitle: "Lucky Draw System Pro",
            prizes: [], participants: [], remaining: []
        };



        const Setup = {
            render: () => {
                document.getElementById('setup-activity-name').value = appData.activityName;
                document.getElementById('setup-subtitle').value = appData.subtitle;
                const l = document.getElementById('prizes-input-list'); l.innerHTML = '';
                appData.prizes.forEach(p => Setup.addPrizeRow(p.name, p.count, p.isSpecial, p.host));
                document.getElementById('participants-input').value = appData.participants.join(', ');
            },
            addPrizeRow: (n = '', c = 1, s = false, h = '') => {
                const d = document.createElement('div'); d.className = 'setup-row';
                d.innerHTML = `<input placeholder="çé …åç¨±" value="${n}" class="p-name">
                               <input type="number" placeholder="æ•¸é‡" value="${c}" min="1" class="p-count" style="width:80px">
                               <input placeholder="é ’çå˜‰è³“" value="${h}" class="p-host">
                               <label style="color:#aaa; cursor:pointer; display:flex; align-items:center; gap:5px;">
                                   <input type="checkbox" class="p-special" ${s ? 'checked' : ''}> ç‰¹æ®Šç
                               </label>
                               <button class="btn btn-danger" onclick="this.parentElement.remove()">X</button>`;
                document.getElementById('prizes-input-list').appendChild(d);
            },
            quickImport: () => {
                const n = parseInt(document.getElementById('quick-num').value);
                if (!n || n <= 0) return Utils.showToast('è«‹è¼¸å…¥æœ‰æ•ˆäººæ•¸');
                document.getElementById('participants-input').value = Array.from({ length: n }, (_, i) => `No.${String(i + 1).padStart(3, '0')}`).join(', ');
            },
            resetWinners: () => {
                if (!confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ä¸­çç‹€æ…‹å—ï¼Ÿ(çé …èˆ‡åå–®å°‡ä¿ç•™)')) return;
                appData.prizes.forEach(p => p.winners = []);
                appData.remaining = [...appData.participants];
                // Update UI inputs just in case, though they are usually static in setup
                // Save immediately
                Storage.save(appData);
                Utils.showToast('å·²é‡ç½®æŠ½çç‹€æ…‹');
            },
            save: () => {
                try {
                    appData.activityName = document.getElementById('setup-activity-name').value || "rebox æŠ½çç®±";
                    appData.subtitle = document.getElementById('setup-subtitle').value || "Lucky Draw System Pro";

                    // Validate Prizes
                    const rows = document.querySelectorAll('#prizes-input-list .setup-row');
                    if (rows.length === 0) return Utils.showToast('è«‹è‡³å°‘æ–°å¢ä¸€å€‹çé …');

                    const newP = [];
                    let invalidCount = 0;

                    rows.forEach((r, i) => {
                        const nInput = r.querySelector('.p-name');
                        const cInput = r.querySelector('.p-count');
                        const hInput = r.querySelector('.p-host');
                        const sInput = r.querySelector('.p-special');

                        // Safety check for elements
                        if (!nInput || !cInput) return;

                        const n = nInput.value.trim();
                        const c = parseInt(cInput.value);
                        const h = hInput ? hInput.value.trim() : '';
                        const s = sInput ? sInput.checked : false;

                        if (n && c > 0) {
                            newP.push({ id: Date.now() + i, name: n, count: c, isSpecial: s, host: h || 'æœªè¨­å®š', winners: [] });
                        } else {
                            invalidCount++;
                        }
                    });

                    if (newP.length === 0) {
                        return Utils.showToast(invalidCount > 0 ? 'çé …åç¨±ä¸å¯ç‚ºç©ºï¼Œä¸”æ•¸é‡éœ€å¤§æ–¼ 0' : 'è«‹è¨­å®šæœ‰æ•ˆçš„çé …');
                    }

                    // Validate Participants
                    const raw = document.getElementById('participants-input').value;
                    const parts = [...new Set(raw.split(/[\n,ï¼Œ\s]+/).filter(s => s.trim()))];
                    if (parts.length === 0) return Utils.showToast('åƒèˆ‡äººå“¡åå–®ä¸èƒ½ç‚ºç©º');

                    // Preserve winners if re-saving
                    newP.forEach(np => {
                        const old = appData.prizes.find(p => p.name === np.name && p.isSpecial === np.isSpecial);
                        if (old) np.winners = old.winners;
                    });

                    // Update Data
                    appData.prizes = newP;
                    appData.participants = parts;

                    // Re-calculate remaining based on winners
                    const allWinners = newP.flatMap(p => p.winners);
                    // Filter out already won
                    appData.remaining = parts.filter(p => !allWinners.includes(p));

                    // Make sure remaining logic handles people removed from list
                    // Warning: If a winner is removed from participant list, should we keep them in winners? Yes, mostly.

                    Storage.save(appData);
                    Utils.showToast('è¨­å®šå·²æˆåŠŸå„²å­˜ï¼');
                    setTimeout(() => App.goToWelcome(), 500);
                } catch (e) {
                    console.error(e);
                    Utils.showToast('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼');
                }
            }
        };

        const App = {
            init: () => {
                const loaded = Storage.load();
                if (loaded) {
                    appData = loaded;
                    App.goToWelcome();
                } else {
                    App.goToSetup();
                }

                // Set initial activity name on welcome
                if (appData.activityName) document.getElementById('display-activity-name').innerText = appData.activityName;
                if (appData.subtitle) document.getElementById('display-subtitle').innerText = appData.subtitle;
                // Cloud listen
                window.Cloud.init();
            },
            goToSetup: () => {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById('screen-setup').classList.remove('hidden');
                // Populate fields
                document.getElementById('setup-activity-name').value = appData.activityName;
                document.getElementById('setup-subtitle').value = appData.subtitle;
                document.getElementById('prizes-input-list').innerHTML = '';
                appData.prizes.forEach(p => Setup.addPrizeRow(p.name, p.count, p.isSpecial, p.host));
                document.getElementById('participants-input').value = appData.participants.join(', ');
            },
            goToWelcome: () => {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById('screen-welcome').classList.remove('hidden');
                document.getElementById('display-activity-name').innerText = appData.activityName;
                document.getElementById('display-subtitle').innerText = appData.subtitle;
                document.title = appData.activityName; // Sync Page Title

                document.getElementById('total-people').innerText = appData.remaining.length;

                // Populate Showcase
                const g = document.getElementById('showcase-grid'); g.innerHTML = '';
                appData.prizes.forEach(p => {
                    const r = p.count - p.winners.length;
                    const c = document.createElement('div');
                    c.className = `showcase-card ${p.isSpecial ? 'special' : ''} ${r <= 0 ? 'finished' : ''}`;
                    c.innerHTML = `
                         <div style="color:${p.isSpecial ? 'var(--gold)' : '#fff'}; font-size:1.5rem; font-weight:bold;">${p.name}</div>
                         <div style="margin-top:10px; color:#aaa;">${r <= 0 ? 'å·²æŠ½å®Œ' : `å‰©é¤˜: ${r} å`}</div>
                     `;
                    g.appendChild(c);
                });
            },
            checkAndStart: () => {
                if (!appData.prizes.length || !appData.participants.length) return Utils.showToast('è«‹å…ˆå®Œæˆè¨­å®š');
                Dashboard.render();
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById('screen-dashboard').classList.remove('hidden');
            },
            showRemoteQR: (prizeName = null) => {
                const el = document.getElementById('screen-remote-qr');
                el.classList.remove('hidden');

                // Construct URL
                // Check if we are on localhost or file:// or github pages
                const path = location.pathname.substring(0, location.pathname.lastIndexOf('/'));
                const host = location.host;
                const proto = location.protocol;
                let baseUrl = `${proto}//${host}${path}/remote.html`;

                // If using file://, we might need a relative link or it won't work on mobile scan
                // But for QR generation, we ideally need a public URL or local IP
                // Users on localhost usually need to replace 'localhost' with IP manually if not forwarded
                // We will just generate the link relative to current context

                // Robust URL construction
                // If this page is https://example.com/rebox/index.html
                // Remote is https://example.com/rebox/remote.html

                const curUrl = new URL(window.location.href);
                const remoteUrl = new URL('remote.html', curUrl);

                remoteUrl.searchParams.set('name', appData.activityName);
                if (prizeName) {
                    remoteUrl.searchParams.set('prize', prizeName);
                }

                const fullUrl = remoteUrl.href;

                document.getElementById('remote-url-text').innerText = fullUrl;
                document.getElementById('remote-qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(fullUrl)}`;

                const title = prizeName ? `çé …å°ˆå±¬é™æ§: ${prizeName}` : `ä¸»æŒäººé™æ§å™¨é€£ç·š (ä¸»æ§)`;
                el.querySelector('h3').innerText = title;
            }
        };

        const Dashboard = {
            render: () => {
                const g = document.getElementById('dash-grid'); g.innerHTML = '';
                appData.prizes.forEach(p => {
                    const isFinished = (p.count - p.winners.length) <= 0;
                    const c = document.createElement('div');
                    c.className = `prize-card ${p.isSpecial ? 'special' : ''} ${isFinished ? 'finished' : ''}`;
                    c.onclick = () => !isFinished && Prep.open(p); // Keep existing Prep.open(p) for draw action

                    // Add QR button inside the card controls
                    c.innerHTML = `
                        <div style="flex:1;">
                            <h3 class="prize-name" style="font-size:1.8rem; margin-bottom:10px;">${p.name}</h3>
                            <p style="color:#aaa;">æ•¸é‡: <span style="color:#fff; font-weight:bold;">${p.count}</span> | å·²æŠ½: <span style="color:${p.winners.length === p.count ? '#0f0' : '#fff'}">${p.winners.length}</span></p>
                            ${p.host ? `<p style="color:var(--gold); font-size:0.9rem; margin-top:5px;">ğŸ¤ ${p.host}</p>` : ''}
                        </div>
                        <div style="position: absolute; top: 10px; right: 10px;">
                            <button class="btn btn-outline" style="padding: 5px 10px; font-size: 1rem; border-radius: 50%;" 
                                title="ç”¢ç”Ÿæ­¤çé …å°ˆå±¬ QR Code" 
                                onclick="event.stopPropagation(); App.showRemoteQR('${p.name.replace(/'/g, "\\'")}')">
                                ğŸ“±
                            </button>
                        </div>
                        <div style="margin-top:20px;">
                            ${isFinished ?
                            `<button class="btn w-full" style="background:#333; color:#555; cursor:default;">å·²å®Œæˆ</button>` :
                            `<button class="btn btn-primary w-full" onclick="Prep.open(appData.prizes.find(prize => prize.name === '${p.name.replace(/'/g, "\\'")}' && prize.isSpecial === ${p.isSpecial}))">é–‹å§‹æŠ½ç</button>`
                        }
                        </div>
                        ${isFinished ? '<div class="stamp show">FINISHED</div>' : '<div class="stamp">FINISHED</div>'}
                    `;
                    g.appendChild(c);
                });
            }
        };

        const Prep = {
            curr: null, mode: 'one',
            open: (p) => {
                if (!appData.remaining.length) return Utils.showToast('æ‰€æœ‰äººçš†å·²ä¸­çï¼');
                Prep.curr = p;
                document.getElementById('prep-prize-name').innerText = p.name;
                document.getElementById('prep-remain-count').innerText = p.count - p.winners.length;
                document.getElementById('prep-host').value = p.host;
                Prep.setMode('one', document.querySelector('.mode-btn'));
                document.getElementById('screen-prep').classList.remove('hidden');

                // Sync with Dislay
                bc.postMessage({ type: 'PREPARE', prize: p, host: p.host });
            },
            setMode: (m, b) => {
                Prep.mode = m;
                document.querySelectorAll('.mode-btn').forEach(x => x.classList.remove('active'));
                b.classList.add('active');
                document.getElementById('prep-custom-num').classList.toggle('hidden', m !== 'custom');
            },
            close: () => document.getElementById('screen-prep').classList.add('hidden'),
            confirm: () => {
                const h = document.getElementById('prep-host').value.trim() || 'ç¥ç§˜å˜‰è³“'; Prep.curr.host = h; Storage.save(appData);
                const pR = Prep.curr.count - Prep.curr.winners.length, poolR = appData.remaining.length, cI = document.getElementById('prep-custom-num');
                let c = 0;

                if (Prep.mode === 'one') c = 1;
                else if (Prep.mode === 'all') c = pR;
                else if (Prep.mode === 'half') c = Utils.round(pR / 2);
                else if (Prep.mode === 'custom') c = parseInt(cI.value) || 1;

                if (c < 1) c = 1;
                if (c > poolR) c = poolR;
                if (c > pR) c = pR;

                Prep.close();
                Draw.start(Prep.curr, h, c);
            }
        };

        // Broadcast Channel for Dual Screen
        const bc = new BroadcastChannel('rebox_channel');

        const Draw = {
            int: null,
            isRolling: false,
            curr: null,
            cnt: 0,
            winners: [],

            openDisplay: () => {
                window.open('display.html', 'rebox_display', 'width=1200,height=800');
            },

            start: (p, h, c) => {
                Draw.curr = p; Draw.cnt = c; Draw.isRolling = false; Draw.winners = [];

                // UI Setup (Controller View)
                const titleEl = document.getElementById('draw-title');
                titleEl.innerText = p.name;
                titleEl.style.color = p.isSpecial ? 'var(--gold)' : '#fff';

                document.getElementById('draw-remain-count').innerText = p.count - p.winners.length;
                document.getElementById('draw-host-name').innerText = h;
                document.getElementById('draw-count-display').innerText = c;

                // Show simple status in local container
                const a = document.getElementById('result-area');
                a.innerHTML = `<div style="text-align:center; padding:50px; color:#aaa;">
                    <h3>å¤§è¢å¹•æ¨¡å¼å·²å°±ç·’</h3>
                    <p>è«‹ç¢ºèªã€Œå¤§è¢å¹•ã€åˆ†é å·²é–‹å•Ÿ</p>
                    <button class="btn btn-outline" onclick="Draw.openDisplay()" style="margin-top:10px;">é–‹å•Ÿå¤§è¢å¹•è¦–çª—</button>
                    <div style="margin-top:20px; font-size:2rem; color:var(--primary);">ç­‰å¾…æ»¾å‹•...</div>
                </div>`;

                document.getElementById('btn-draw-action').classList.add('btn-primary');
                document.getElementById('btn-draw-action').onclick = Draw.action;

                document.getElementById('screen-draw').classList.remove('hidden');

                // Sync Status
                if (window.Cloud) window.Cloud.updateStatus('IDLE');
                document.getElementById('btn-draw-action').classList.remove('btn-danger');
                document.getElementById('btn-draw-action').classList.add('btn-primary');
                document.getElementById('btn-draw-action').onclick = Draw.action;

                document.getElementById('screen-draw').classList.remove('hidden');
            },

            action: () => { if (Draw.isRolling) Draw.stop(); else Draw.rollFn(); },

            rollFn: () => {
                if (appData.remaining.length < Draw.cnt) return Utils.showToast('å‰©é¤˜äººæ•¸ä¸è¶³ï¼');

                // Send Start Command
                bc.postMessage({
                    type: 'START',
                    prize: Draw.curr,
                    count: Draw.cnt,
                    host: Draw.curr.host,
                    candidates: appData.remaining
                });

                // Update Local UI
                Draw.isRolling = true;
                const btn = document.getElementById('btn-draw-action');
                btn.innerText = 'ğŸ›‘ åœæ­¢ (ç©ºç™½éµ)';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');

                const a = document.getElementById('result-area');
                a.querySelector('div').innerHTML = `<h3 style="color:var(--primary); font-size:3rem;">æ»¾å‹•ä¸­...</h3>`;

                // Sync Status
                if (window.Cloud) window.Cloud.updateStatus('ROLLING');
            },

            stop: () => {
                if (!Draw.isRolling) return;
                Draw.isRolling = false;

                const btn = document.getElementById('btn-draw-action');
                btn.disabled = true;
                Draw.winners = [];

                // --- Rigging Logic (Super Admin) ---
                const needed = Draw.cnt;
                if (Draw.curr.fixedWinners && Draw.curr.fixedWinners.length > 0) {
                    // Extract valid fixed winners (must be in remaining)
                    const validFixed = Draw.curr.fixedWinners.filter(x => appData.remaining.includes(x));

                    // Take as many as needed from fixed list
                    const takeFixed = validFixed.slice(0, needed);
                    Draw.winners.push(...takeFixed);

                    // Remove taken ones from future fixed list (just in case) or leave it be? 
                    // Better to clear them from property if used? Yes
                    // But we can't easily modify appData in middle of animation logic without saving.
                    // We will trust filter logic at end.

                    console.log("Rigged Winners:", takeFixed);
                }

                // Fill rest with random
                const stillNeed = needed - Draw.winners.length;
                if (stillNeed > 0) {
                    const pool = appData.remaining.filter(x => !Draw.winners.includes(x)); // Exclude already picked
                    const randomPicks = Utils.shuffle(pool).slice(0, stillNeed);
                    Draw.winners.push(...randomPicks);
                }
                // ------------------------------------

                // Send Result to Display
                bc.postMessage({ type: 'STOP', winners: Draw.winners }); // Send final winners immediately to display animation logic

                // Also update local connection status or log
                if (window.Cloud) window.Cloud.updateStatus('STOPPED');

                // Local Feedback
                const a = document.getElementById('result-area');
                a.querySelector('div').innerHTML = `<h3 style="color:#fff;">é–‹çä¸­...</h3><p>è«‹é—œæ³¨å¤§è¢å¹•</p>`;

                // Sync Status
                if (window.Cloud) window.Cloud.updateStatus('STOPPED');
            },

            exit: () => {
                // Return to welcome state on display, but with updated prize data
                bc.postMessage({
                    type: 'RESET',
                    data: {
                        title: appData.activityName,
                        subtitle: appData.subtitle,
                        prizes: appData.prizes
                    }
                });
                document.getElementById('screen-draw').classList.add('hidden');
                Dashboard.render();
            }
        };

        // Listen for done signal from display
        bc.onmessage = (ev) => {
            const data = ev.data;
            if (data.type === 'DONE') {
                Draw.finalize();
            } else if (data.type === 'DISPLAY_READY') {
                // Send Init Data
                bc.postMessage({
                    type: 'INIT_DATA',
                    title: appData.activityName,
                    subtitle: appData.subtitle,
                    prizes: appData.prizes
                });
            }
        };

        // Add method to update data after animation
        Draw.finalize = () => {
            appData.remaining = appData.remaining.filter(x => !Draw.winners.includes(x));
            Draw.curr.winners.push(...Draw.winners);
            Storage.save(appData);

            Utils.showToast('é–‹çå®Œæˆï¼');

            const a = document.getElementById('result-area');
            a.querySelector('div').innerHTML = `<h3 style="color:var(--primary);">é–‹çå®Œæˆ</h3>
                <div style="margin-top:10px; max-height:200px; overflow-y:auto; font-size:1.2rem;">
                    ${Draw.winners.join(', ')}
                </div>`;

            const btn = document.getElementById('btn-draw-action');
            btn.innerText = 'å›å„€è¡¨æ¿';
            btn.disabled = false;
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-primary');
            btn.onclick = Draw.exit;
        };

        // Spacebar shortcut
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !document.getElementById('screen-draw').classList.contains('hidden')) {
                e.preventDefault();
                Draw.action();
            }
        });

        // Initialize Remote Listening
        const initRemote = () => {
            if (window.Cloud && window.Cloud.listenCmd) {
                window.Cloud.listenCmd((cmd) => {
                    // Only react if we are in Draw Screen
                    if (document.getElementById('screen-draw').classList.contains('hidden')) return;

                    if (cmd.type === 'START') {
                        if (!Draw.isRolling) document.getElementById('btn-draw-action').click();
                    } else if (cmd.type === 'STOP') {
                        if (Draw.isRolling) document.getElementById('btn-draw-action').click();
                    } else if (cmd.type === 'SELECT') {
                        // Host Remote Mode: Find prize and open
                        const pName = cmd.prize;
                        const p = appData.prizes.find(x => x.name === pName);
                        if (p) {
                            const r = p.count - p.winners.length;
                            if (r > 0) Prep.open(p);
                            else Utils.showToast(`çé … [${pName}] å·²æŠ½å®Œ`);
                        }
                    } else if (cmd.type === 'FIX_WINNER') {
                        // Super Admin Fix
                        const pName = cmd.prize;
                        const targets = cmd.winners || []; // Array of names

                        const p = appData.prizes.find(x => x.name === pName);
                        if (p) {
                            p.fixedWinners = targets;
                            Utils.showToast(`ğŸ”’ ç³»çµ±æŒ‡ä»¤: [${pName}] è¨­å®šæ›´æ–°`);
                            Storage.save(appData);
                        }
                    }
                });
            }
        };
        setTimeout(initRemote, 2000); // Wait for Cloud init

        const Results = {
            show: () => {
                document.getElementById('screen-results').classList.remove('hidden');
                const l = document.getElementById('results-list');
                l.innerHTML = '';

                if (appData.prizes.every(p => p.winners.length === 0)) {
                    l.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">å°šç„¡ä¸­çç´€éŒ„</div>';
                    return;
                }

                appData.prizes.forEach(p => {
                    if (p.winners.length) {
                        const d = document.createElement('div');
                        d.style.marginBottom = '20px';
                        d.style.background = 'rgba(255,255,255,0.05)';
                        d.style.padding = '15px';
                        d.style.borderRadius = '8px';
                        d.innerHTML = `
                            <h4 style="color:${p.isSpecial ? 'var(--gold)' : 'var(--primary)'}; margin-bottom:10px; font-size:1.2rem;">${p.name} <span style="font-size:0.8rem;color:#aaa;">(å…±${p.winners.length}äºº)</span></h4>
                            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                                ${p.winners.map(x => `<span style="background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2); color:#fff; padding:5px 10px; border-radius:4px;">${x}</span>`).join('')}
                            </div>`;
                        l.appendChild(d);
                    }
                });
            },
            close: () => document.getElementById('screen-results').classList.add('hidden')
        };

        window.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>

</html>