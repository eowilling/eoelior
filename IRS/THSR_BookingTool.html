<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜éµæ¶ç¥¨å°å¹«æ‰‹è¨­å®š</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95rem;
        }
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn-generate {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        .btn-generate:active {
            transform: translateY(0);
        }
        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .info-box p {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .generated-code {
            background: #2d3748;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        .copy-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .copy-btn:hover {
            background: #38a169;
        }
        .highlight { color: #ffd700; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš„ é«˜éµæ¶ç¥¨å°å¹«æ‰‹</h1>
        <p class="subtitle">è¨­å®šæ‚¨çš„æ¶ç¥¨éœ€æ±‚ï¼Œè‡ªå‹•ç”¢ç”Ÿè…³æœ¬</p>

        <div class="form-group">
            <label for="startStation">ğŸš‰ å‡ºç™¼ç«™</label>
            <select id="startStation">
                <option value="å—æ¸¯">å—æ¸¯</option>
                <option value="å°åŒ—">å°åŒ—</option>
                <option value="æ¿æ©‹">æ¿æ©‹</option>
                <option value="æ¡ƒåœ’">æ¡ƒåœ’</option>
                <option value="æ–°ç«¹">æ–°ç«¹</option>
                <option value="è‹—æ —" selected>è‹—æ —</option>
                <option value="å°ä¸­">å°ä¸­</option>
                <option value="å½°åŒ–">å½°åŒ–</option>
                <option value="é›²æ—">é›²æ—</option>
                <option value="å˜‰ç¾©">å˜‰ç¾©</option>
                <option value="å°å—">å°å—</option>
                <option value="å·¦ç‡Ÿ">å·¦ç‡Ÿ</option>
            </select>
        </div>

        <div class="form-group">
            <label for="endStation">ğŸ¯ æŠµé”ç«™</label>
            <select id="endStation">
                <option value="å—æ¸¯">å—æ¸¯</option>
                <option value="å°åŒ—" selected>å°åŒ—</option>
                <option value="æ¿æ©‹">æ¿æ©‹</option>
                <option value="æ¡ƒåœ’">æ¡ƒåœ’</option>
                <option value="æ–°ç«¹">æ–°ç«¹</option>
                <option value="è‹—æ —">è‹—æ —</option>
                <option value="å°ä¸­">å°ä¸­</option>
                <option value="å½°åŒ–">å½°åŒ–</option>
                <option value="é›²æ—">é›²æ—</option>
                <option value="å˜‰ç¾©">å˜‰ç¾©</option>
                <option value="å°å—">å°å—</option>
                <option value="å·¦ç‡Ÿ">å·¦ç‡Ÿ</option>
            </select>
        </div>

        <div class="row">
            <div class="form-group">
                <label for="departDate">ğŸ“… ä¹˜è»Šæ—¥æœŸ</label>
                <input type="date" id="departDate" value="2025-12-20">
            </div>
            <div class="form-group">
                <label for="departTime">â° å‡ºç™¼æ™‚é–“</label>
                <input type="time" id="departTime" value="08:00">
            </div>
        </div>

        <div class="row">
            <div class="form-group">
                <label for="trainNo">ğŸš„ è»Šæ¬¡è™Ÿç¢¼ï¼ˆé¸å¡«ï¼‰</label>
                <input type="text" id="trainNo" placeholder="ä¾‹å¦‚ï¼š1522" value="1522">
            </div>
            <div class="form-group">
                <label for="ticketQty">ğŸ« ç¥¨æ•¸</label>
                <select id="ticketQty">
                    <option value="1">1 å¼µ</option>
                    <option value="2" selected>2 å¼µ</option>
                    <option value="3">3 å¼µ</option>
                    <option value="4">4 å¼µ</option>
                    <option value="5">5 å¼µ</option>
                    <option value="6">6 å¼µ</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="refreshInterval">ğŸ”„ åˆ·æ–°é–“éš”ï¼ˆç§’ï¼‰</label>
            <select id="refreshInterval">
                <option value="1">1 ç§’ï¼ˆæ¥µé€Ÿï¼‰</option>
                <option value="3" selected>3 ç§’ï¼ˆå¿«é€Ÿï¼‰</option>
                <option value="5">5 ç§’ï¼ˆæ¨™æº–ï¼‰</option>
                <option value="10">10 ç§’ï¼ˆç©©å®šï¼‰</option>
                <option value="30">30 ç§’ï¼ˆä¿å®ˆï¼‰</option>
                <option value="60">60 ç§’ï¼ˆç·©æ…¢ï¼‰</option>
            </select>
        </div>

        <button class="btn-generate" onclick="generateScript()">ğŸš€ ç”¢ç”Ÿä¸¦ä¸‹è¼‰æ¶ç¥¨ç¨‹å¼</button>

        <div class="info-box">
            <h3>ğŸ“Œ ä½¿ç”¨èªªæ˜</h3>
            <p>
                1. è¨­å®šå¥½æ¶ç¥¨æ¢ä»¶å¾Œï¼Œé»æ“Šã€Œç”¢ç”Ÿä¸¦ä¸‹è¼‰æ¶ç¥¨ç¨‹å¼ã€<br>
                2. ç³»çµ±æœƒè‡ªå‹•ä¸‹è¼‰å…©å€‹æª”æ¡ˆï¼š<br>
                   &nbsp;&nbsp;&nbsp;â€¢ <code>thsr_booking_assistant.py</code>ï¼ˆä¸»ç¨‹å¼ï¼‰<br>
                   &nbsp;&nbsp;&nbsp;â€¢ <code>å•Ÿå‹•é«˜éµæ¶ç¥¨.ps1</code>ï¼ˆå•Ÿå‹•è…³æœ¬ï¼‰<br>
                3. å°‡å…©å€‹æª”æ¡ˆæ”¾åœ¨åŒä¸€å€‹è³‡æ–™å¤¾<br>
                4. é›™æ“Šã€Œå•Ÿå‹•é«˜éµæ¶ç¥¨.ps1ã€å³å¯é–‹å§‹æ¶ç¥¨ï¼
            </p>
        </div>

        <div class="generated-code" id="generatedCode"></div>
    </div>

    <script>
        function generateScript() {
            const startStation = document.getElementById('startStation').value;
            const endStation = document.getElementById('endStation').value;
            const departDateInput = document.getElementById('departDate').value;
            const departTimeInput = document.getElementById('departTime').value;
            const trainNo = document.getElementById('trainNo').value.trim();
            const ticketQty = document.getElementById('ticketQty').value;
            const refreshInterval = document.getElementById('refreshInterval').value;

            // è½‰æ›æ—¥æœŸæ ¼å¼ YYYY-MM-DD -> YYYY/MM/DD
            const departDate = departDateInput.replace(/-/g, '/');

            // ç”¢ç”Ÿ Python ç¨‹å¼ç¢¼
            const pythonCode = `import time
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import Select
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from webdriver_manager.chrome import ChromeDriverManager
import logging

# è¨­å®š logging ç´šåˆ¥ï¼Œä»¥ä¾¿åœ¨æ§åˆ¶å°çœ‹åˆ° WebDriver çš„ä¸‹è¼‰å’Œé€£ç·šè³‡è¨Š
logging.basicConfig(level=logging.INFO)

# ==========================================
# è¨­å®šå€ (Configuration)
# ==========================================

# é è¨­åƒæ•¸
START_STATION = "${startStation}"      # å‡ºç™¼ç«™
END_STATION = "${endStation}"        # æŠµé”ç«™
DEPART_DATE = "${departDate}" # æ ¼å¼ï¼šYYYY/MM/DD
DEPART_TIME = "${departTimeInput}"      # æ ¼å¼ï¼šHH:mm
TICKET_QTY = "${ticketQty}"           # è¨‚ç¥¨å¼µæ•¸

# ã€é‡è¦è¨­å®šã€‘æŒ‡å®šè»Šæ¬¡è™Ÿç¢¼
TRAIN_NO = "${trainNo || ''}"          # ç›£æ§è»Šæ¬¡${trainNo ? 'ï¼š' + trainNo : 'ï¼ˆæœªæŒ‡å®šï¼‰'}

# ã€é‡è¦è¨­å®šã€‘è‡ªå‹•é‡æ–°æŸ¥è©¢é–“éš”æ™‚é–“ (ç§’)
REFRESH_INTERVAL_SECONDS = ${refreshInterval}  # ${getIntervalDesc(refreshInterval)}

${getPythonMainCode()}`;

            // ç”¢ç”Ÿ PowerShell è…³æœ¬
            const ps1Code = `# é«˜éµæ¶ç¥¨ç¨‹å¼å•Ÿå‹•è…³æœ¬
# é›™æ“ŠåŸ·è¡Œæ­¤æª”æ¡ˆå³å¯å•Ÿå‹•ç›£æ§ç¨‹å¼

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "     é«˜éµæ¶ç¥¨å°å¹«æ‰‹å•Ÿå‹•ä¸­..." -ForegroundColor Yellow
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "ğŸš‰ å‡ºç™¼ç«™ï¼š${startStation}" -ForegroundColor Green
Write-Host "ğŸ¯ æŠµé”ç«™ï¼š${endStation}" -ForegroundColor Green
Write-Host "ğŸ“… æ—¥æœŸï¼š${departDate} ${departTimeInput}" -ForegroundColor Green
Write-Host "ğŸ« ç¥¨æ•¸ï¼š${ticketQty} å¼µ" -ForegroundColor Green
${trainNo ? `Write-Host "ğŸš„ è»Šæ¬¡ï¼š${trainNo}" -ForegroundColor Yellow` : 'Write-Host "ğŸš„ è»Šæ¬¡ï¼šç›£æ§æ‰€æœ‰è»Šæ¬¡" -ForegroundColor Yellow'}
Write-Host "âš¡ åˆ·æ–°é–“éš”ï¼š${refreshInterval} ç§’" -ForegroundColor Green
Write-Host ""

# åŸ·è¡Œ Python è…³æœ¬
python thsr_booking_assistant.py

# åŸ·è¡Œå®Œç•¢å¾Œæš«åœï¼Œè®“è¦–çª—ä¿æŒé–‹å•Ÿ
Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "æŒ‰ä»»æ„éµé—œé–‰è¦–çª—..." -ForegroundColor Yellow
$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
`;

            // ä¸‹è¼‰ Python æª”æ¡ˆ
            downloadFile('thsr_booking_assistant.py', pythonCode);

            // å»¶é²ä¸€ä¸‹å†ä¸‹è¼‰ç¬¬äºŒå€‹æª”æ¡ˆ
            setTimeout(() => {
                downloadFile('å•Ÿå‹•é«˜éµæ¶ç¥¨.ps1', ps1Code);

                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                const codeContainer = document.getElementById('generatedCode');
                codeContainer.innerHTML = `<div style="color:#48bb78;text-align:center;font-size:1.2rem;">
                    âœ… ä¸‹è¼‰å®Œæˆï¼<br><br>
                    <span style="font-size:0.9rem;color:#fff;">
                    å·²ä¸‹è¼‰ä»¥ä¸‹æª”æ¡ˆï¼š<br>
                    1ï¸âƒ£ thsr_booking_assistant.py<br>
                    2ï¸âƒ£ å•Ÿå‹•é«˜éµæ¶ç¥¨.ps1<br><br>
                    è«‹å°‡å…©å€‹æª”æ¡ˆæ”¾åœ¨åŒä¸€è³‡æ–™å¤¾ï¼Œç„¶å¾Œé›™æ“Šã€Œå•Ÿå‹•é«˜éµæ¶ç¥¨.ps1ã€å³å¯é–‹å§‹æ¶ç¥¨ï¼
                    </span>
                </div>`;
                codeContainer.style.display = 'block';
            }, 500);
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function getPythonMainCode() {
            // è¿”å›å®Œæ•´çš„ Python ä¸»ç¨‹å¼ç¢¼ï¼ˆå¾åŸæœ¬çš„æª”æ¡ˆè¤‡è£½ï¼‰
            return \`
def find_and_select_train(driver, train_no):
    """å˜—è©¦å°‹æ‰¾ä¸¦é¸å–æŒ‡å®šçš„è»Šæ¬¡ï¼Œä¸¦é»æ“Šç¢ºèªã€‚"""

    try:
        # 1. ç°¡åŒ–ç­‰å¾… - ç›´æ¥ç­‰å¾…ä»»ä½• radio button å‡ºç¾ï¼ˆä»£è¡¨æŸ¥è©¢çµæœå·²è¼‰å…¥ï¼‰
        WebDriverWait(driver, 20).until(
            EC.presence_of_element_located((By.XPATH, "//input[@type='radio']"))
        )
        # é¡å¤–ç­‰å¾…ç¢ºä¿æ‰€æœ‰è»Šæ¬¡éƒ½è¼‰å…¥å®Œæˆ
        time.sleep(2)
        print("âœ… æŸ¥è©¢çµæœå·²è¼‰å…¥")
    except Exception as e:
        print(f"âš ï¸ ç„¡æ³•æ‰¾åˆ°è»Šæ¬¡åˆ—è¡¨ï¼ˆå¯èƒ½é é¢å°šæœªå®Œå…¨è¼‰å…¥ï¼‰")
        print(f"   ç•¶å‰ URL: {driver.current_url}")
        return False

    # 2. å°‹æ‰¾åŒ…å«æŒ‡å®šè»Šæ¬¡è™Ÿç¢¼çš„å…ƒç´ 
    xpath_patterns = [
        f"//td[text()='{train_no}']",
        f"//td[normalize-space(text())='{train_no}']",
        f"//*[text()='{train_no}']"
    ]

    train_cell = None
    for xpath in xpath_patterns:
        try:
            train_cell = driver.find_element(By.XPATH, xpath)
            if train_cell:
                print(f"âœ… æ‰¾åˆ°è»Šæ¬¡ {train_no}")
                break
        except:
            continue

    if not train_cell:
        print(f"âŒ æœªæ‰¾åˆ°è»Šæ¬¡ {train_no}")
        # åˆ—å‡ºé é¢ä¸Šçš„è»Šæ¬¡è™Ÿç¢¼å¹«åŠ©é™¤éŒ¯
        try:
            # æ–¹æ³•1: æ‰¾å‡ºæ‰€æœ‰ td å…ƒç´ 
            all_cells = driver.find_elements(By.XPATH, "//td")
            train_numbers = []
            all_texts = []

            for cell in all_cells:
                text = cell.text.strip()
                if text:  # è¨˜éŒ„æ‰€æœ‰éç©ºæ–‡å­—
                    all_texts.append(text)
                # è»Šæ¬¡è™Ÿç¢¼é€šå¸¸æ˜¯ 3-4 ä½æ•¸å­—
                if text.isdigit() and 3 <= len(text) <= 4:
                    if text not in train_numbers:
                        train_numbers.append(text)

            if train_numbers:
                print(f"   ğŸ“‹ é é¢ä¸Šçš„è»Šæ¬¡: {', '.join(train_numbers)}")
            else:
                print(f"   âš ï¸ ç¬¬ä¸€ç¨®æ–¹æ³•ç„¡æ³•è­˜åˆ¥è»Šæ¬¡è™Ÿç¢¼")

            # é¡¯ç¤ºå‰20å€‹æ–‡å­—å…§å®¹å¹«åŠ©é™¤éŒ¯ï¼ˆåŠ å¼·ï¼‰
            if all_texts:
                print(f"   ğŸ” é é¢æ‰€æœ‰æ–‡å­—å‰20é …: {all_texts[:20]}")

            # æ–¹æ³•2: å˜—è©¦ç”¨ä¸åŒæ–¹å¼å°‹æ‰¾ - æ‰¾æ‰€æœ‰åŒ…å«æ•¸å­—çš„å…ƒç´ 
            all_elements = driver.find_elements(By.XPATH, "//*")
            numbers_found = []
            for elem in all_elements[:200]:  # å¢åŠ æœå°‹ç¯„åœ
                try:
                    text = elem.text.strip()
                    if text and text.isdigit() and 3 <= len(text) <= 4:
                        if text not in numbers_found:
                            numbers_found.append(text)
                except:
                    continue

            if numbers_found:
                print(f"   ğŸ“‹ ç”¨å‚™ç”¨æ–¹æ³•æ‰¾åˆ°çš„è»Šæ¬¡: {', '.join(numbers_found[:15])}")
            else:
                print(f"   âš ï¸ å‚™ç”¨æ–¹æ³•ä¹Ÿç„¡æ³•æ‰¾åˆ°è»Šæ¬¡")

        except Exception as debug_e:
            print(f"   âš ï¸ é™¤éŒ¯æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(debug_e)[:80]}")
        return False

    try:
        # 3. æ‰¾åˆ°è©²è¡Œä¸­çš„ radio buttonï¼ˆæ”¹ç”¨æ›´ç©©å®šçš„æ–¹å¼ï¼‰
        train_row = train_cell.find_element(By.XPATH, "./ancestor::tr[1]")

        # å˜—è©¦å¤šç¨®æ–¹å¼æ‰¾ radio button
        radio_button = None
        try:
            radio_button = train_row.find_element(By.XPATH, ".//input[@type='radio']")
        except:
            try:
                radio_button = train_row.find_element(By.CSS_SELECTOR, "input[type='radio']")
            except:
                radio_button = train_row.find_element(By.TAG_NAME, "input")

        if not radio_button:
            print(f"âŒ ç„¡æ³•æ‰¾åˆ°è»Šæ¬¡ {train_no} çš„é¸å–æŒ‰éˆ•")
            return False

        # 4. æª¢æŸ¥æ˜¯å¦å¯é»é¸ (æ˜¯å¦æœ‰ç¥¨)
        if radio_button.is_enabled():
            # ä½¿ç”¨ JavaScript é»æ“Šï¼Œæ›´ç©©å®š
            driver.execute_script("arguments[0].click();", radio_button)
            time.sleep(1)

            # 5. è‡ªå‹•é»æ“Šã€Œç¢ºèªã€/ä¸‹ä¸€æ­¥æŒ‰éˆ•
            confirm_button = WebDriverWait(driver, 5).until(
                EC.element_to_be_clickable((By.ID, "confirm"))
            )
            confirm_button.click()
            print(f"\\nğŸ‰ğŸ‰ğŸ‰ æˆåŠŸæ¶åˆ°è»Šæ¬¡ {train_no} çš„ç¥¨ï¼ğŸ‰ğŸ‰ğŸ‰")
            print(f"âœ… å·²è‡ªå‹•é»æ“Šã€Œç¢ºèªã€ï¼Œæ­£åœ¨è·³è½‰åˆ°è³¼è²·é é¢...")
            return True
        else:
            print(f"âš ï¸ æ‰¾åˆ°è»Šæ¬¡ {train_no}ï¼Œä½†ç›®å‰ç„¡ç¥¨ï¼ˆé¸å–éˆ•ä¸å¯é»æ“Šï¼‰")
            return False

    except Exception as e:
        print(f"âŒ è™•ç†è»Šæ¬¡ {train_no} æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)[:80]}")
        # é¡å¤–é™¤éŒ¯è³‡è¨Š
        try:
            print(f"   é™¤éŒ¯ï¼štrain_cell æ–‡å­—å…§å®¹ = {train_cell.text}")
        except:
            pass
        return False

def run_booking_bot():
    print(f"ğŸš€ å•Ÿå‹•é«˜éµè¨‚ç¥¨å°å¹«æ‰‹ (è‡ªå‹•è¼ªè©¢æ¨¡å¼)...")
    print(f"ğŸ“ è¡Œç¨‹ï¼š{START_STATION} -> {END_STATION}")
    print(f"ğŸ“… æ—¥æœŸï¼š{DEPART_DATE} {DEPART_TIME}")
    print(f"ğŸš„ é–å®šè»Šæ¬¡ï¼š{TRAIN_NO} | ğŸ”„ è¼ªè©¢é–“éš”: {REFRESH_INTERVAL_SECONDS} ç§’")

    # 1. è¨­å®š Chrome Driver
    options = webdriver.ChromeOptions()
    # è®“è¦–çª—ä¸æœƒåœ¨ç¨‹å¼çµæŸæ™‚è¢«é—œé–‰ï¼ˆä¾¿æ–¼äººå·¥ä»‹å…¥ï¼‰
    options.add_experimental_option("detach", True)
    # é¿å…æŸäº›ç’°å¢ƒä¸­ data: ç©ºç™½é å•é¡Œçš„å¯ç–‘æ——æ¨™ï¼Œæ”¹æ¡è¼ƒç©©å®šåšæ³•
    # éš±è—è‡ªå‹•åŒ–ç—•è·¡ï¼Œä½†ä¸ä½¿ç”¨ useAutomationExtensionï¼ˆéƒ¨åˆ†ç‰ˆæœ¬æœƒé€ æˆå•Ÿå‹•é é¢ç‚º data:ï¼‰
    options.add_argument("--disable-blink-features=AutomationControlled")
    # ä¸€äº›ç©©å®šæ€§æ——æ¨™ï¼ˆWindows å¸¸è¦‹ï¼‰
    # options.add_argument("--start-maximized")  # æ”¹ç‚ºæœ€å°åŒ–å•Ÿå‹•
    options.add_argument("--start-minimized")  # å•Ÿå‹•æ™‚æœ€å°åŒ–åˆ°å·¥ä½œåˆ—
    options.add_argument("--no-default-browser-check")
    options.add_argument("--no-first-run")
    options.add_argument("--disable-background-networking")
    options.add_argument("--disable-sync")
    options.add_argument("--disable-features=TranslateUI")
    # ç¢ºä¿é é¢è¼‰å…¥ç­–ç•¥ç‚ºæ­£å¸¸
    options.page_load_strategy = 'normal'

    try:
        driver_path = ChromeDriverManager().install()
        service = Service(driver_path)
        # æ¥å—æ½›åœ¨çš„æ†‘è­‰ç•°å¸¸ï¼ˆè‹¥æœ¬æ©Ÿæ™‚é–“æˆ–ä¸­é–“äººæ†‘è­‰é€ æˆ HTTPS é€£ç·šç•°å¸¸ï¼Œå¯é¿å…è¢«æ””æˆªæˆç©ºç™½é ï¼‰
        driver = webdriver.Chrome(service=service, options=options)

        # å•Ÿå‹•å¾Œå…ˆåšä¸€æ¬¡å¥åº·æª¢æŸ¥ï¼Œç¢ºèªç€è¦½å™¨å¯æ­£å¸¸è¼‰å…¥å¤–éƒ¨ç¶²ç«™
        try:
            driver.get("https://example.com")
            WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.TAG_NAME, "h1"))
            )
            print("âœ… å¥åº·æª¢æŸ¥é€šéï¼šå¯æ­£å¸¸è¼‰å…¥å¤–éƒ¨ç¶²ç«™ã€‚")
        except Exception as health_e:
            print("âŒ å¥åº·æª¢æŸ¥å¤±æ•—ï¼šç€è¦½å™¨ç„¡æ³•è¼‰å…¥å¤–éƒ¨ç¶²ç«™ã€‚å¯èƒ½æ˜¯ä»¥ä¸‹åŸå› ï¼š")
            print("   - Chrome/ChromeDriver ç‰ˆæœ¬ä¸ç›¸å®¹ï¼Œæˆ–è¢«å®‰å…¨æ€§è»Ÿé«”æ””æˆª")
            print("   - ç³»çµ±æ™‚é–“ä¸æ­£ç¢ºå°è‡´ HTTPS æ†‘è­‰åˆ¤å®šä¸å®‰å…¨")
            print("   - ä¼æ¥­ä»£ç†/é˜²æ¯’ MITM å°è‡´æ†‘è­‰éŒ¯èª¤")
            print(f"   é™¤éŒ¯è¨Šæ¯ï¼š{health_e}")
            print("   å»ºè­°ï¼šæ›´æ–° Chrome è‡³æœ€æ–°ç‰ˆæœ¬ã€é‡æ–°å®‰è£å°æ‡‰ç‰ˆ ChromeDriverï¼Œæˆ–æš«æ™‚åœç”¨æ””æˆª")
            # ä¸ä¸­æ­¢æµç¨‹ï¼Œå˜—è©¦ç¹¼çºŒå°å‘é«˜éµç¶²ç«™

        # === é—œéµä¿®æ­£ï¼šç¢ºä¿ç¶²é å·²æˆåŠŸè¼‰å…¥ä¸” URL æ­£ç¢º (å¢åŠ é‡è©¦æ©Ÿåˆ¶) ===
        target_url = "https://irs.thsrc.com.tw/IMINT/"
        max_attempts = 3

        for attempt in range(max_attempts):
            try:
                # å¦‚æœç•¶å‰ä¸åœ¨ç›®æ¨™é é¢ï¼Œå‰‡å°èˆªï¼ˆå…ˆæ¸…ç©ºå†å°é ï¼Œé¿å…å‰ä¸€é æ®˜ç•™ï¼‰
                if driver.current_url != target_url:
                    try:
                        driver.delete_all_cookies()
                    except Exception:
                        pass
                    driver.get(target_url)
                    print(f"å˜—è©¦å°èˆªåˆ°é«˜éµé é¢ (ç¬¬ {attempt + 1} æ¬¡)...")

                # ç­‰å¾…ç›´åˆ° URL æ­£ç¢ºä¸”é é¢ä¸Šç¬¬ä¸€å€‹é—œéµå…ƒç´ ï¼ˆå‡ºç™¼ç«™ä¸‹æ‹‰é¸å–®ï¼‰å‡ºç¾
                # æœ‰äº›ç‰ˆæœ¬åœ¨è¼‰å…¥éç¨‹ä¸­å¯èƒ½çŸ­æš«é¡¯ç¤º data:ï¼Œæ”¹ç”¨ç­‰å¾…é—œéµå…ƒç´ è€Œéåƒ…æ ¡æ­£ URL
                WebDriverWait(driver, 15).until(
                    EC.any_of(
                        EC.url_to_be(target_url),
                        EC.presence_of_element_located((By.NAME, "selectStartStation"))
                    )
                )
                WebDriverWait(driver, 10).until(
                    EC.presence_of_element_located((By.NAME, "selectStartStation"))
                )
                print("âœ… ç¶²é æˆåŠŸè¼‰å…¥é«˜éµè¨‚ç¥¨é é¢ã€‚")
                break  # æˆåŠŸï¼Œè·³å‡ºè¿´åœˆ
            except Exception as e:
                current_url = driver.current_url
                print(f"âŒ ç¬¬ {attempt + 1} æ¬¡å˜—è©¦å¤±æ•—ã€‚ç›®å‰çš„ URL æ˜¯: {current_url}ã€‚")

                if attempt < max_attempts - 1:
                    print("ğŸ”„ é‡æ–°å˜—è©¦å°èˆª...")
                    time.sleep(5) # ç­‰å¾…5ç§’å¾Œå†è©¦
                else:
                    print("âŒ éŒ¯èª¤ï¼šå·²é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ï¼Œç¶²é è¼‰å…¥è¶…æ™‚æˆ–å°èˆªå¤±æ•—ã€‚é€™é€šå¸¸æ˜¯ Chrome é©…å‹•ç¨‹å¼ç‰ˆæœ¬å•é¡Œã€‚")
                    driver.quit()
                    return
        # =================================================

        # è™•ç†ã€Œå€‹äººè³‡æ–™ä½¿ç”¨èªªæ˜ã€å½ˆçª—
        try:
            # ç­‰å¾…ã€Œæˆ‘åŒæ„ã€æŒ‰éˆ•å‡ºç¾ä¸¦å¯ä»¥é»æ“Š (ä½¿ç”¨ XPath ç¢ºä¿æ‰¾åˆ°æ­£ç¢ºçš„æŒ‰éˆ•æ–‡å­—)
            agree_button = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.XPATH, "//button[contains(text(), 'æˆ‘åŒæ„')]"))
            )
            agree_button.click()
            print("âœ… æˆåŠŸé—œé–‰ã€Œå€‹äººè³‡æ–™ä½¿ç”¨èªªæ˜ã€å½ˆçª—ã€‚")
        except Exception as e:
            # å¦‚æœæ‰¾ä¸åˆ°æŒ‰éˆ•ï¼Œå¯èƒ½æ˜¯å½ˆçª—æ²’æœ‰å‡ºç¾ï¼Œé€™ä¸å½±éŸ¿ä¸»æµç¨‹ï¼Œåªåˆ—å°è­¦å‘Š
            print("âš ï¸ æœªåµæ¸¬åˆ°æˆ–æœªæˆåŠŸé—œé–‰ã€Œå€‹äººè³‡æ–™ä½¿ç”¨èªªæ˜ã€å½ˆçª—ã€‚å¦‚æœå½ˆçª—é‚„åœ¨ï¼Œè«‹æ‰‹å‹•é—œé–‰ã€‚")
            # print(f"é™¤éŒ¯è³‡è¨Š: {e}")

        # 2. å¡«å¯«å‡ºç™¼ç«™èˆ‡æŠµé”ç«™ã€æ—¥æœŸèˆ‡æ™‚é–“
        # ç­‰å¾…è¡¨å–®å…ƒç´ å®Œå…¨å¯äº’å‹•
        time.sleep(2)  # çµ¦äºˆé é¢é¡å¤–è¼‰å…¥æ™‚é–“

        # å‡ºç™¼ç«™
        start_station_select = WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.NAME, "selectStartStation"))
        )
        Select(start_station_select).select_by_visible_text(START_STATION)
        time.sleep(0.5)

        # æŠµé”ç«™
        end_station_select = WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.NAME, "selectDestinationStation"))
        )
        Select(end_station_select).select_by_visible_text(END_STATION)
        time.sleep(0.5)

        # æ—¥æœŸï¼ˆä½¿ç”¨ JavaScript ç›´æ¥è¨­å®šï¼Œé¿å… datepicker å¹²æ“¾ï¼‰
        try:
            date_input = WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.ID, "toTimeInputField"))
            )
            # å…ˆç§»é™¤ readonly å±¬æ€§ï¼ˆå¦‚æœæœ‰ï¼‰
            driver.execute_script("arguments[0].removeAttribute('readonly');", date_input)
            # æ¸…ç©ºä¸¦è¨­å®šæ—¥æœŸå€¼
            driver.execute_script("arguments[0].value = '';", date_input)
            driver.execute_script(f"arguments[0].value = '{DEPART_DATE}';", date_input)
            # è§¸ç™¼ change äº‹ä»¶ç¢ºä¿ç¶²ç«™æ¥æ”¶åˆ°è®Šæ›´
            driver.execute_script("arguments[0].dispatchEvent(new Event('change', { bubbles: true }));", date_input)
            print(f"âœ… å·²è¨­å®šæ—¥æœŸï¼š{DEPART_DATE}")
            time.sleep(0.5)
        except Exception as e:
            print(f"âš ï¸ æ—¥æœŸè¨­å®šç™¼ç”ŸéŒ¯èª¤: {e}")
            print("   è«‹æ‰‹å‹•è¨­å®šæ—¥æœŸ")

        # æ™‚é–“
        try:
            time_select = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.NAME, "toTimeTable"))
            )
            Select(time_select).select_by_visible_text(DEPART_TIME)
            time.sleep(0.5)
        except:
            print(f"âš ï¸ æ‰¾ä¸åˆ°æ™‚é–“ {DEPART_TIME}ï¼Œå°‡ä¿æŒé è¨­æˆ–é¸æ“‡æœ€æ¥è¿‘æ™‚é–“ã€‚")

        # å¡«å¯«ç¥¨æ•¸
        try:
            qty_select = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.NAME, "ticketPanel:rows:0:ticketAmount"))
            )
            Select(qty_select).select_by_visible_text(TICKET_QTY)
            time.sleep(0.5)
        except Exception as e:
            print(f"âš ï¸ ç„¡æ³•è¨­å®šç¥¨æ•¸ç‚º {TICKET_QTY} å¼µã€‚è«‹æ‰‹å‹•æª¢æŸ¥ã€‚ (éŒ¯èª¤: {e})")


        print("\\n==================================================")
        print("âœ… è¡¨å–®åŸºæœ¬è³‡è¨Šå¡«å¯«å®Œæˆï¼")
        print(f"ğŸ‘‰ è¨‚ç¥¨å¼µæ•¸å·²è¨­å®šç‚º {TICKET_QTY} å¼µã€‚")
        print("âš¡ æ­¥é©Ÿ 1ï¼šè«‹**æ‰‹å‹•è¼¸å…¥åœ–å½¢é©—è­‰ç¢¼**ä¸¦æŒ‰ä¸‹ã€Œé–‹å§‹æŸ¥è©¢ã€ï¼")

        # è®“ç¨‹å¼æš«åœï¼Œç­‰å¾…ä½¿ç”¨è€…æ‰‹å‹•å®Œæˆ CAPTCHA å’Œé»æ“ŠæŸ¥è©¢
        # *** é—œéµä¿®æ­£: å¼·åŒ–æç¤ºï¼Œè¦æ±‚ç”¨æˆ¶ç­‰åˆ°çµæœé é¢å‡ºç¾ ***
        input("â³ ã€é‡è¦ã€‘è«‹åœ¨ç€è¦½å™¨ä¸­ï¼š1. è¼¸å…¥é©—è­‰ç¢¼ã€‚ 2. é»æ“Šã€Œé–‹å§‹æŸ¥è©¢ã€ã€‚ 3. **ç­‰å¾…ã€Œè«‹ç¨å€™...ã€æ¶ˆå¤±ï¼Œé¡¯ç¤ºè»Šæ¬¡åˆ—è¡¨å¾Œ**ï¼Œå†å›åˆ° PowerShell æŒ‰ Enter å•Ÿå‹•è‡ªå‹•è¼ªè©¢...")
        print("==================================================")

        # 3. è‡ªå‹•è¼ªè©¢æµç¨‹ï¼ˆä½¿ç”¨é é¢åˆ·æ–°æ–¹å¼ï¼‰
        refresh_count = 0
        print("\\n" + "="*60)
        print("ğŸš€ é–‹å§‹è‡ªå‹•ç›£æ§æ¨¡å¼")
        print(f"â° æ¯ {REFRESH_INTERVAL_SECONDS} ç§’åˆ·æ–°ä¸€æ¬¡é é¢")
        print(f"ğŸ¯ ç›®æ¨™è»Šæ¬¡ï¼š{TRAIN_NO}")
        print("="*60 + "\\n")

        while True:
            refresh_count += 1
            print(f"\\n{'â”€'*60}")
            print(f"ğŸ” ç¬¬ {refresh_count} æ¬¡æª¢æŸ¥ [{time.strftime('%Y-%m-%d %H:%M:%S')}]")
            print(f"{'â”€'*60}")

            # å˜—è©¦é¸å–è»Šæ¬¡
            if find_and_select_train(driver, TRAIN_NO):
                # æˆåŠŸé¸å–ä¸¦ç¢ºèªï¼Œè·³å‡ºè¿´åœˆ
                print("\\n" + "="*60)
                print("âœ… ç›£æ§å®Œæˆï¼è«‹åœ¨ç€è¦½å™¨ä¸­ç¹¼çºŒå®Œæˆè³¼ç¥¨æµç¨‹ã€‚")
                print("="*60)
                break

            # 4. ç­‰å¾…å¾Œé‡æ–°æ•´ç†é é¢
            print(f"\\nâ³ ç­‰å¾… {REFRESH_INTERVAL_SECONDS} ç§’å¾Œåˆ·æ–°é é¢...")
            time.sleep(REFRESH_INTERVAL_SECONDS)

            try:
                # é‡æ–°æ•´ç†é é¢ï¼ˆé€™æ¨£ä¸éœ€è¦é‡æ–°è¼¸å…¥é©—è­‰ç¢¼ï¼‰
                driver.refresh()
                print("ğŸ”„ é é¢å·²åˆ·æ–°ï¼Œç­‰å¾…è¼‰å…¥...")

                # ç­‰å¾…æŸ¥è©¢çµæœè¡¨æ ¼è¼‰å…¥ï¼ˆçµ¦æ›´é•·çš„ç­‰å¾…æ™‚é–“ï¼‰
                WebDriverWait(driver, 15).until(
                    EC.presence_of_element_located((By.XPATH, "//table[contains(@class, 'table-bordered')]"))
                )
                print("âœ… è»Šæ¬¡åˆ—è¡¨å·²è¼‰å…¥")
                time.sleep(1)  # é¡å¤–ç­‰å¾…ç¢ºä¿é é¢å®Œå…¨è¼‰å…¥

            except Exception as e_refresh:
                print(f"âš ï¸ é é¢åˆ·æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤: {e_refresh}")
                print(f"   ç•¶å‰ URL: {driver.current_url}")
                print("   å¯èƒ½åŸå› ï¼š")
                print("   1. ç¶²è·¯é€£ç·šä¸ç©©å®š")
                print("   2. é«˜éµç¶²ç«™å›æ‡‰éæ…¢")
                print("   3. è¢«å°å›é¦–é ï¼ˆéœ€è¦é‡æ–°æŸ¥è©¢ï¼‰")
                print("ğŸ”„ å°‡åœ¨ä¸‹æ¬¡è¼ªè©¢æ™‚é‡è©¦...")

        print("\\nğŸ‰ è¨‚ç¥¨è¼”åŠ©æµç¨‹å®Œæˆï¼")

    except Exception as e:
        print(f"\\n==================================================")
        print(f"âŒ ç™¼ç”Ÿåš´é‡éŒ¯èª¤ï¼šç¨‹å¼é‹è¡Œå¤±æ•—ï¼")
        print(f"å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯ï¼š{e}")
        print(f"==================================================")

if __name__ == "__main__":
    run_booking_bot()
\`;
        }

        function getIntervalDesc(seconds) {
            const map = {
                '1': 'æ¥µé€Ÿæ¨¡å¼',
                '3': 'å¿«é€Ÿæ¨¡å¼',
                '5': 'æ¨™æº–æ¨¡å¼',
                '10': 'ç©©å®šæ¨¡å¼',
                '30': 'ä¿å®ˆæ¨¡å¼',
                '60': 'ç·©æ…¢æ¨¡å¼'
            };
            return map[seconds] || \`\${seconds} ç§’\`;
        }        // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©+15å¤©ï¼ˆé«˜éµæœ€å¤šæå‰28å¤©è¨‚ç¥¨ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            today.setDate(today.getDate() + 15);
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('departDate').value = dateStr;
        });
    </script>
</body>
</html>
