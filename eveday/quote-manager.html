<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªéŒ„ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">èªéŒ„ç®¡ç†</h1>
                <a href="index.html" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition">
                    â† è¿”å›æ—¥æ›†
                </a>
            </div>

            <!-- å°å…¥/å°å‡ºå€åŸŸ -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">å°å…¥/å°å‡ºèªéŒ„</h2>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <button
                            onclick="exportQuotes()"
                            class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition"
                        >
                            ğŸ“¥ å°å‡ºèªéŒ„æ¸…å–®ï¼ˆJSONï¼‰
                        </button>
                        <p class="text-xs text-gray-600 mt-2">å°å‡ºæ‰€æœ‰èªéŒ„ç‚º JSON æ ¼å¼</p>
                    </div>
                    <div>
                        <button
                            onclick="exportQuotesText()"
                            class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition"
                        >
                            ğŸ“‹ å°å‡ºèªéŒ„æ¸…å–®ï¼ˆæ–‡å­—ï¼‰
                        </button>
                        <p class="text-xs text-gray-600 mt-2">å°å‡ºæ‰€æœ‰èªéŒ„ç‚ºç´”æ–‡å­—æ ¼å¼</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700">å°å…¥èªéŒ„æ¸…å–®ï¼ˆJSON æˆ–æ–‡å­—ï¼Œæ¯è¡Œä¸€æ¢ï¼‰</label>
                    <textarea
                        id="importInput"
                        placeholder="è²¼ä¸ŠèªéŒ„æ¸…å–®...ï¼ˆJSON æ ¼å¼æˆ–æ¯è¡Œä¸€æ¢èªéŒ„ï¼‰"
                        rows="5"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none font-mono text-sm"
                    ></textarea>
                    <button
                        onclick="importQuotes()"
                        class="w-full px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition"
                    >
                        ğŸ“¤ å°å…¥èªéŒ„
                    </button>
                </div>
            </div>

            <!-- æ–°å¢èªéŒ„è¡¨å–® -->
            <div class="mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                <h2 class="text-xl font-semibold text-purple-800 mb-4">æ–°å¢èªéŒ„</h2>
                <div class="space-y-3">
                    <textarea
                        id="newQuoteInput"
                        placeholder="è¼¸å…¥èªéŒ„å…§å®¹...ï¼ˆæ”¯æ´æ›è¡Œï¼‰"
                        rows="3"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none"
                    ></textarea>
                    <button
                        onclick="addQuote()"
                        class="w-full px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition"
                    >
                        â• æ–°å¢èªéŒ„
                    </button>
                </div>
            </div>

            <!-- èªéŒ„åˆ—è¡¨ -->
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">èªéŒ„åˆ—è¡¨</h2>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-500" id="quoteCount">å…± 0 æ¢èªéŒ„</span>
                        <button
                            onclick="saveToFile()"
                            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition text-sm"
                            title="ä¸‹è¼‰æ›´æ–°å¾Œçš„ quotes-data.html æ–‡ä»¶"
                        >
                            ğŸ’¾ ä¿å­˜èªéŒ„æ–‡ä»¶
                        </button>
                    </div>
                </div>

                <div id="quotesList" class="space-y-3">
                    <!-- èªéŒ„é …ç›®å°‡ç”± JavaScript ç”Ÿæˆ -->
                </div>

                <div id="emptyState" class="text-center py-12 text-gray-400 hidden">
                    <p class="text-lg">ç›®å‰æ²’æœ‰èªéŒ„</p>
                    <p class="text-sm mt-2">è«‹åœ¨ä¸Šæ–¹æ–°å¢èªéŒ„</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¾ quotes-data.html è¼‰å…¥èªéŒ„
        let quotesDataLoaded = false;
        let quotesData = [];

        function loadQuotesFromFile() {
            return new Promise((resolve, reject) => {
                if (quotesDataLoaded) {
                    resolve(quotesData);
                    return;
                }

                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'quotes-data.html';

                iframe.onload = function() {
                    try {
                        const quotesWindow = iframe.contentWindow;
                        if (quotesWindow && quotesWindow.DAILY_QUOTES_LIST) {
                            quotesData = quotesWindow.DAILY_QUOTES_LIST;
                            quotesDataLoaded = true;
                            document.body.removeChild(iframe);
                            resolve(quotesData);
                        } else {
                            quotesData = [];
                            quotesDataLoaded = true;
                            document.body.removeChild(iframe);
                            resolve(quotesData);
                        }
                    } catch (e) {
                        console.error('è¼‰å…¥èªéŒ„å¤±æ•—:', e);
                        quotesData = [];
                        quotesDataLoaded = true;
                        if (iframe.parentNode) {
                            document.body.removeChild(iframe);
                        }
                        resolve(quotesData);
                    }
                };

                iframe.onerror = function() {
                    quotesData = [];
                    quotesDataLoaded = true;
                    if (iframe.parentNode) {
                        document.body.removeChild(iframe);
                    }
                    resolve(quotesData);
                };

                document.body.appendChild(iframe);

                setTimeout(() => {
                    if (!quotesDataLoaded) {
                        quotesData = [];
                        quotesDataLoaded = true;
                        if (iframe.parentNode) {
                            document.body.removeChild(iframe);
                        }
                        resolve(quotesData);
                    }
                }, 3000);
            });
        }

        // ç²å–èªéŒ„åˆ—è¡¨ï¼ˆå¾ quotes-data.htmlï¼‰
        async function getDailyQuotes() {
            if (!quotesDataLoaded) {
                await loadQuotesFromFile();
            }
            return quotesData;
        }

        // ä¿å­˜èªéŒ„åˆ—è¡¨åˆ° quotes-data.htmlï¼ˆé€šéä¸‹è¼‰æ›´æ–°çš„æ–‡ä»¶ï¼‰
        function saveDailyQuotesList(quotes) {
            quotesData = quotes;
            // ç”Ÿæˆæ–°çš„ quotes-data.html å…§å®¹
            const htmlContent = generateQuotesDataHTML(quotes);

            // å‰µå»ºä¸‹è¼‰é€£çµ
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quotes-data.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('âœ… èªéŒ„æ–‡ä»¶å·²ä¸‹è¼‰ï¼\n\nğŸ“ è«‹å°‡ä¸‹è¼‰çš„ quotes-data.html æª”æ¡ˆæ›¿æ›åŸæœ¬çš„æª”æ¡ˆï¼ˆåœ¨ eveday è³‡æ–™å¤¾ä¸­ï¼‰ã€‚\n\nç„¶å¾Œé‡æ–°æ•´ç† index.html é é¢å³å¯ä½¿ç”¨æ–°çš„èªéŒ„ã€‚');
        }

        // ç”Ÿæˆ quotes-data.html çš„ HTML å…§å®¹
        function generateQuotesDataHTML(quotes) {
            const quotesString = quotes.map(q => {
                // è½‰ç¾©ç‰¹æ®Šå­—ç¬¦ä¸¦è™•ç†æ›è¡Œ
                const escaped = q.replace(/\\/g, '\\\\')
                                 .replace(/"/g, '\\"')
                                 .replace(/\n/g, '\\n');
                return `            "${escaped}"`;
            }).join(',\n');

            return `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªéŒ„æ•¸æ“š</title>
</head>
<body>
    <script>
        // èªéŒ„æ•¸æ“šåº«
        // æ‚¨å¯ä»¥åœ¨æ­¤æ–‡ä»¶ä¸­ç›´æ¥ç·¨è¼¯ã€æ–°å¢æˆ–åˆªé™¤èªéŒ„
        // æ¯æ¢èªéŒ„ç”¨å¼•è™ŸåŒ…è£¹ï¼Œç”¨é€—è™Ÿåˆ†éš”ï¼Œæ”¯æ´æ›è¡Œç¬¦ \\n

        window.DAILY_QUOTES_LIST = [
${quotesString}
        ];
    <\/script>
</body>
</html>`;
        }

        // æ¸²æŸ“èªéŒ„åˆ—è¡¨
        async function renderQuotes() {
            const quotes = await getDailyQuotes();
            const quotesList = document.getElementById('quotesList');
            const emptyState = document.getElementById('emptyState');
            const quoteCount = document.getElementById('quoteCount');

            quoteCount.textContent = `å…± ${quotes.length} æ¢èªéŒ„`;

            if (quotes.length === 0) {
                quotesList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            quotesList.innerHTML = quotes.map((quote, index) => {
                const escapedQuote = escapeHtml(quote);
                const displayQuote = quote.replace(/\n/g, '<br>');
                return `
                    <div class="bg-white border-2 border-gray-200 rounded-lg p-4 hover:border-purple-300 transition" data-index="${index}">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1">
                                <div class="text-gray-700 leading-relaxed whitespace-pre-line">${displayQuote}</div>
                                <div class="mt-2 text-xs text-gray-400">ç¬¬ ${index + 1} æ¢</div>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    onclick="editQuote(${index})"
                                    class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition text-sm font-semibold"
                                    title="ç·¨è¼¯"
                                >
                                    âœï¸ ç·¨è¼¯
                                </button>
                                <button
                                    onclick="deleteQuote(${index})"
                                    class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition text-sm font-semibold"
                                    title="åˆªé™¤"
                                >
                                    ğŸ—‘ï¸ åˆªé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ–°å¢èªéŒ„
        async function addQuote() {
            const input = document.getElementById('newQuoteInput');
            const quote = input.value.trim();

            if (!quote) {
                alert('è«‹è¼¸å…¥èªéŒ„å…§å®¹');
                return;
            }

            const quotes = await getDailyQuotes();
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (quotes.includes(quote)) {
                alert('æ­¤èªéŒ„å·²å­˜åœ¨');
                return;
            }

            quotes.push(quote);
            quotesData = quotes; // æ›´æ–°å…§å­˜ä¸­çš„æ•¸æ“š
            input.value = '';
            await renderQuotes();
            // ä¸è‡ªå‹•ä¸‹è¼‰ï¼Œè®“ç”¨æˆ¶ä¸»å‹•é»æ“Šä¿å­˜æŒ‰éˆ•
        }

        // ç·¨è¼¯èªéŒ„
        async function editQuote(index) {
            const quotes = await getDailyQuotes();
            if (index < 0 || index >= quotes.length) return;

            const currentQuote = quotes[index];
            const newQuote = prompt('ç·¨è¼¯èªéŒ„ï¼š', currentQuote);

            if (newQuote === null) return; // ç”¨æˆ¶å–æ¶ˆäº†

            const trimmedQuote = newQuote.trim();
            if (!trimmedQuote) {
                alert('èªéŒ„å…§å®¹ä¸èƒ½ç‚ºç©º');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦èˆ‡å…¶ä»–èªéŒ„é‡è¤‡ï¼ˆæ’é™¤è‡ªå·±ï¼‰
            const otherQuotes = quotes.filter((q, i) => i !== index);
            if (otherQuotes.includes(trimmedQuote)) {
                alert('æ­¤èªéŒ„å·²å­˜åœ¨');
                return;
            }

            quotes[index] = trimmedQuote;
            quotesData = quotes; // æ›´æ–°å…§å­˜ä¸­çš„æ•¸æ“š
            await renderQuotes();
            // ä¸è‡ªå‹•ä¸‹è¼‰ï¼Œè®“ç”¨æˆ¶ä¸»å‹•é»æ“Šä¿å­˜æŒ‰éˆ•
        }

        // åˆªé™¤èªéŒ„
        async function deleteQuote(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èªéŒ„å—ï¼Ÿ')) return;

            const quotes = await getDailyQuotes();
            if (index < 0 || index >= quotes.length) return;

            quotes.splice(index, 1);
            quotesData = quotes; // æ›´æ–°å…§å­˜ä¸­çš„æ•¸æ“š
            await renderQuotes();
            // ä¸è‡ªå‹•ä¸‹è¼‰ï¼Œè®“ç”¨æˆ¶ä¸»å‹•é»æ“Šä¿å­˜æŒ‰éˆ•
        }

        // ä¿å­˜åˆ°æ–‡ä»¶æŒ‰éˆ•
        async function saveToFile() {
            const quotes = await getDailyQuotes();
            saveDailyQuotesList(quotes);
        }

        // å°å‡ºèªéŒ„ç‚º JSON æ ¼å¼
        async function exportQuotes() {
            const quotes = await getDailyQuotes();
            const json = JSON.stringify(quotes, null, 2);

            // å‰µå»ºä¸‹è¼‰é€£çµ
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `èªéŒ„æ¸…å–®_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('èªéŒ„å·²å°å‡ºï¼');
        }

        // å°å‡ºèªéŒ„ç‚ºç´”æ–‡å­—æ ¼å¼
        async function exportQuotesText() {
            const quotes = await getDailyQuotes();
            const text = quotes.join('\n\n---\n\n');

            // å‰µå»ºä¸‹è¼‰é€£çµ
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `èªéŒ„æ¸…å–®_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('èªéŒ„å·²å°å‡ºç‚ºæ–‡å­—æ ¼å¼ï¼');
        }

        // å°å…¥èªéŒ„
        async function importQuotes() {
            const input = document.getElementById('importInput');
            const content = input.value.trim();

            if (!content) {
                alert('è«‹è¼¸å…¥è¦å°å…¥çš„èªéŒ„å…§å®¹');
                return;
            }

            let newQuotes = [];

            try {
                // å˜—è©¦è§£æç‚º JSON
                const parsed = JSON.parse(content);
                if (Array.isArray(parsed)) {
                    newQuotes = parsed;
                } else {
                    throw new Error('ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ•¸çµ„');
                }
            } catch (e) {
                // å¦‚æœä¸æ˜¯ JSONï¼Œå‰‡æŒ‰è¡Œåˆ†å‰²
                newQuotes = content.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
            }

            if (newQuotes.length === 0) {
                alert('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èªéŒ„');
                return;
            }

            const currentQuotes = await getDailyQuotes();
            let addedCount = 0;
            let duplicateCount = 0;

            // åˆä½µèªéŒ„ï¼ˆé¿å…é‡è¤‡ï¼‰
            newQuotes.forEach(quote => {
                if (quote && !currentQuotes.includes(quote)) {
                    currentQuotes.push(quote);
                    addedCount++;
                } else {
                    duplicateCount++;
                }
            });

            quotesData = currentQuotes; // æ›´æ–°å…§å­˜ä¸­çš„æ•¸æ“š
            input.value = '';
            await renderQuotes();

            alert(`å°å…¥å®Œæˆï¼\næ–°å¢ï¼š${addedCount} æ¢\né‡è¤‡ï¼ˆå·²è·³éï¼‰ï¼š${duplicateCount} æ¢\n\nè«‹è¨˜å¾—é»æ“Šã€Œä¿å­˜èªéŒ„æ–‡ä»¶ã€æŒ‰éˆ•ä¸‹è¼‰æ›´æ–°å¾Œçš„æ–‡ä»¶ï¼`);
        }

        // HTML è½‰ç¾©
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ”¯æ´ Enter éµæ–°å¢ï¼ˆCtrl+Enter æˆ– Shift+Enterï¼‰
        document.getElementById('newQuoteInput')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.shiftKey)) {
                e.preventDefault();
                addQuote();
            }
        });

        // åˆå§‹åŒ–
        (async function() {
            await renderQuotes();
        })();
    </script>
</body>
</html>

