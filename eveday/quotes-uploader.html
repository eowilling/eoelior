<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘å¥ç®¡ç†ç³»çµ± | æ¯æ—¥æ—¥æ›†</title>
    <!-- Firebase é…ç½®ï¼ˆå¿…é ˆåœ¨ Firebase SDK ä¹‹å‰è¼‰å…¥ï¼‰ -->
    <script src="firebase-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fef3e2 0%, #fef9f3 50%, #e8f5f0 100%);
        }
        .quote-card {
            background: white;
            border-left: 4px solid #fb923c;
            transition: all 0.3s ease;
        }
        .quote-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(251, 146, 60, 0.2);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">ğŸ“ é‡‘å¥ç®¡ç†ç³»çµ±</h1>
                    <p class="text-gray-600">ä¸Šå‚³ã€ç®¡ç†ä½ çš„å‹µå¿—é‡‘å¥åº«</p>
                </div>
                <a href="index.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    â† è¿”å›æ—¥æ›†
                </a>
            </div>
            
            <!-- Firebase é€£ç·šç‹€æ…‹ -->
            <div id="firebaseStatus" class="bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded">
                <p class="text-yellow-700">ğŸ”„ æ­£åœ¨é€£æ¥ Firebase...</p>
            </div>
        </header>

        <!-- ä¸Šå‚³å€åŸŸ -->
        <div id="uploadSection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“¤ ä¸Šå‚³é‡‘å¥ TXT æ–‡ä»¶</h2>
            <div class="space-y-4">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-orange-400 transition">
                    <input type="file" id="txtFileInput" accept=".txt" class="hidden" onchange="handleFileSelect(event)">
                    <label for="txtFileInput" class="cursor-pointer">
                        <div class="text-6xl mb-4">ğŸ“„</div>
                        <p class="text-lg font-semibold text-gray-700 mb-2">é»æ“Šæˆ–æ‹–æ›³ TXT æ–‡ä»¶åˆ°é€™è£¡</p>
                        <p class="text-sm text-gray-500">æ”¯æ´æ ¼å¼ï¼šä½¿ç”¨ç©ºè¡Œï¼ˆä¸€è¡Œæˆ–å¤šè¡Œï¼‰å€åˆ†ä¸åŒé‡‘å¥</p>
                    </label>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">ğŸ“Œ æ–‡ä»¶æ ¼å¼èªªæ˜ï¼š</h3>
                    <pre class="text-sm text-blue-700 bg-white p-3 rounded">ç¬¬ä¸€å¥é‡‘å¥
å¯ä»¥å¤šè¡Œ


ç¬¬äºŒå¥é‡‘å¥
ä¹Ÿå¯ä»¥å¤šè¡Œ



ç¬¬ä¸‰å¥é‡‘å¥
ç©ºè¡Œæ•¸é‡ä¸é™ï¼Œè‡³å°‘ä¸€è¡Œç©ºè¡Œå³å¯å€åˆ†</pre>
                </div>
            </div>
        </div>

        <!-- è§£æçµæœé è¦½ -->
        <div id="previewSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ‘€ è§£æçµæœé è¦½</h2>
                <button onclick="uploadQuotesToFirebase()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                    âœ… ç¢ºèªä¸Šå‚³åˆ° Firebase
                </button>
            </div>
            <div id="quotesPreviewList" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- é è¦½å…§å®¹å°‡å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ç¾æœ‰é‡‘å¥åˆ—è¡¨ -->
        <div id="existingQuotesSection" class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ’¬ ç¾æœ‰é‡‘å¥åº«</h2>
                <div class="text-sm text-gray-600">
                    å…± <span id="quotesCount" class="font-bold text-orange-600">0</span> å¥
                </div>
            </div>
            <div id="existingQuotesList" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- ç¾æœ‰é‡‘å¥å°‡å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // æª¢æŸ¥ Firebase é…ç½®
        let firebaseConfig;
        let firebaseEnabled = false;

        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = typeof __firebase_config === 'string'
                    ? JSON.parse(__firebase_config)
                    : __firebase_config;
                firebaseEnabled = true;
            } else {
                showFirebaseError('æœªæª¢æ¸¬åˆ° Firebase é…ç½®');
            }
        } catch (e) {
            showFirebaseError('Firebase é…ç½®è§£æå¤±æ•—: ' + e.message);
        }

        // åˆå§‹åŒ– Firebase
        let app, auth, db;
        if (firebaseEnabled) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app, 'eveday');  // ä½¿ç”¨ eveday è³‡æ–™åº«
                
                // è‡ªå‹•åŒ¿åç™»å…¥
                signInAnonymously(auth).then(() => {
                    console.log('âœ… Firebase åŒ¿åç™»å…¥æˆåŠŸ');
                    showFirebaseSuccess();
                    loadExistingQuotes();
                }).catch((error) => {
                    showFirebaseError('Firebase ç™»å…¥å¤±æ•—: ' + error.message);
                });
                
            } catch (e) {
                showFirebaseError('Firebase åˆå§‹åŒ–å¤±æ•—: ' + e.message);
            }
        }

        function showFirebaseError(message) {
            const statusEl = document.getElementById('firebaseStatus');
            statusEl.className = 'bg-red-100 border-l-4 border-red-500 p-4 rounded';
            statusEl.innerHTML = `
                <p class="text-red-700 font-semibold">âŒ Firebase é€£ç·šå¤±æ•—</p>
                <p class="text-red-600 text-sm mt-1">${message}</p>
                <p class="text-red-600 text-sm mt-2">âš ï¸ æ­¤ç³»çµ±éœ€è¦ Firebase é€£ç·šæ‰èƒ½é‹ä½œ</p>
            `;
            document.getElementById('uploadSection').classList.add('opacity-50', 'pointer-events-none');
        }

        function showFirebaseSuccess() {
            const statusEl = document.getElementById('firebaseStatus');
            statusEl.className = 'bg-green-100 border-l-4 border-green-500 p-4 rounded';
            statusEl.innerHTML = '<p class="text-green-700 font-semibold">âœ… Firebase å·²é€£ç·š</p>';
        }

        // å…¨å±€è®Šæ•¸
        let parsedQuotes = [];

        // è™•ç†æ–‡ä»¶é¸æ“‡
        window.handleFileSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.txt')) {
                alert('è«‹é¸æ“‡ .txt æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseQuotes(content);
            };
            reader.readAsText(file, 'UTF-8');
        };

        // è§£æé‡‘å¥ï¼ˆç”¨ç©ºè¡Œå€åˆ†ï¼‰
        function parseQuotes(content) {
            // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼ï¼šä¸€å€‹æˆ–å¤šå€‹ç©ºè¡Œä½œç‚ºåˆ†éš”ç¬¦
            const quotes = content
                .split(/\n\s*\n+/)  // åˆ†å‰²ï¼šè‡³å°‘ä¸€å€‹ç©ºè¡Œï¼ˆåŒ…å«åªæœ‰ç©ºç™½çš„è¡Œï¼‰
                .map(q => q.trim()) // ç§»é™¤æ¯å¥å‰å¾Œçš„ç©ºç™½
                .filter(q => q.length > 0); // ç§»é™¤ç©ºå­—ä¸²

            parsedQuotes = quotes;
            
            // é¡¯ç¤ºé è¦½
            showPreview(quotes);
        }

        // é¡¯ç¤ºé è¦½
        function showPreview(quotes) {
            const previewSection = document.getElementById('previewSection');
            const previewList = document.getElementById('quotesPreviewList');
            
            previewSection.classList.remove('hidden');
            
            previewList.innerHTML = quotes.map((quote, index) => `
                <div class="quote-card p-4 rounded-lg">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center font-bold text-sm">
                            ${index + 1}
                        </div>
                        <div class="flex-1">
                            <p class="text-gray-700 whitespace-pre-wrap">${escapeHtml(quote)}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ä¸Šå‚³åˆ° Firebaseï¼ˆæ‰¹æ¬¡å¯«å…¥ç‰ˆæœ¬ï¼‰
        window.uploadQuotesToFirebase = async function() {
            console.log('ğŸš€ é–‹å§‹ä¸Šå‚³æµç¨‹...');
            console.log('Firebase å•Ÿç”¨ç‹€æ…‹:', firebaseEnabled);
            console.log('è³‡æ–™åº«å¯¦ä¾‹:', db);
            
            if (!firebaseEnabled || !db) {
                alert('âŒ Firebase æœªé€£ç·š');
                console.error('Firebase æœªé€£ç·š');
                return;
            }

            if (parsedQuotes.length === 0) {
                alert('âŒ æ²’æœ‰å¯ä¸Šå‚³çš„é‡‘å¥');
                console.error('é‡‘å¥é™£åˆ—ç‚ºç©º');
                return;
            }

            console.log(`ğŸ“ æº–å‚™ä¸Šå‚³ ${parsedQuotes.length} å¥é‡‘å¥`);
            const confirmed = confirm(`ç¢ºå®šè¦ä¸Šå‚³ ${parsedQuotes.length} å¥é‡‘å¥åˆ° Firebase å—ï¼Ÿ`);
            if (!confirmed) {
                console.log('âŒ ç”¨æˆ¶å–æ¶ˆä¸Šå‚³');
                return;
            }

            try {
                const BATCH_SIZE = 500; // Firestore æ‰¹æ¬¡å¯«å…¥ä¸Šé™
                const totalBatches = Math.ceil(parsedQuotes.length / BATCH_SIZE);
                
                console.log(`ğŸ“¦ å°‡åˆ†æˆ ${totalBatches} å€‹æ‰¹æ¬¡ä¸Šå‚³`);
                
                for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                    const batch = writeBatch(db);
                    const start = batchIndex * BATCH_SIZE;
                    const end = Math.min(start + BATCH_SIZE, parsedQuotes.length);
                    
                    console.log(`â³ æ­£åœ¨è™•ç†æ‰¹æ¬¡ ${batchIndex + 1}/${totalBatches} (ç¬¬ ${start + 1}-${end} å¥)`);
                    
                    for (let i = start; i < end; i++) {
                        const quote = parsedQuotes[i];
                        const docId = `quote_${Date.now()}_${i}`;
                        const docRef = doc(collection(db, 'quotes'), docId);
                        
                        batch.set(docRef, {
                            text: quote,
                            createdAt: new Date().toISOString(),
                            order: i
                        });
                    }
                    
                    console.log(`ğŸ’¾ æäº¤æ‰¹æ¬¡ ${batchIndex + 1}...`);
                    await batch.commit();
                    console.log(`âœ… æ‰¹æ¬¡ ${batchIndex + 1} ä¸Šå‚³æˆåŠŸï¼`);
                }

                console.log('ğŸ‰ å…¨éƒ¨ä¸Šå‚³å®Œæˆï¼');
                alert(`âœ… æˆåŠŸä¸Šå‚³ ${parsedQuotes.length} å¥é‡‘å¥ï¼`);
                
                // æ¸…ç©ºé è¦½
                document.getElementById('previewSection').classList.add('hidden');
                parsedQuotes = [];
                document.getElementById('txtFileInput').value = '';
                
                // é‡æ–°è¼‰å…¥ç¾æœ‰é‡‘å¥
                await loadExistingQuotes();
                
            } catch (error) {
                console.error('âŒ ä¸Šå‚³å¤±æ•—è©³ç´°éŒ¯èª¤:', error);
                console.error('éŒ¯èª¤ä»£ç¢¼:', error.code);
                console.error('éŒ¯èª¤è¨Šæ¯:', error.message);
                alert('âŒ ä¸Šå‚³å¤±æ•—: ' + error.message + '\néŒ¯èª¤ä»£ç¢¼: ' + error.code);
            }
        };

        // è¼‰å…¥ç¾æœ‰é‡‘å¥
        async function loadExistingQuotes() {
            if (!firebaseEnabled || !db) return;

            try {
                const quotesCollection = collection(db, 'quotes');
                const snapshot = await getDocs(quotesCollection);
                
                const quotes = [];
                snapshot.forEach(doc => {
                    quotes.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // æŒ‰ order æˆ–å‰µå»ºæ™‚é–“æ’åº
                quotes.sort((a, b) => (a.order || 0) - (b.order || 0));

                displayExistingQuotes(quotes);
                
            } catch (error) {
                console.error('è¼‰å…¥é‡‘å¥å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºç¾æœ‰é‡‘å¥
        function displayExistingQuotes(quotes) {
            const list = document.getElementById('existingQuotesList');
            const count = document.getElementById('quotesCount');
            
            count.textContent = quotes.length;

            if (quotes.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center py-8">å°šç„¡é‡‘å¥ï¼Œè«‹ä¸Šå‚³ TXT æ–‡ä»¶</p>';
                return;
            }

            list.innerHTML = quotes.map((quote, index) => `
                <div class="quote-card p-4 rounded-lg flex items-start gap-3">
                    <div class="flex-shrink-0 w-8 h-8 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center font-bold text-sm">
                        ${index + 1}
                    </div>
                    <div class="flex-1">
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHtml(quote.text)}</p>
                        <p class="text-xs text-gray-400 mt-2">ID: ${quote.id}</p>
                    </div>
                    <button onclick="deleteQuote('${quote.id}')" class="flex-shrink-0 px-3 py-1 text-xs bg-red-100 text-red-600 rounded hover:bg-red-200 transition">
                        åˆªé™¤
                    </button>
                </div>
            `).join('');
        }

        // åˆªé™¤é‡‘å¥
        window.deleteQuote = async function(quoteId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¥é‡‘å¥å—ï¼Ÿ')) return;

            try {
                await deleteDoc(doc(db, 'quotes', quoteId));
                alert('âœ… åˆªé™¤æˆåŠŸ');
                await loadExistingQuotes();
            } catch (error) {
                console.error('åˆªé™¤å¤±æ•—:', error);
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        };

        // HTML è½‰ç¾©
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
