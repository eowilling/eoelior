<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­è¨ˆç›®éŒ„ç”¢ç”Ÿå™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Noto Sans TC å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- è¼‰å…¥ html2canvas ç”¨æ–¼åœ–ç‰‡åŒ¯å‡º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* ç¢ºä¿å­—é«”è¨­å®šç‚º Noto Sans TC */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f7f9fc;
        }

        /* è®“é è¦½å€å¡Šçš„æ–‡å­—ä½¿ç”¨ç­‰å¯¬å­—é«”ï¼Œä»¥ç¢ºä¿é»é»å°é½Š */
        #toc-preview-content {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            white-space: pre-wrap; /* ä¿ç•™ç©ºç™½å’Œæ›è¡Œ */
        }

        /* é‡å°ä¸åŒå±¤ç´šçš„æ¨£å¼ */
        .level-major {
            font-weight: 700;
            font-size: 1.125rem; /* lg */
            margin-bottom: 0.5rem;
            margin-top: 1rem;
        }
        .level-minor {
            font-weight: 400;
            font-size: 1rem; /* base */
            padding-left: 1rem;
            margin-bottom: 0.25rem;
        }
        .level-detail {
            font-weight: 300;
            font-size: 0.875rem; /* sm */
            padding-left: 2rem;
            margin-bottom: 0.125rem;
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl p-4 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">è¨­è¨ˆç›®éŒ„ç”¢ç”Ÿå™¨</h1>
        <p id="user-id-display" class="text-xs text-gray-500 mb-2"></p>
        <p id="status-message" class="text-sm text-blue-600 mb-4">æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«...</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- å·¦å´ï¼šæ–°å¢èˆ‡ç®¡ç†æ¢ç›® -->
            <div class="lg:col-span-1">
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">æ–°å¢ç›®éŒ„æ¢ç›®</h2>
                    <form id="add-entry-form" class="space-y-4">

                        <div>
                            <label for="entry-text" class="block text-sm font-medium text-gray-700">æ¨™é¡Œæ–‡å­— <span class="text-red-500">*</span></label>
                            <!-- è®Šæ›´èƒŒæ™¯è‰²ç‚º bg-gray-50 -->
                            <input type="text" id="entry-text" name="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-gray-50" required placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€ç«  å°ˆæ¡ˆç°¡ä»‹ æˆ– 1.1 è¨­è¨ˆç†å¿µ">
                        </div>

                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="entry-page" class="block text-sm font-medium text-gray-700">é ç¢¼ (å¯é¸)</label>
                                <!-- è®Šæ›´èƒŒæ™¯è‰²ç‚º bg-gray-50 -->
                                <input type="number" id="entry-page" name="page" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-gray-50" placeholder="ä¾‹å¦‚ï¼š5 (å¯é¸)">
                            </div>
                            <div class="flex-1">
                                <label for="entry-level" class="block text-sm font-medium text-gray-700">å±¤ç´š <span class="text-red-500">*</span></label>
                                <!-- è®Šæ›´èƒŒæ™¯è‰²ç‚º bg-gray-50 -->
                                <select id="entry-level" name="level" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-gray-50" required>
                                    <option value="major">å¤§æ¨™é¡Œ</option>
                                    <option value="minor">å°æ¨™é¡Œ</option>
                                    <option value="detail">ç´°é …</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                            æ–°å¢æ¢ç›®
                        </button>
                    </form>
                </div>

                <!-- æ¢ç›®åˆ—è¡¨ -->
                <h2 class="text-xl font-semibold mb-3 text-gray-700">å·²æ–°å¢æ¢ç›®</h2>
                <div id="toc-list" class="space-y-2 max-h-96 overflow-y-auto custom-scroll">
                    <p class="text-gray-500 text-sm p-2" id="empty-list-message">ç›®å‰æ²’æœ‰æ¢ç›®ã€‚</p>
                </div>
            </div>

            <!-- å³å´ï¼šç›®éŒ„é è¦½èˆ‡æ“ä½œ -->
            <div class="lg:col-span-2">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">ç›®éŒ„é è¦½ (TOC Preview)</h2>
                    <div id="toc-preview-container" class="bg-white p-6 md:p-8 border-2 border-dashed border-gray-300 rounded-lg shadow-lg relative min-h-[400px]">
                        <!-- é è¦½æ–‡å­—å€å¡Š (ç”¨ä¾†åŒ¯å‡ºåœ–ç‰‡) -->
                        <div id="toc-preview-content" class="text-gray-900 leading-relaxed">
                            <p class="text-center text-gray-400 mt-16">è«‹åœ¨å·¦å´æ–°å¢ç›®éŒ„æ¢ç›®ï¼Œçµæœå°‡å³æ™‚é¡¯ç¤ºæ–¼æ­¤ã€‚</p>
                        </div>
                        <!-- åœ–ç‰‡åŒ¯å‡ºæ™‚çš„æµ®æ°´å° -->
                        <div class="absolute bottom-4 right-4 text-xs text-gray-300 opacity-80" id="watermark">
                            è¨­è¨ˆç›®éŒ„ç”¢ç”Ÿå™¨
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <button onclick="copyToClipboard()" class="flex-1 py-2 px-4 rounded-md text-white bg-green-500 hover:bg-green-600 focus:ring-2 focus:ring-offset-2 focus:ring-green-400 transition duration-150">
                        ğŸ“‹ è¤‡è£½ç›®éŒ„æ–‡å­—
                    </button>
                    <button onclick="exportAsImage()" class="flex-1 py-2 px-4 rounded-md text-white bg-indigo-500 hover:bg-indigo-600 focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400 transition duration-150">
                        ğŸ–¼ï¸ åŒ¯å‡ºç‚ºåœ–ç‰‡ (PNG)
                    </button>
                </div>

                <!-- è¨Šæ¯/èª¿æ•´è¼¸å…¥æ¡† -->
                <div id="message-box" class="mt-4 p-3 rounded-md hidden"></div>
            </div>
        </div>

    </div>

    <!-- è…³æœ¬ 1: å…¨åŸŸ UI/æ¸²æŸ“å‡½æ•¸ -->
    <script>
        // æ¸²æŸ“åˆ—è¡¨çš„é¡è‰²å’Œæ¨£å¼
        const levelStyles = {
            'major': { label: 'å¤§æ¨™é¡Œ', text: 'text-lg font-bold text-gray-800' },
            'minor': { label: 'å°æ¨™é¡Œ', text: 'text-base font-medium text-gray-700' },
            'detail': { label: 'ç´°é …', text: 'text-sm text-gray-600' }
        };

        // å…¨åŸŸè®Šæ•¸
        const tocItems = []; // ç”¨æ–¼åœ¨æ¸²æŸ“å’Œèª¿æ•´å‡½æ•¸ä¹‹é–“å…±äº«è³‡æ–™
        window.isOfflineMode = false; // é›¢ç·šæ¨¡å¼æ¨™è¨˜

        function clearMessageBox() {
             const msgBox = document.getElementById('message-box');
             msgBox.style.display = 'none';
             msgBox.innerHTML = '';
             msgBox.className = 'mt-4 p-3 rounded-md hidden';
        }

        // è¨Šæ¯æç¤ºæ¡†
        function showMessage(text, className = 'bg-green-100 text-green-800') {
            const msgBox = document.getElementById('message-box');
            // å…ˆæ¸…é™¤è‡ªè¨‚è¼¸å…¥æ¡†
            clearMessageBox();

            msgBox.textContent = text;
            msgBox.className = `mt-4 p-3 rounded-md ${className} block`;

            // ç”±æ–¼èª¿æ•´é ç¢¼çš„ success/error æµç¨‹æœƒå†æ¬¡å‘¼å« showMessageï¼Œ
            // é€™è£¡ç¢ºä¿åªæœ‰åœ¨ç°¡å–®çš„ showMessage æç¤ºä¸‹æ‰è¨­ç½®è‡ªå‹•æ¶ˆå¤±
            if (className.includes('green') || className.includes('red')) {
                setTimeout(() => {
                    clearMessageBox();
                }, 3000);
            }
        }

        // æ¸²æŸ“å·²æ–°å¢çš„æ¢ç›®åˆ—è¡¨ (å·¦å´)
        window.renderTOCList = (items) => {
            const listContainer = document.getElementById('toc-list');
            listContainer.innerHTML = '';

            if (items.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-sm p-2" id="empty-list-message">ç›®å‰æ²’æœ‰æ¢ç›®ã€‚</p>';
                return;
            }

            items.forEach(item => {
                const style = levelStyles[item.level];
                const itemEl = document.createElement('div');
                itemEl.className = `flex items-center p-3 rounded-lg bg-white shadow-sm border border-l-4 border-indigo-400 group`;
                itemEl.setAttribute('data-id', item.id);

                itemEl.innerHTML = `
                    <div class="flex-1 truncate">
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700">${style.label}</span>
                        <span class="ml-2 ${style.text} truncate">${item.text}</span>
                    </div>

                    <span class="text-lg font-mono text-gray-500 ml-4 w-10 text-right flex-shrink-0">${item.page || '-'}</span>

                    <!-- ç·¨è¼¯æŒ‰éˆ• -->
                    <button class="ml-2 p-1 text-xs rounded-md bg-yellow-100 text-yellow-700 hover:bg-yellow-200 transition-colors flex-shrink-0 opacity-0 group-hover:opacity-100 action-btn-edit"
                            title="ç·¨è¼¯æ­¤æ¢ç›®"
                            data-id="${item.id.replace(/"/g, '&quot;')}">
                        âœï¸
                    </button>

                    <!-- æ’å…¥æŒ‰éˆ• -->
                    <button class="ml-2 p-1 text-xs rounded-md bg-cyan-100 text-cyan-700 hover:bg-cyan-200 transition-colors flex-shrink-0 opacity-0 group-hover:opacity-100 action-btn-insert"
                            title="åœ¨æ­¤æ¢ç›®å¾Œæ’å…¥æ–°é …ç›®"
                            data-id="${item.id.replace(/"/g, '&quot;')}">
                        â•
                    </button>

                    <!-- åˆªé™¤æŒ‰éˆ• -->
                    <button class="ml-2 p-1 text-xs rounded-md bg-red-100 text-red-700 hover:bg-red-200 transition-colors flex-shrink-0 opacity-0 group-hover:opacity-100 action-btn-delete"
                            title="åˆªé™¤æ­¤æ¢ç›®"
                            data-id="${item.id.replace(/"/g, '&quot;')}">
                        x
                    </button>
                `;

                listContainer.appendChild(itemEl);
            });
        };

        // æ¸²æŸ“ç›®éŒ„æ–‡å­—é è¦½ (å³å´)
        window.renderTOCPreview = (items) => {
            const previewContent = document.getElementById('toc-preview-content');
            let tocText = '';
            previewContent.innerHTML = '';

            if (items.length === 0) {
                previewContent.innerHTML = '<p class="text-center text-gray-400 mt-16">è«‹åœ¨å·¦å´æ–°å¢ç›®éŒ„æ¢ç›®ï¼Œçµæœå°‡å³æ™‚é¡¯ç¤ºæ–¼æ­¤ã€‚</p>';
                return;
            }

            // æœ€å¤§è¡Œé•·åº¦ (ç”¨æ–¼è¨ˆç®—é»é»æ•¸)
            const MAX_LINE_WIDTH = 80;
            // é ç¢¼å¯¬åº¦é ç•™
            const PAGE_WIDTH = 4;
            // åŸºç¤ç¸®é€²
            const INDENT = {
                'major': 0,
                'minor': 4, // 4 å€‹ç©ºæ ¼
                'detail': 8  // 8 å€‹ç©ºæ ¼
            };
            const INDENT_CHAR = '\u00A0'; // ä¸æ›è¡Œç©ºæ ¼

            items.forEach(item => {
                const indent = INDENT_CHAR.repeat(INDENT[item.level]);
                const text = item.text;
                const page = item.page;

                // ç‚ºäº†ç¢ºä¿ HTML é¡¯ç¤ºçš„é»é»èƒ½å°é½Šï¼Œæˆ‘å€‘ä½¿ç”¨ flex ä½ˆå±€ä¾†æ¨¡æ“¬
                const lineDiv = document.createElement('div');
                lineDiv.className = `flex justify-between ${item.level === 'major' ? 'level-major' : (item.level === 'minor' ? 'level-minor' : 'level-detail')}`;

                // å·¦å´å…§å®¹ (æ–‡å­—)
                const textSpan = document.createElement('span');
                textSpan.className = 'whitespace-pre-wrap truncate';
                textSpan.textContent = indent + text;

                // ä¸­é–“é»é» (ä½¿ç”¨ flex-grow å¡«æ»¿ç©ºé–“)
                const dotsSpan = document.createElement('span');
                if (page.length > 0) {
                    dotsSpan.className = 'flex-grow border-b border-dotted border-gray-400 mx-1 mb-1';
                } else {
                    dotsSpan.className = 'flex-grow mx-1 mb-1';
                }

                // å³å´é ç¢¼
                const pageSpan = document.createElement('span');
                pageSpan.className = 'flex-shrink-0 ml-1 font-bold';
                pageSpan.textContent = page;

                // çµ„è£è¡Œå…ƒç´ 
                lineDiv.appendChild(textSpan);
                lineDiv.appendChild(dotsSpan);
                lineDiv.appendChild(pageSpan);

                previewContent.appendChild(lineDiv);

                // æº–å‚™ç´”æ–‡å­—æ ¼å¼ï¼ˆç”¨æ–¼è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼‰
                const isPagePresent = page.length > 0;
                const pageReserveWidth = isPagePresent ? PAGE_WIDTH : 0;
                const textLength = indent.length + text.length;
                const dotCount = Math.max(1, MAX_LINE_WIDTH - textLength - pageReserveWidth);
                const padding = '.'.repeat(dotCount); // <-- ä¿®æ­£å¾Œçš„èªæ³•

                tocText += `${indent}${text}${padding}${page}\n`;
            });

            // å°‡ç´”æ–‡å­—å…§å®¹å„²å­˜èµ·ä¾†ä¾›è¤‡è£½ä½¿ç”¨
            window.rawTocText = tocText.trim();
        };

        // åŸ·è¡Œåˆªé™¤æ“ä½œ (åˆ¤æ–·æ¨¡å¼è‡ªå‹•é¸æ“‡å¯¦ç¾)
        window.performDelete = (id) => {
            if (window.isOfflineMode) {
                window.deleteTOCEntryLocal(id);
            } else {
                window.deleteTOCEntry(id);
            }
        };

        // åŸ·è¡Œç·¨è¼¯æ“ä½œ
        window.performEdit = (id) => {
            window.editTOCEntry(id);
        };

        // åœ¨æŒ‡å®šæ¢ç›®å¾ŒåŸ·è¡Œæ’å…¥æ“ä½œ
        window.performInsert = (afterId) => {
            window.insertTOCEntry(afterId);
        };

        // ç·¨è¼¯æ¢ç›®
        window.editTOCEntry = (id) => {
            const item = window.tocItems.find(i => i.id === id);
            if (!item) {
                showMessage('âŒ æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„æ¢ç›®ã€‚', 'bg-red-100 text-red-800');
                return;
            }

            clearMessageBox();
            const msgBox = document.getElementById('message-box');
            msgBox.className = 'mt-4 p-3 rounded-md bg-purple-100 text-purple-800 block';
            msgBox.innerHTML = `
                <div class="font-bold mb-3">ç·¨è¼¯æ¢ç›®</div>
                <div class="space-y-2 mb-3">
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-1">æ¨™é¡Œæ–‡å­—</label>
                        <input type="text" id="edit-text-input" value="${item.text}" placeholder="è¼¸å…¥æ¨™é¡Œ" class="p-2 border rounded-md text-sm text-gray-800 w-full focus:border-purple-500 focus:ring-purple-500 bg-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-1">é ç¢¼</label>
                        <input type="number" id="edit-page-input" value="${item.page}" placeholder="é ç¢¼ (å¯é¸)" min="1" class="p-2 border rounded-md text-sm text-gray-800 w-full focus:border-purple-500 focus:ring-purple-500 bg-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-1">å±¤ç´š</label>
                        <select id="edit-level-input" class="p-2 border rounded-md text-sm text-gray-800 w-full focus:border-purple-500 focus:ring-purple-500 bg-white">
                            <option value="major" ${item.level === 'major' ? 'selected' : ''}>å¤§æ¨™é¡Œ</option>
                            <option value="minor" ${item.level === 'minor' ? 'selected' : ''}>å°æ¨™é¡Œ</option>
                            <option value="detail" ${item.level === 'detail' ? 'selected' : ''}>ç´°é …</option>
                        </select>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="window.saveEditTOCEntry('${id}')" class="flex-1 p-2 text-sm rounded-md bg-purple-600 text-white hover:bg-purple-700 transition-colors">
                        âœ… ä¿å­˜
                    </button>
                    <button onclick="clearMessageBox()" class="flex-1 p-2 text-sm rounded-md bg-gray-300 text-gray-800 hover:bg-gray-400 transition-colors">
                        âŒ å–æ¶ˆ
                    </button>
                </div>
            `;
        };

        // ä¿å­˜ç·¨è¼¯
        window.saveEditTOCEntry = (id) => {
            const newText = document.getElementById('edit-text-input').value.trim();
            const newPage = document.getElementById('edit-page-input').value.trim();
            const newLevel = document.getElementById('edit-level-input').value;

            if (!newText) {
                showMessage('âŒ æ¨™é¡Œæ–‡å­—ä¸èƒ½ç‚ºç©ºã€‚', 'bg-red-100 text-red-800');
                return;
            }

            // å…ˆæ¸…é™¤ç·¨è¼¯æ¡†
            clearMessageBox();

            console.log('ä¿å­˜ç·¨è¼¯ - isOfflineMode:', window.isOfflineMode, 'updateTOCEntry exists:', typeof window.updateTOCEntry);

            if (window.isOfflineMode) {
                window.updateTOCEntryLocal(id, newText, newPage, newLevel);
            } else if (typeof window.updateTOCEntry === 'function') {
                window.updateTOCEntry(id, newText, newPage, newLevel);
            } else {
                // å¦‚æœè³‡æ–™åº«åŠŸèƒ½æœªè¼‰å…¥ï¼Œå˜—è©¦ä½¿ç”¨é›¢ç·šæ¨¡å¼
                console.warn('è³‡æ–™åº«åŠŸèƒ½æœªè¼‰å…¥ï¼Œå˜—è©¦ä½¿ç”¨é›¢ç·šæ¨¡å¼');
                if (typeof window.updateTOCEntryLocal === 'function') {
                    window.updateTOCEntryLocal(id, newText, newPage, newLevel);
                } else {
                    showMessage('âŒ è³‡æ–™åº«åŠŸèƒ½å°šæœªè¼‰å…¥ï¼Œä¸”é›¢ç·šæ¨¡å¼ä¸å¯ç”¨ã€‚', 'bg-red-100 text-red-800');
            }
            }
        };

        // åœ¨æŒ‡å®šæ¢ç›®å¾Œæ’å…¥æ–°æ¢ç›®
        window.insertTOCEntry = (afterId) => {
            clearMessageBox();
            const msgBox = document.getElementById('message-box');
            msgBox.className = 'mt-4 p-3 rounded-md bg-cyan-100 text-cyan-800 block';
            msgBox.innerHTML = `
                <div class="font-bold mb-3">åœ¨æ­¤æ¢ç›®å¾Œæ’å…¥æ–°é …ç›®</div>
                <div class="space-y-2 mb-3">
                    <div>
                        <label class="block text-sm font-medium text-cyan-700 mb-1">æ¨™é¡Œæ–‡å­—</label>
                        <input type="text" id="insert-text-input" placeholder="è¼¸å…¥æ¨™é¡Œ" class="p-2 border rounded-md text-sm text-gray-800 w-full focus:border-cyan-500 focus:ring-cyan-500 bg-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-cyan-700 mb-1">é ç¢¼</label>
                        <input type="number" id="insert-page-input" placeholder="é ç¢¼ (å¯é¸)" min="1" class="p-2 border rounded-md text-sm text-gray-800 w-full focus:border-cyan-500 focus:ring-cyan-500 bg-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-cyan-700 mb-1">å±¤ç´š</label>
                        <select id="insert-level-input" class="p-2 border rounded-md text-sm text-gray-800 w-full focus:border-cyan-500 focus:ring-cyan-500 bg-white">
                            <option value="major">å¤§æ¨™é¡Œ</option>
                            <option value="minor" selected>å°æ¨™é¡Œ</option>
                            <option value="detail">ç´°é …</option>
                        </select>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="window.confirmInsertTOCEntry('${afterId}')" class="flex-1 p-2 text-sm rounded-md bg-cyan-600 text-white hover:bg-cyan-700 transition-colors">
                        âœ… æ’å…¥
                    </button>
                    <button onclick="clearMessageBox()" class="flex-1 p-2 text-sm rounded-md bg-gray-300 text-gray-800 hover:bg-gray-400 transition-colors">
                        âŒ å–æ¶ˆ
                    </button>
                </div>
            `;
        };

        // ç¢ºèªæ’å…¥
        window.confirmInsertTOCEntry = (afterId) => {
            const text = document.getElementById('insert-text-input').value.trim();
            const page = document.getElementById('insert-page-input').value.trim();
            const level = document.getElementById('insert-level-input').value;

            if (!text) {
                showMessage('âŒ æ¨™é¡Œæ–‡å­—ä¸èƒ½ç‚ºç©ºã€‚', 'bg-red-100 text-red-800');
                return;
            }

            // å…ˆæ¸…é™¤æ’å…¥æ¡†
            clearMessageBox();

            if (window.isOfflineMode) {
                window.insertNewTOCEntryLocal(afterId, text, page, level);
            } else if (typeof window.insertNewTOCEntry === 'function') {
                window.insertNewTOCEntry(afterId, text, page, level);
            } else {
                showMessage('âŒ è³‡æ–™åº«åŠŸèƒ½å°šæœªè¼‰å…¥ã€‚', 'bg-red-100 text-red-800');
            }
        };

        // æ“ä½œå‡½æ•¸ï¼šè¤‡è£½åˆ°å‰ªè²¼ç°¿
        window.copyToClipboard = () => {
            if (!window.rawTocText) {
                showMessage('ç›®éŒ„å…§å®¹ç‚ºç©ºï¼Œç„¡æ³•è¤‡è£½ã€‚', 'bg-red-100 text-red-800');
                return;
            }

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = window.rawTocText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();

            try {
                document.execCommand('copy');
                showMessage('âœ… ç›®éŒ„æ–‡å­—å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'bg-green-100 text-green-800');
            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—: ', err);
                showMessage('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—ã€‚', 'bg-red-100 text-red-800');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        };

        // æ“ä½œå‡½æ•¸ï¼šåŒ¯å‡ºç‚ºåœ–ç‰‡
        window.exportAsImage = () => {
            const container = document.getElementById('toc-preview-container');
            const watermark = document.getElementById('watermark');

            if (container.querySelector('#toc-preview-content').children.length === 0) {
                 showMessage('ç›®éŒ„å…§å®¹ç‚ºç©ºï¼Œç„¡æ³•åŒ¯å‡ºåœ–ç‰‡ã€‚', 'bg-red-100 text-red-800');
                 return;
            }

            showMessage('â³ æ­£åœ¨åŒ¯å‡ºåœ–ç‰‡...', 'bg-yellow-100 text-yellow-800');
            watermark.style.display = 'block';

            container.style.border = 'none';
            container.style.boxShadow = 'none';
            container.style.backgroundColor = '#ffffff';

            html2canvas(container, {
                scale: 2,
                useCORS: true,
                logging: false,
            }).then(canvas => {
                container.style.border = '2px dashed #d1d5db';
                container.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)';

                const link = document.createElement('a');
                link.download = 'è¨­è¨ˆç›®éŒ„.png';
                link.href = canvas.toDataURL('image/png');
                link.click();

                showMessage('ğŸ–¼ï¸ åœ–ç‰‡å·²æˆåŠŸåŒ¯å‡ºï¼', 'bg-green-100 text-green-800');
            }).catch(error => {
                console.error("åœ–ç‰‡åŒ¯å‡ºå¤±æ•—:", error);
                showMessage('âŒ åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ã€‚', 'bg-red-100 text-red-800');
            }).finally(() => {
                watermark.style.display = 'none';
                container.style.backgroundColor = '#ffffff';
            });
        };

        // è™•ç†è¡¨å–®æäº¤
        window.initFormSubmission = () => {
            const form = document.getElementById('add-entry-form');
            if (!form) {
                console.warn("è¡¨å–®å…ƒç´ æœªæ‰¾åˆ°");
                return;
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const text = document.getElementById('entry-text').value.trim();
                const pageInput = document.getElementById('entry-page').value.trim();
                const level = document.getElementById('entry-level').value;

                let pageValue = '';
                if (pageInput !== '') {
                    const parsedPage = parseInt(pageInput);
                    if (!isNaN(parsedPage) && parsedPage >= 1) {
                        pageValue = String(parsedPage);
                    } else {
                        showMessage('âš ï¸ é ç¢¼è¼¸å…¥ç„¡æ•ˆæˆ–å°æ–¼ 1ï¼Œå°‡å„²å­˜ç‚ºç©ºã€‚', 'bg-red-100 text-red-800');
                        pageValue = '';
                    }
                }

                if (text) {
                    if (window.isOfflineMode) {
                        window.addTOCEntryLocal(text, pageValue, level);
                    } else {
                        window.addTOCEntry(text, pageValue, level);
                    }

                    document.getElementById('entry-text').value = '';
                    document.getElementById('entry-page').value = '';
                } else {
                     showMessage('âŒ æ¨™é¡Œæ–‡å­—ä¸èƒ½ç‚ºç©ºã€‚', 'bg-red-100 text-red-800');
                }
            });
        };

        // åˆå§‹åŒ–äº‹ä»¶å§”æ´¾ï¼ˆè™•ç†åˆ—è¡¨ä¸­çš„æŒ‰éˆ•é»æ“Šï¼‰
        window.initEventDelegation = () => {
            const listContainer = document.getElementById('toc-list');
            if (!listContainer) {
                console.warn("åˆ—è¡¨å®¹å™¨æœªæ‰¾åˆ°");
                return;
            }

            // ä½¿ç”¨äº‹ä»¶å§”æ´¾è™•ç†æŒ‰éˆ•é»æ“Š
            listContainer.addEventListener('click', function(e) {
                // æ‰¾åˆ°è¢«é»æ“Šçš„æŒ‰éˆ•ï¼ˆå¯èƒ½æ˜¯æŒ‰éˆ•æœ¬èº«æˆ–å…¶å­å…ƒç´ ï¼‰
                const button = e.target.closest('button.action-btn-edit, button.action-btn-insert, button.action-btn-delete');
                if (!button) return;

                e.preventDefault();
                e.stopPropagation();

                const id = button.getAttribute('data-id');
                if (!id) {
                    console.error('æŒ‰éˆ•ç¼ºå°‘ data-id å±¬æ€§', button);
                    return;
                }

                console.log('æŒ‰éˆ•é»æ“Š:', button.className, 'ID:', id);

                if (button.classList.contains('action-btn-edit')) {
                    console.log('åŸ·è¡Œç·¨è¼¯æ“ä½œ');
                    window.performEdit(id);
                } else if (button.classList.contains('action-btn-insert')) {
                    console.log('åŸ·è¡Œæ’å…¥æ“ä½œ');
                    window.performInsert(id);
                } else if (button.classList.contains('action-btn-delete')) {
                    console.log('åŸ·è¡Œåˆªé™¤æ“ä½œ');
                    window.performDelete(id);
                }
            });
        };

        // åœ¨ DOM æº–å‚™å¥½å¾Œåˆå§‹åŒ–è¡¨å–®å’Œäº‹ä»¶å§”æ´¾
        const initAll = () => {
            window.initFormSubmission();
            window.initEventDelegation();
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAll);
        } else {
            initAll();
        }

    </script>

    <!-- è…³æœ¬ 2: Firebase ç›¸é—œé‚è¼¯ (ä½¿ç”¨ type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Debug Log
        setLogLevel('debug');

        // å…¨åŸŸè®Šæ•¸æª¢æŸ¥ (ç”± Canvas ç’°å¢ƒæä¾›)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'toc-generator-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // å®£å‘Š Firebase è®Šæ•¸
        let app = null;
        let db = null;
        let auth = null;

        window.tocCollectionRef = null;

        let userId = null;
        let isAuthReady = false;

        // å¼•ç”¨ç¬¬ä¸€å€‹è…³æœ¬ä¸­çš„å…¨åŸŸé™£åˆ—
        if (!window.tocItems) { window.tocItems = []; }

        // é›¢ç·šæ¨¡å¼æ¨™è¨˜
        let isOfflineMode = false;
        const STORAGE_KEY = 'toc-entries-local';

        // ===================================
        // æœ¬åœ°å­˜å„²æ“ä½œå‡½æ•¸ (é›¢ç·šæ¨¡å¼)
        // ===================================

        window.loadTOCEntriesLocal = () => {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    window.tocItems = JSON.parse(stored);
                } else {
                    window.tocItems = [];
                }
                // æ ¹æ“š timestamp æ’åº (ç¢ºä¿é †åº)
                window.tocItems.sort((a, b) => a.timestamp - b.timestamp);

                // å‘¼å«å…¨åŸŸæ¸²æŸ“å‡½æ•¸
                window.renderTOCList(window.tocItems);
                window.renderTOCPreview(window.tocItems);
            } catch (e) {
                console.error("è¼‰å…¥æœ¬åœ°å­˜å„²éŒ¯èª¤:", e);
                window.tocItems = [];
            }
        };

        window.saveTOCEntriesLocal = () => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(window.tocItems));
            } catch (e) {
                console.error("ä¿å­˜æœ¬åœ°å­˜å„²éŒ¯èª¤:", e);
            }
        };

        window.addTOCEntryLocal = (text, page, level) => {
            const newEntry = {
                id: 'local-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                text,
                page: String(page || ''),
                level,
                timestamp: Date.now()
            };
            window.tocItems.push(newEntry);
            window.tocItems.sort((a, b) => a.timestamp - b.timestamp);
            window.saveTOCEntriesLocal();
            window.renderTOCList(window.tocItems);
            window.renderTOCPreview(window.tocItems);
            console.log("æœ¬åœ°æ¢ç›®æ–°å¢æˆåŠŸã€‚");
        };

        window.deleteTOCEntryLocal = (id) => {
            const index = window.tocItems.findIndex(item => item.id === id);
            if (index !== -1) {
                window.tocItems.splice(index, 1);
                window.saveTOCEntriesLocal();
                window.renderTOCList(window.tocItems);
                window.renderTOCPreview(window.tocItems);
                console.log("æœ¬åœ°æ¢ç›®åˆªé™¤æˆåŠŸã€‚ID:", id);
            }
        };

        window.updateTOCEntryLocal = (id, text, page, level) => {
            const item = window.tocItems.find(i => i.id === id);
            if (item) {
                item.text = text;
                item.page = String(page || '');
                item.level = level;
                window.saveTOCEntriesLocal();
                window.renderTOCList(window.tocItems);
                window.renderTOCPreview(window.tocItems);
                console.log("æœ¬åœ°æ¢ç›®æ›´æ–°æˆåŠŸã€‚ID:", id);
                if (typeof showMessage === 'function') {
                    showMessage('âœ… æ¢ç›®å·²æˆåŠŸç·¨è¼¯ï¼', 'bg-green-100 text-green-800');
                }
            } else {
                console.error("æ‰¾ä¸åˆ°è¦æ›´æ–°çš„æ¢ç›®ã€‚ID:", id);
                if (typeof showMessage === 'function') {
                    showMessage('âŒ æ‰¾ä¸åˆ°è¦ç·¨è¼¯çš„æ¢ç›®ã€‚', 'bg-red-100 text-red-800');
                }
            }
        };

        window.insertNewTOCEntryLocal = (afterId, text, page, level) => {
            const afterIndex = window.tocItems.findIndex(item => item.id === afterId);
            if (afterIndex !== -1) {
                const afterItem = window.tocItems[afterIndex];
                const nextItem = afterIndex + 1 < window.tocItems.length ? window.tocItems[afterIndex + 1] : null;

                let newTimestamp;
                if (nextItem) {
                    newTimestamp = Math.floor((afterItem.timestamp + nextItem.timestamp) / 2);
                } else {
                    newTimestamp = Date.now();
                }

                const newEntry = {
                    id: 'local-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    text,
                    page: String(page || ''),
                    level,
                    timestamp: newTimestamp
                };

                window.tocItems.push(newEntry);
                window.tocItems.sort((a, b) => a.timestamp - b.timestamp);
                window.saveTOCEntriesLocal();
                window.renderTOCList(window.tocItems);
                window.renderTOCPreview(window.tocItems);
                console.log("æœ¬åœ°æ–°æ¢ç›®æ’å…¥æˆåŠŸã€‚");
                if (typeof showMessage === 'function') {
                    showMessage('âœ… æ–°é …ç›®å·²æˆåŠŸæ’å…¥ï¼', 'bg-green-100 text-green-800');
                }
            }
        };


        // ===================================
        // è³‡æ–™åº«æ“ä½œå‡½æ•¸ (éœ€ä¾è³´åœ¨ module å€å¡Šå…§)
        // ===================================

        window.loadTOCEntries = () => {
            if (!window.tocCollectionRef || !db) {
                console.warn("Firestore é›†åˆæœªæº–å‚™å¥½æˆ–è³‡æ–™åº«æœªåˆå§‹åŒ–ã€‚ç„¡æ³•è¼‰å…¥è³‡æ–™ã€‚");
                return;
            }

            // ä½¿ç”¨ onSnapshot ç›£è½è³‡æ–™è®ŠåŒ–
            const q = query(window.tocCollectionRef);

            onSnapshot(q, (snapshot) => {
                window.tocItems.length = 0; // æ¸…ç©ºèˆŠè³‡æ–™
                snapshot.forEach(doc => {
                    const data = doc.data();
                    window.tocItems.push({
                        id: doc.id,
                        level: data.level,
                        text: data.text,
                        page: String(data.page || ''),
                        timestamp: data.timestamp
                    });
                });

                // æ ¹æ“š timestamp æ’åº (ç¢ºä¿é †åº)
                window.tocItems.sort((a, b) => a.timestamp - b.timestamp);

                // å‘¼å«å…¨åŸŸæ¸²æŸ“å‡½æ•¸
                window.renderTOCList(window.tocItems);
                window.renderTOCPreview(window.tocItems);
            }, (error) => {
                console.error("ç›£è½ Firestore éŒ¯èª¤:", error);
                document.getElementById('status-message').textContent = `è³‡æ–™è¼‰å…¥éŒ¯èª¤: ${error.message}`;
            });
        };

        window.addTOCEntry = async (text, page, level) => {
            if (!window.tocCollectionRef) return;
            try {
                await addDoc(window.tocCollectionRef, {
                    text,
                    page: String(page || ''),
                    level,
                    timestamp: Date.now()
                });
                console.log("ç›®éŒ„æ¢ç›®æ–°å¢æˆåŠŸã€‚");
            } catch (e) {
                console.error("æ–°å¢æ¢ç›®æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
            }
        };

        window.deleteTOCEntry = async (id) => {
            if (!window.tocCollectionRef) return;
            try {
                const docRef = doc(window.tocCollectionRef, id);
                await deleteDoc(docRef);
                console.log("ç›®éŒ„æ¢ç›®åˆªé™¤æˆåŠŸã€‚ID:", id);
            } catch (e) {
                console.error("åˆªé™¤æ¢ç›®æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
            }
        };

        // æ›´æ–°æ¢ç›®
        window.updateTOCEntry = async (id, text, page, level) => {
            if (!window.tocCollectionRef) return;
            try {
                const docRef = doc(window.tocCollectionRef, id);
                await updateDoc(docRef, {
                    text,
                    page: String(page || ''),
                    level
                });
                console.log("ç›®éŒ„æ¢ç›®æ›´æ–°æˆåŠŸã€‚ID:", id);
                showMessage('âœ… æ¢ç›®å·²æˆåŠŸç·¨è¼¯ï¼', 'bg-green-100 text-green-800');
            } catch (e) {
                console.error("ç·¨è¼¯æ¢ç›®æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                showMessage('âŒ ç·¨è¼¯æ¢ç›®å¤±æ•—ã€‚', 'bg-red-100 text-red-800');
            }
        };

        // åœ¨æŒ‡å®šæ¢ç›®å¾Œæ’å…¥æ–°æ¢ç›®
        window.insertNewTOCEntry = async (afterId, text, page, level) => {
            if (!window.tocCollectionRef) return;
            try {
                // æ‰¾åˆ° afterId æ¢ç›®çš„ timestamp
                const afterItem = window.tocItems.find(item => item.id === afterId);
                if (!afterItem) {
                    showMessage('âŒ æ‰¾ä¸åˆ°åƒè€ƒæ¢ç›®ã€‚', 'bg-red-100 text-red-800');
                    return;
                }

                // æ–°æ¢ç›®çš„ timestamp ä»‹æ–¼ afterItem å’Œä¸‹ä¸€å€‹æ¢ç›®ä¹‹é–“
                const afterIndex = window.tocItems.findIndex(item => item.id === afterId);
                const nextItem = afterIndex + 1 < window.tocItems.length ? window.tocItems[afterIndex + 1] : null;

                let newTimestamp;
                if (nextItem) {
                    // ä»‹æ–¼å…©è€…ä¹‹é–“
                    newTimestamp = Math.floor((afterItem.timestamp + nextItem.timestamp) / 2);
                } else {
                    // åœ¨æœ€å¾Œï¼Œä½¿ç”¨ç•¶å‰æ™‚é–“
                    newTimestamp = Date.now();
                }

                await addDoc(window.tocCollectionRef, {
                    text,
                    page: String(page || ''),
                    level,
                    timestamp: newTimestamp
                });
                console.log("æ–°æ¢ç›®æ’å…¥æˆåŠŸã€‚");
                showMessage('âœ… æ–°é …ç›®å·²æˆåŠŸæ’å…¥ï¼', 'bg-green-100 text-green-800');
            } catch (e) {
                console.error("æ’å…¥æ¢ç›®æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                showMessage('âŒ æ’å…¥æ¢ç›®å¤±æ•—ã€‚', 'bg-red-100 text-red-800');
            }
        };

        // æ•´é«”é ç¢¼èª¿æ•´å‡½æ•¸ (å¾æŒ‡å®š ID é–‹å§‹èª¿æ•´å¾ŒçºŒé ç¢¼)
        window.adjustPageNumbers = async (startId, newPageString) => {
            if (!window.tocCollectionRef || !db) {
                showMessage('âŒ è³‡æ–™åº«æœªæº–å‚™å¥½ã€‚', 'bg-red-100 text-red-800');
                return;
            }

            const newPage = parseInt(newPageString);
            if (isNaN(newPage) || newPage < 1) {
                showMessage('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„èµ·å§‹é ç¢¼ (>= 1)ã€‚', 'bg-red-100 text-red-800');
                return;
            }

            // 1. æ‰¾åˆ°èµ·å§‹æ¢ç›®åŠå…¶åœ¨æ’åºåˆ—è¡¨ä¸­çš„ä½ç½®
            const startIndex = window.tocItems.findIndex(item => item.id === startId);
            if (startIndex === -1) {
                showMessage('âŒ æ‰¾ä¸åˆ°è¦èª¿æ•´çš„æ¢ç›®ã€‚', 'bg-red-100 text-red-800');
                return;
            }
            const startItem = window.tocItems[startIndex];

            const oldPageString = startItem.page;
            const oldPage = oldPageString ? parseInt(oldPageString) : 0;

            if (isNaN(oldPage) && oldPageString !== '') {
                showMessage('âŒ èµ·å§‹æ¢ç›®çš„é ç¢¼ç„¡æ•ˆï¼Œè«‹å…ˆæ‰‹å‹•ä¿®æ­£æˆ–æ¸…ç©ºé ç¢¼ã€‚', 'bg-red-100 text-red-800');
                return;
            }

            // è¨ˆç®—é ç¢¼å·®ç•° (Offset): æ–°é ç¢¼ - (èˆŠé ç¢¼æˆ– 0 å¦‚æœèˆŠé ç¢¼ç‚ºç©º)
            const offset = newPage - (oldPageString ? oldPage : 0);

            if (offset === 0 && oldPageString === String(newPage)) {
                showMessage('â„¹ï¸ é ç¢¼ç„¡è®ŠåŒ–ï¼Œç„¡éœ€èª¿æ•´ã€‚', 'bg-blue-100 text-blue-800');
                return;
            }

            showMessage('â³ æ­£åœ¨åŸ·è¡Œé ç¢¼èª¿æ•´...', 'bg-yellow-100 text-yellow-800');
            const batch = writeBatch(db);

            let updatedCount = 0;

            // 2. è¿­ä»£æ‰€æœ‰æ¢ç›® (å¾èµ·å§‹æ¢ç›®é–‹å§‹)
            for (let i = startIndex; i < window.tocItems.length; i++) {
                const item = window.tocItems[i];
                const docRef = doc(window.tocCollectionRef, item.id);

                // èµ·å§‹æ¢ç›®ï¼šç›´æ¥è¨­å®šç‚ºæ–°é ç¢¼
                if (i === startIndex) {
                    batch.update(docRef, { page: String(newPage) });
                    updatedCount++;
                    continue;
                }

                // å¾ŒçºŒæ¢ç›®ï¼šè¨ˆç®—æ–°é ç¢¼
                const currentPageString = item.page;

                // åªæœ‰ç•¶ç•¶å‰æ¢ç›®æœ‰æœ‰æ•ˆé ç¢¼æ™‚æ‰é€²è¡Œåç§»
                if (currentPageString) {
                    const currentPage = parseInt(currentPageString);
                    if (!isNaN(currentPage)) {
                        let newCalculatedPage = currentPage + offset;

                        // ç¢ºä¿é ç¢¼è‡³å°‘ç‚º 1
                        if (newCalculatedPage < 1) {
                            newCalculatedPage = 1;
                        }

                        // æ‰¹é‡æ›´æ–° Firestore
                        batch.update(docRef, { page: String(newCalculatedPage) });
                        updatedCount++;
                    }
                }
            }

            // 3. æäº¤æ‰¹é‡å¯«å…¥
            try {
                await batch.commit();
                showMessage(`âœ… é ç¢¼èª¿æ•´æˆåŠŸï¼å…±æ›´æ–° ${updatedCount} å€‹æ¢ç›®ã€‚`, 'bg-green-100 text-green-800');
            } catch (e) {
                console.error("æ‰¹é‡æ›´æ–°é ç¢¼æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                showMessage('âŒ æ‰¹é‡æ›´æ–°é ç¢¼å¤±æ•—ã€‚', 'bg-red-100 text-red-800');
            }
        };


        // ===================================
        // åˆå§‹åŒ–é‚è¼¯
        // ===================================

        // æª¢æŸ¥ Firebase é…ç½®ä¸¦åˆå§‹åŒ–
        if (!firebaseConfig) {
            console.error("Firebase é…ç½®æœªå®šç¾©ã€‚ç„¡æ³•å•Ÿå‹•è³‡æ–™åº«åŠŸèƒ½ã€‚");
            document.getElementById('status-message').textContent = 'éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ï¼Œè³‡æ–™ç„¡æ³•å„²å­˜ã€‚';
        } else {
            // åˆå§‹åŒ– Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        }

        // ç›£è½èªè­‰ç‹€æ…‹ (åƒ…åœ¨ auth å­˜åœ¨æ™‚åŸ·è¡Œ)
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // å¦‚æœæ²’æœ‰ç™»å…¥ï¼Œå˜—è©¦ä½¿ç”¨åˆå§‹ token æˆ–åŒ¿åç™»å…¥
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            userId = auth.currentUser.uid;
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                    } catch (error) {
                        console.error("èªè­‰å¤±æ•—:", error);
                        // å¦‚æœç™»å…¥å¤±æ•—ï¼Œåˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼
                        window.isOfflineMode = true;
                        userId = 'offline-' + crypto.randomUUID();
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = `ä½¿ç”¨è€… ID: ${userId} (é›¢ç·šæ¨¡å¼ - èªè­‰å¤±æ•—)`;
                        document.getElementById('status-message').textContent = 'èªè­‰å¤±æ•—ï¼Œå·²åˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼ï¼šæ•¸æ“šä¿å­˜åœ¨æœ¬åœ°ç€è¦½å™¨ä¸­';
                        window.loadTOCEntriesLocal();
                        return;
                    }
                }
                isAuthReady = true;
                console.log("Firebase èªè­‰å®Œæˆã€‚User ID:", userId);
                document.getElementById('user-id-display').textContent = `ä½¿ç”¨è€… ID: ${userId}`;

                // è¨­å®š Firestore é›†åˆè·¯å¾‘
                window.tocCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/toc_entries`);

                // è¼‰å…¥è³‡æ–™
                window.loadTOCEntries();
                document.getElementById('status-message').textContent = 'è³‡æ–™åº«å·²é€£ç·šï¼Œæº–å‚™å°±ç·’ã€‚';
            });
        } else {
            // ç„¡ Firebase/auth æ™‚çš„ fallback ç‹€æ…‹ - å•Ÿç”¨é›¢ç·šæ¨¡å¼
            window.isOfflineMode = true;
            isAuthReady = true;
            userId = 'offline-' + crypto.randomUUID();
            console.log("é€²å…¥é›¢ç·šæ¨¡å¼ã€‚ä½¿ç”¨æœ¬åœ°å­˜å„²ä¿å­˜æ•¸æ“šã€‚User ID:", userId);
            document.getElementById('user-id-display').textContent = `ä½¿ç”¨è€… ID: ${userId} (é›¢ç·šæ¨¡å¼ - æœ¬åœ°å­˜å„²)`;
            document.getElementById('status-message').textContent = 'é›¢ç·šæ¨¡å¼ï¼šæ•¸æ“šä¿å­˜åœ¨æœ¬åœ°ç€è¦½å™¨ä¸­';

            // åŠ è¼‰æœ¬åœ°å­˜å„²çš„æ•¸æ“š
            window.loadTOCEntriesLocal();
        }

        // åœ¨çª—å£è¼‰å…¥å¾Œéš±è—æµ®æ°´å°
        window.addEventListener('load', function() {
            document.getElementById('watermark').style.display = 'none';
        });

    </script>
</body>
</html>
