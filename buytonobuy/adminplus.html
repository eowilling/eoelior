<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½‰ç›¤å¾Œå°ç®¡ç†</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .color-picker {
            width: 50px;
            height: 50px;
            border: 2px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 font-sans">
    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">è½‰ç›¤å¾Œå°ç®¡ç†ï¼ˆå®Œæ•´æ¬Šé™ï¼‰</h1>
            <div class="flex gap-4">
                <a href="admin.html" class="text-sm text-gray-500 hover:text-gray-700 underline">è¡¨é¢è¨­å®š</a>
                <a href="buyROnobuy.html" class="text-blue-600 hover:text-blue-800 underline">è¿”å›è½‰ç›¤</a>
            </div>
        </div>

        <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
            <p class="text-sm text-yellow-800">
                <strong>èªªæ˜ï¼š</strong><br>
                â€¢ <strong>è¦–è¦ºé¢ç©</strong>ï¼šè½‰ç›¤ä¸Šé¡¯ç¤ºçš„æ‰‡å€å¤§å°æ¯”ä¾‹ï¼ˆç”¨æˆ¶çœ‹åˆ°çš„ï¼‰<br>
                â€¢ <strong>çœŸå¯¦æ©Ÿç‡</strong>ï¼šå¯¦éš›è½‰ç›¤åœæ­¢åœ¨å„é¸é …çš„æ©Ÿç‡ï¼ˆéš±è—çš„å¯¦éš›æ§åˆ¶ï¼‰<br>
                â€¢ <strong>è‡ªå‹•è¨ˆç®—</strong>ï¼šèª¿æ•´ä»»ä¸€é¸é …çš„ç™¾åˆ†æ¯”æ™‚ï¼Œå…¶ä»–é¸é …æœƒè‡ªå‹•æŒ‰æ¯”ä¾‹èª¿æ•´ï¼Œç¸½å’Œä¿æŒ 100%<br>
                â€¢ ä¾‹å¦‚ï¼šè¦–è¦ºä¸Š 50:50ï¼Œä½†çœŸå¯¦æ©Ÿç‡å¯ä»¥è¨­ç‚º 80:20ï¼Œé€™æ¨£ã€Œè²·ã€çš„æ©Ÿç‡æœƒæ›´é«˜
            </p>
        </div>

        <!-- æ¨™é¡Œå’Œèªªæ˜è¨­å®š -->
        <div class="mb-6 p-4 border-2 border-gray-200 rounded-lg bg-white">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">è½‰ç›¤æ¨™é¡Œèˆ‡èªªæ˜</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è½‰ç›¤æ¨™é¡Œ</label>
                    <input type="text" id="wheelTitle" class="w-full px-3 py-2 border border-gray-300 rounded"
                           placeholder="ä¾‹å¦‚ï¼šå‘½é‹è¼ªç›¤">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è½‰ç›¤èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
                    <textarea id="wheelDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded"
                              placeholder="ä¾‹å¦‚ï¼šè½‰å‹•è¼ªç›¤ï¼Œçœ‹çœ‹ä½ çš„é‹æ°£å¦‚ä½•..."></textarea>
                </div>
            </div>
        </div>

        <div id="segmentsContainer" class="space-y-4 mb-6">
            <!-- é¸é …å°‡å‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>

        <div class="flex gap-4 mb-6 flex-wrap">
            <button id="addSegmentBtn"
                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                + æ–°å¢é¸é …
            </button>
            <button id="saveBtn"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                å„²å­˜è¨­å®š
            </button>
            <button id="shareBtn"
                    class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                ğŸ“¤ åˆ†äº«è½‰ç›¤
            </button>
            <button id="resetBtn"
                    class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                é‡ç½®ç‚ºé è¨­å€¼
            </button>
        </div>

        <!-- åˆ†äº«å½ˆçª— -->
        <div id="shareModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 md:p-8 max-w-md w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">åˆ†äº«è½‰ç›¤</h2>
                    <button id="closeShareModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <p class="text-gray-600 mb-4">è¤‡è£½ä»¥ä¸‹é€£çµåˆ†äº«çµ¦å…¶ä»–äººï¼Œä»–å€‘æ‰“é–‹å¾Œæœƒçœ‹åˆ°ç›¸åŒçš„è½‰ç›¤è¨­å®šï¼š</p>
                <div class="mb-4">
                    <input type="text" id="shareUrl" readonly
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm mb-2">
                    <div class="flex items-center gap-2">
                        <button id="shortenUrlBtn"
                                class="px-3 py-1 bg-purple-500 text-white text-sm rounded hover:bg-purple-600 transition">
                            ğŸ”— ç¸®çŸ­é€£çµ
                        </button>
                        <span id="shorteningStatus" class="text-xs text-gray-500 hidden">æ­£åœ¨ç¸®çŸ­é€£çµ...</span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="copyShareUrlBtn"
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        ğŸ“‹ è¤‡è£½é€£çµ
                    </button>
                    <button id="openShareUrlBtn"
                            class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        ğŸ”— é–‹å•Ÿé€£çµ
                    </button>
                </div>
                <div id="copySuccessMsg" class="mt-3 text-green-600 text-sm hidden">
                    âœ“ é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼
                </div>
            </div>
        </div>

        <div id="previewSection" class="mt-8 p-4 bg-gray-100 rounded-lg">
            <h2 class="text-xl font-bold mb-4">é è¦½è³‡è¨Š</h2>
            <div id="previewInfo" class="text-sm text-gray-700">
                <!-- é è¦½è³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
        </div>
    </div>

    <script>
        // é è¨­é…ç½®
        const defaultConfig = {
            title: "å‘½é‹è¼ªç›¤",
            description: "",
            segments: [
                { label: "è²·", color: '#10b981', visualPercent: 50, realPercent: 80 },
                { label: "ä¸å¥½", color: '#ef4444', visualPercent: 50, realPercent: 20 }
            ]
        };

        // é è¨­é¡è‰²é¸é …
        const defaultColors = [
            '#10b981', '#ef4444', '#fcd34d', '#3b82f6',
            '#8b5cf6', '#ec4899', '#f59e0b', '#06b6d4'
        ];

        // è¼‰å…¥é…ç½®
        function loadConfig() {
            const saved = localStorage.getItem('wheelConfig');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('è¼‰å…¥é…ç½®å¤±æ•—', e);
                }
            }
            return JSON.parse(JSON.stringify(defaultConfig)); // æ·±æ‹·è²
        }

        // å„²å­˜é…ç½®
        function saveConfig(configToSave) {
            // æš«æ™‚æ¨™è¨˜ç‚ºå„²å­˜ä¸­ï¼Œé¿å…è§¸ç™¼åŒæ­¥æª¢æŸ¥
            isEditing = true;

            localStorage.setItem('wheelConfig', JSON.stringify(configToSave));
            config = configToSave; // æ›´æ–°ç•¶å‰é…ç½®

            // è§¸ç™¼è‡ªå®šç¾©äº‹ä»¶ä»¥åœ¨åŒä¸€é é¢å…§åŒæ­¥ï¼ˆä½†ä¸é‡æ–°æ¸²æŸ“ï¼‰
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'wheelConfig',
                newValue: JSON.stringify(configToSave),
                storageArea: localStorage
            }));

            updatePreview();

            // 0.5ç§’å¾Œæ¢å¾©ç·¨è¼¯ç‹€æ…‹æª¢æŸ¥
            setTimeout(() => {
                isEditing = false;
            }, 500);

            alert('è¨­å®šå·²å„²å­˜ï¼');
        }

        let config = loadConfig();
        const segmentsContainer = document.getElementById('segmentsContainer');
        const previewInfo = document.getElementById('previewInfo');
        const wheelTitleInput = document.getElementById('wheelTitle');
        const wheelDescriptionInput = document.getElementById('wheelDescription');

        // è¿½è¹¤ç”¨æˆ¶æ˜¯å¦æ­£åœ¨ç·¨è¼¯
        let isEditing = false;
        let editingTimer = null;

        // æ¨™è¨˜æ­£åœ¨ç·¨è¼¯
        function markEditing() {
            isEditing = true;
            if (editingTimer) clearTimeout(editingTimer);
            editingTimer = setTimeout(() => {
                isEditing = false;
            }, 1500); // 1.5ç§’æ²’æœ‰è¼¸å…¥æ“ä½œå¾Œèªç‚ºç·¨è¼¯å®Œæˆ
        }

        // è¼‰å…¥æ¨™é¡Œå’Œèªªæ˜åˆ°è¼¸å…¥æ¡†
        function loadTitleAndDescription() {
            wheelTitleInput.value = config.title || defaultConfig.title;
            wheelDescriptionInput.value = config.description || defaultConfig.description;
        }

        // æ›´æ–°æ¨™é¡Œå’Œèªªæ˜åˆ°é…ç½®
        function updateTitleAndDescription() {
            config.title = wheelTitleInput.value.trim() || defaultConfig.title;
            config.description = wheelDescriptionInput.value.trim();
        }

        // æ¨™é¡Œå’Œèªªæ˜è¼¸å…¥æ¡†äº‹ä»¶
        wheelTitleInput.addEventListener('input', () => {
            markEditing(); // æ¨™è¨˜ç‚ºæ­£åœ¨ç·¨è¼¯
            updateTitleAndDescription();
            updatePreview();
        });
        wheelDescriptionInput.addEventListener('input', () => {
            markEditing(); // æ¨™è¨˜ç‚ºæ­£åœ¨ç·¨è¼¯
            updateTitleAndDescription();
            updatePreview();
        });

        // å‰µå»ºé¸é …è¡¨å–®
        function createSegmentForm(index, segment) {
            const div = document.createElement('div');
            div.className = 'p-4 border-2 border-gray-200 rounded-lg bg-white';
            div.dataset.index = index;

            div.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">é¸é … ${index + 1}</h3>
                    <button class="remove-segment-btn px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition">
                        åˆªé™¤
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é¸é …åç¨±</label>
                        <input type="text" class="segment-label w-full px-3 py-2 border border-gray-300 rounded"
                               value="${segment.label}" placeholder="ä¾‹å¦‚ï¼šè²·">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é¡è‰²</label>
                        <div class="flex items-center gap-2">
                            <input type="color" class="segment-color" value="${segment.color}">
                            <input type="text" class="segment-color-text w-24 px-2 py-2 border border-gray-300 rounded text-sm"
                                   value="${segment.color}" placeholder="#10b981">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            è¦–è¦ºé¢ç© (%)
                            <span class="text-xs text-gray-500">ï¼ˆè½‰ç›¤é¡¯ç¤ºçš„æ¯”ä¾‹ï¼‰</span>
                        </label>
                        <input type="number" class="segment-visual w-full px-3 py-2 border border-gray-300 rounded"
                               value="${segment.visualPercent}" min="1" max="100" step="1">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            çœŸå¯¦æ©Ÿç‡ (%)
                            <span class="text-xs text-gray-500">ï¼ˆå¯¦éš›åœæ­¢çš„æ©Ÿç‡ï¼‰</span>
                        </label>
                        <input type="number" class="segment-real w-full px-3 py-2 border border-gray-300 rounded"
                               value="${segment.realPercent}" min="0" max="100" step="1">
                    </div>
                </div>
            `;

            // ç¶å®šäº‹ä»¶
            const removeBtn = div.querySelector('.remove-segment-btn');
            removeBtn.addEventListener('click', () => {
                if (config.segments.length <= 2) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ 2 å€‹é¸é …ï¼');
                    return;
                }

                // æ¨™è¨˜ç‚ºæ­£åœ¨ç·¨è¼¯ï¼Œé¿å…é…ç½®åŒæ­¥å¹²æ“¾
                isEditing = true;

                // å¾é…ç½®ä¸­åˆªé™¤è©²é …ç›®
                const indexToRemove = parseInt(div.dataset.index);
                config.segments.splice(indexToRemove, 1);

                // é‡æ–°åˆ†é…ç™¾åˆ†æ¯”
                redistributePercentages();

                // ç«‹å³ä¿å­˜é…ç½®åˆ° localStorageï¼Œé˜²æ­¢è¢«åŒæ­¥æ©Ÿåˆ¶é‚„åŸ
                localStorage.setItem('wheelConfig', JSON.stringify(config));

                // é‡æ–°æ¸²æŸ“
                renderSegments();

                // 1ç§’å¾Œæ¢å¾©ç·¨è¼¯ç‹€æ…‹æª¢æŸ¥
                setTimeout(() => {
                    isEditing = false;
                }, 1000);
            });

            // é¡è‰²é¸æ“‡å™¨åŒæ­¥
            const colorInput = div.querySelector('.segment-color');
            const colorText = div.querySelector('.segment-color-text');
            colorInput.addEventListener('input', (e) => {
                markEditing(); // æ¨™è¨˜ç‚ºæ­£åœ¨ç·¨è¼¯
                colorText.value = e.target.value;
                updateConfigFromDOM();
                updatePreview();
            });
            colorText.addEventListener('input', (e) => {
                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                    markEditing(); // æ¨™è¨˜ç‚ºæ­£åœ¨ç·¨è¼¯
                    colorInput.value = e.target.value;
                    updateConfigFromDOM();
                    updatePreview();
                }
            });

            // é¸é …åç¨±è¼¸å…¥
            div.querySelector('.segment-label').addEventListener('input', () => {
                markEditing(); // æ¨™è¨˜ç‚ºæ­£åœ¨ç·¨è¼¯
                updateConfigFromDOM();
                updatePreview();
            });

            // è¦–è¦ºé¢ç©è¼¸å…¥ - è‡ªå‹•æŒ‰æ¯”ä¾‹èª¿æ•´å…¶ä»–é¸é …
            div.querySelector('.segment-visual').addEventListener('input', (e) => {
                markEditing(); // æ¨™è¨˜ç‚ºæ­£åœ¨ç·¨è¼¯
                const changedIndex = parseInt(div.dataset.index);
                const newValue = parseFloat(e.target.value) || 0;
                autoAdjustPercentages('visual', changedIndex, newValue);
                updatePreview();
            });

            // çœŸå¯¦æ©Ÿç‡è¼¸å…¥ - è‡ªå‹•æŒ‰æ¯”ä¾‹èª¿æ•´å…¶ä»–é¸é …
            div.querySelector('.segment-real').addEventListener('input', (e) => {
                markEditing(); // æ¨™è¨˜ç‚ºæ­£åœ¨ç·¨è¼¯
                const changedIndex = parseInt(div.dataset.index);
                const newValue = parseFloat(e.target.value) || 0;
                autoAdjustPercentages('real', changedIndex, newValue);
                updatePreview();
            });

            return div;
        }

        // å¾ DOM æ›´æ–°é…ç½®
        function updateConfigFromDOM() {
            updateTitleAndDescription();
            const segments = [];
            segmentsContainer.querySelectorAll('[data-index]').forEach((div, index) => {
                const label = div.querySelector('.segment-label').value || `é¸é …${index + 1}`;
                const color = div.querySelector('.segment-color').value;
                const visualPercent = parseFloat(div.querySelector('.segment-visual').value) || 0;
                const realPercent = parseFloat(div.querySelector('.segment-real').value) || 0;

                segments.push({
                    label: label,
                    color: color,
                    visualPercent: visualPercent,
                    realPercent: realPercent
                });
            });
            config.segments = segments;
        }

        // è‡ªå‹•èª¿æ•´ç™¾åˆ†æ¯”ï¼Œä¿æŒç¸½å’Œç‚º 100%
        function autoAdjustPercentages(type, changedIndex, newValue) {
            updateConfigFromDOM();
            const segments = config.segments;

            if (segments.length < 2) return;

            // é™åˆ¶æ–°å€¼åœ¨åˆç†ç¯„åœå…§
            const minValue = 0;
            const maxValue = 100;
            const clampedValue = Math.max(minValue, Math.min(maxValue, newValue));

            // æ›´æ–°æ”¹è®Šçš„é¸é …
            segments[changedIndex][type === 'visual' ? 'visualPercent' : 'realPercent'] = clampedValue;

            // è¨ˆç®—å…¶ä»–é¸é …çš„ç¸½å’Œ
            const otherTotal = segments.reduce((sum, seg, idx) => {
                if (idx !== changedIndex) {
                    return sum + (type === 'visual' ? seg.visualPercent : seg.realPercent);
                }
                return sum;
            }, 0);

            // è¨ˆç®—å‰©é¤˜éœ€è¦åˆ†é…çš„ç™¾åˆ†æ¯”
            const remaining = 100 - clampedValue;

            if (remaining <= 0) {
                // å¦‚æœæ–°å€¼ >= 100ï¼Œå…¶ä»–é¸é …è¨­ç‚º 0
                segments.forEach((seg, idx) => {
                    if (idx !== changedIndex) {
                        seg[type === 'visual' ? 'visualPercent' : 'realPercent'] = 0;
                    }
                });
            } else if (otherTotal > 0) {
                // æŒ‰æ¯”ä¾‹åˆ†é…å‰©é¤˜çš„ç™¾åˆ†æ¯”
                segments.forEach((seg, idx) => {
                    if (idx !== changedIndex) {
                        const oldValue = type === 'visual' ? seg.visualPercent : seg.realPercent;
                        const ratio = oldValue / otherTotal;
                        const newValue = Math.round(remaining * ratio * 100) / 100; // ä¿ç•™å…©ä½å°æ•¸
                        seg[type === 'visual' ? 'visualPercent' : 'realPercent'] = Math.max(0, newValue);
                    }
                });

                // è™•ç†æµ®é»æ•¸èª¤å·®ï¼Œç¢ºä¿ç¸½å’Œç‚º 100%
                const currentTotal = segments.reduce((sum, seg) => {
                    return sum + (type === 'visual' ? seg.visualPercent : seg.realPercent);
                }, 0);
                const diff = 100 - currentTotal;

                // å°‡èª¤å·®åŠ åˆ°æœ€å¾Œä¸€å€‹éæ”¹è®Šçš„é¸é …
                if (Math.abs(diff) > 0.01) {
                    for (let i = segments.length - 1; i >= 0; i--) {
                        if (i !== changedIndex) {
                            segments[i][type === 'visual' ? 'visualPercent' : 'realPercent'] += diff;
                            break;
                        }
                    }
                }
            } else {
                // å¦‚æœå…¶ä»–é¸é …éƒ½æ˜¯ 0ï¼Œå¹³å‡åˆ†é…
                const avg = remaining / (segments.length - 1);
                segments.forEach((seg, idx) => {
                    if (idx !== changedIndex) {
                        seg[type === 'visual' ? 'visualPercent' : 'realPercent'] = Math.round(avg * 100) / 100;
                    }
                });
            }

            // æ›´æ–° DOM é¡¯ç¤º
            segmentsContainer.querySelectorAll('[data-index]').forEach((div, index) => {
                const visualInput = div.querySelector('.segment-visual');
                const realInput = div.querySelector('.segment-real');

                if (type === 'visual' && index !== changedIndex) {
                    visualInput.value = segments[index].visualPercent.toFixed(2);
                } else if (type === 'real' && index !== changedIndex) {
                    realInput.value = segments[index].realPercent.toFixed(2);
                } else if (type === 'visual' && index === changedIndex) {
                    visualInput.value = clampedValue.toFixed(2);
                } else if (type === 'real' && index === changedIndex) {
                    realInput.value = clampedValue.toFixed(2);
                }
            });
        }

        // æ¸²æŸ“æ‰€æœ‰é¸é …
        function renderSegments() {
            segmentsContainer.innerHTML = '';
            config.segments.forEach((segment, index) => {
                segmentsContainer.appendChild(createSegmentForm(index, segment));
            });
            updatePreview();
        }

        // æ›´æ–°é è¦½è³‡è¨Š
        function updatePreview() {
            updateConfigFromDOM();

            const visualTotal = config.segments.reduce((sum, s) => sum + s.visualPercent, 0);
            const realTotal = config.segments.reduce((sum, s) => sum + s.realPercent, 0);

            let html = '<div class="space-y-2">';
            const visualStatus = Math.abs(visualTotal - 100) < 0.01 ?
                '<span class="text-green-600">âœ“ å·²è‡ªå‹•èª¿æ•´ç‚º 100%</span>' :
                `<span class="text-red-600">${visualTotal.toFixed(2)}%ï¼ˆå»ºè­°èª¿æ•´ç‚º 100%ï¼‰</span>`;
            const realStatus = Math.abs(realTotal - 100) < 0.01 ?
                '<span class="text-green-600">âœ“ å·²è‡ªå‹•èª¿æ•´ç‚º 100%</span>' :
                `<span class="text-red-600">${realTotal.toFixed(2)}%ï¼ˆå»ºè­°èª¿æ•´ç‚º 100%ï¼‰</span>`;

            html += `<p><strong>è¦–è¦ºé¢ç©ç¸½å’Œï¼š</strong>${visualStatus}</p>`;
            html += `<p><strong>çœŸå¯¦æ©Ÿç‡ç¸½å’Œï¼š</strong>${realStatus}</p>`;
            html += '<div class="mt-4"><strong>è¦–è¦ºé¡¯ç¤ºï¼š</strong>';
            config.segments.forEach(s => {
                html += `<span class="inline-block px-3 py-1 rounded text-white mr-2" style="background-color: ${s.color}">${s.label} ${s.visualPercent.toFixed(2)}%</span>`;
            });
            html += '</div>';
            html += '<div class="mt-2"><strong>çœŸå¯¦æ©Ÿç‡ï¼š</strong>';
            config.segments.forEach(s => {
                html += `<span class="inline-block px-3 py-1 rounded text-white mr-2" style="background-color: ${s.color}">${s.label} ${s.realPercent.toFixed(2)}%</span>`;
            });
            html += '</div></div>';

            previewInfo.innerHTML = html;
        }

        // é‡æ–°åˆ†é…æ‰€æœ‰é¸é …çš„ç™¾åˆ†æ¯”ï¼Œä½¿ç¸½å’Œç‚º 100%
        function redistributePercentages() {
            const segmentCount = config.segments.length;

            if (segmentCount === 0) return;

            // å¹³å‡åˆ†é…è¦–è¦ºé¢ç©
            const avgVisual = 100 / segmentCount;

            // è¨ˆç®—å‰ n-1 å€‹é¸é …çš„ç¸½å’Œï¼ˆç”¨æ–¼è™•ç†æµ®é»æ•¸èª¤å·®ï¼‰
            let visualSum = 0;

            config.segments.forEach((seg, index) => {
                if (index === segmentCount - 1) {
                    // æœ€å¾Œä¸€å€‹é¸é …ï¼šä½¿ç”¨å‰©é¤˜çš„ç™¾åˆ†æ¯”ï¼Œç¢ºä¿ç¸½å’Œç‚º 100%
                    seg.visualPercent = Math.round((100 - visualSum) * 100) / 100;
                    // çœŸå¯¦æ©Ÿç‡ç­‰æ–¼è¦–è¦ºé¢ç©
                    seg.realPercent = seg.visualPercent;
                } else {
                    // å…¶ä»–é¸é …ï¼šå¹³å‡åˆ†é…
                    seg.visualPercent = Math.round(avgVisual * 100) / 100;
                    // çœŸå¯¦æ©Ÿç‡ç­‰æ–¼è¦–è¦ºé¢ç©
                    seg.realPercent = seg.visualPercent;
                    visualSum += seg.visualPercent;
                }
            });
        }

        // æ–°å¢é¸é …
        document.getElementById('addSegmentBtn').addEventListener('click', () => {
            // æ¨™è¨˜ç‚ºæ­£åœ¨ç·¨è¼¯ï¼Œé¿å…é…ç½®åŒæ­¥å¹²æ“¾
            isEditing = true;

            // å…ˆå¾ DOM æ›´æ–°ç•¶å‰é…ç½®ï¼ˆç¢ºä¿è®€å–æœ€æ–°çš„å€¼ï¼‰
            updateConfigFromDOM();

            // æ–°å¢é¸é …
            const newSegment = {
                label: `é¸é …${config.segments.length + 1}`,
                color: defaultColors[config.segments.length % defaultColors.length],
                visualPercent: 0, // å°‡åœ¨é‡æ–°åˆ†é…æ™‚è¨­ç½®
                realPercent: 0    // å°‡åœ¨é‡æ–°åˆ†é…æ™‚è¨­ç½®
            };
            config.segments.push(newSegment);

            // é‡æ–°åˆ†é…æ‰€æœ‰é¸é …çš„ç™¾åˆ†æ¯”ï¼ˆåŒ…æ‹¬æ–°é¸é …ï¼‰
            redistributePercentages();

            // ç«‹å³ä¿å­˜é…ç½®åˆ° localStorage
            localStorage.setItem('wheelConfig', JSON.stringify(config));

            // é‡æ–°æ¸²æŸ“ï¼Œé¡¯ç¤ºæ›´æ–°å¾Œçš„ç™¾åˆ†æ¯”
            renderSegments();

            // 1ç§’å¾Œæ¢å¾©ç·¨è¼¯ç‹€æ…‹æª¢æŸ¥
            setTimeout(() => {
                isEditing = false;
            }, 1000);
        });

        // å„²å­˜è¨­å®š
        document.getElementById('saveBtn').addEventListener('click', () => {
            updateConfigFromDOM();

            // é©—è­‰
            if (config.segments.length < 2) {
                alert('è‡³å°‘éœ€è¦ 2 å€‹é¸é …ï¼');
                return;
            }

            // ç¢ºä¿ç¸½å’Œç‚º 100%ï¼ˆè‡ªå‹•èª¿æ•´ï¼‰
            const visualTotal = config.segments.reduce((sum, s) => sum + s.visualPercent, 0);
            const realTotal = config.segments.reduce((sum, s) => sum + s.realPercent, 0);

            if (Math.abs(visualTotal - 100) > 0.01) {
                // æŒ‰æ¯”ä¾‹èª¿æ•´è¦–è¦ºé¢ç©
                const ratio = 100 / visualTotal;
                config.segments.forEach(seg => {
                    seg.visualPercent = Math.round(seg.visualPercent * ratio * 100) / 100;
                });
            }

            if (Math.abs(realTotal - 100) > 0.01) {
                // æŒ‰æ¯”ä¾‹èª¿æ•´çœŸå¯¦æ©Ÿç‡
                const ratio = 100 / realTotal;
                config.segments.forEach(seg => {
                    seg.realPercent = Math.round(seg.realPercent * ratio * 100) / 100;
                });
            }

            // å„²å­˜é…ç½®ï¼ˆæœƒè§¸ç™¼æ›´æ–°é è¦½ï¼‰
            saveConfig(config);
            // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºèª¿æ•´å¾Œçš„å€¼
            renderSegments();
        });

        // é‡ç½®ç‚ºé è¨­å€¼
        document.getElementById('resetBtn').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­å€¼å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰è‡ªè¨‚è¨­å®šã€‚')) {
                config = JSON.parse(JSON.stringify(defaultConfig));
                renderSegments();
            }
        });

        // åˆ†äº«åŠŸèƒ½
        function generateShareUrl() {
            try {
                updateConfigFromDOM();

                // ç¢ºä¿é…ç½®æœ‰æ•ˆ
                if (!config || !config.segments || config.segments.length === 0) {
                    throw new Error('é…ç½®ç„¡æ•ˆï¼Œç„¡æ³•ç”Ÿæˆåˆ†äº«é€£çµ');
                }

                // æº–å‚™è¦åˆ†äº«çš„é…ç½®ï¼ˆåŒ…å«è¦–è¦ºè¨­å®šå’ŒçœŸå¯¦æ©Ÿç‡ï¼‰
                const shareConfig = {
                    t: config.title || '',
                    d: config.description || '',
                    s: config.segments.map(seg => ({
                        l: seg.label || 'é¸é …',
                        c: seg.color || '#10b981',
                        v: Math.round((seg.visualPercent || 0) * 10) / 10,
                        r: Math.round((seg.realPercent || seg.visualPercent || 0) * 10) / 10 // çœŸå¯¦æ©Ÿç‡ï¼ˆrealPercentï¼‰
                    }))
                };

                // å°‡é…ç½®è½‰æ›ç‚ºç·Šæ¹ŠJSONï¼ˆç§»é™¤ç©ºæ ¼ï¼‰
                const configJson = JSON.stringify(shareConfig);

                // ä½¿ç”¨ Base64 ç·¨ç¢¼ï¼ˆæ”¯æŒä¸­æ–‡ç­‰ Unicode å­—ç¬¦ï¼‰
                // æ–¹æ³•ï¼šå°‡å­—ç¬¦ä¸²è½‰æ›ç‚º UTF-8 å­—ç¯€æ•¸çµ„ï¼Œç„¶å¾Œé€²è¡Œ Base64 ç·¨ç¢¼
                function utf8ToBase64(str) {
                    // æ–¹æ³•1ï¼šä½¿ç”¨ TextEncoderï¼ˆç¾ä»£ç€è¦½å™¨ï¼‰- æœ€å¯é çš„æ–¹æ³•
                    if (typeof TextEncoder !== 'undefined') {
                        try {
                            const encoder = new TextEncoder();
                            const bytes = encoder.encode(str);
                            // å°‡å­—ç¯€æ•¸çµ„è½‰æ›ç‚ºå­—ç¬¦ä¸²ä¾› btoa ä½¿ç”¨
                            let binary = '';
                            for (let i = 0; i < bytes.length; i++) {
                                binary += String.fromCharCode(bytes[i]);
                            }
                            return btoa(binary);
                        } catch (e) {
                            console.warn('TextEncoder æ–¹æ³•å¤±æ•—ï¼Œä½¿ç”¨é™ç´šæ–¹æ¡ˆ:', e);
                            // ç¹¼çºŒå˜—è©¦é™ç´šæ–¹æ¡ˆ
                        }
                    }

                    // æ–¹æ³•2ï¼šé™ç´šæ–¹æ¡ˆ - æ‰‹å‹•è™•ç† UTF-8 ç·¨ç¢¼
                    try {
                        // å°‡å­—ç¬¦ä¸²è½‰æ›ç‚º UTF-8 ç·¨ç¢¼çš„å­—ç¯€æ•¸çµ„
                        const utf8Str = encodeURIComponent(str);
                        // å°‡ %XX æ ¼å¼è½‰æ›ç‚ºå¯¦éš›å­—ç¯€
                        let binaryStr = '';
                        for (let i = 0; i < utf8Str.length; i++) {
                            if (utf8Str[i] === '%') {
                                const hex = utf8Str.substring(i + 1, i + 3);
                                binaryStr += String.fromCharCode(parseInt(hex, 16));
                                i += 2;
                            } else {
                                binaryStr += utf8Str[i];
                            }
                        }
                        return btoa(binaryStr);
                    } catch (e) {
                        console.warn('æ‰‹å‹• UTF-8 ç·¨ç¢¼å¤±æ•—ï¼Œä½¿ç”¨æœ€å¾Œé™ç´šæ–¹æ¡ˆ:', e);
                        // æ–¹æ³•3ï¼šæœ€å¾Œçš„é™ç´šæ–¹æ¡ˆï¼ˆä¸æ¨è–¦ï¼Œä½†ä½œç‚ºå¾Œå‚™ï¼‰
                        try {
                            return btoa(unescape(encodeURIComponent(str)));
                        } catch (e2) {
                            throw new Error('ç„¡æ³•ç·¨ç¢¼å­—ç¬¦ä¸²ç‚º Base64: ' + e2.message);
                        }
                    }
                }

                let configBase64 = utf8ToBase64(configJson).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

                // ç”Ÿæˆçµ•å°ç¶²å€çš„åˆ†äº«é€£çµ
                let shareUrl;
                try {
                    // ä½¿ç”¨ URL å°è±¡è™•ç†è·¯å¾‘ï¼Œç¢ºä¿ç”Ÿæˆçµ•å°ç¶²å€
                    const currentUrlObj = new URL(window.location.href);
                    // ç²å–ç›®éŒ„è·¯å¾‘
                    const pathParts = currentUrlObj.pathname.split('/').filter(p => p); // éæ¿¾ç©ºå­—ç¬¦ä¸²
                    // ç§»é™¤ç•¶å‰æ–‡ä»¶åï¼Œæ·»åŠ ç›®æ¨™æ–‡ä»¶å
                    pathParts[pathParts.length - 1] = 'buyROnobuy.html';
                    // é‡æ–°æ§‹å»ºè·¯å¾‘ï¼ˆç¢ºä¿ä»¥ / é–‹é ­ï¼‰
                    currentUrlObj.pathname = '/' + pathParts.join('/');
                    // æ¸…é™¤ç¾æœ‰çš„æŸ¥è©¢åƒæ•¸å’ŒéŒ¨é»ï¼Œæ·»åŠ æ–°çš„é…ç½®åƒæ•¸
                    currentUrlObj.search = `?c=${configBase64}`;
                    currentUrlObj.hash = '';
                    // ç”Ÿæˆå®Œæ•´çš„çµ•å°ç¶²å€
                    shareUrl = currentUrlObj.toString();
                } catch (e) {
                    // é™ç´šæ–¹æ¡ˆï¼šæ‰‹å‹•æ§‹å»ºçµ•å°ç¶²å€ï¼ˆå…¼å®¹èˆŠç€è¦½å™¨ï¼‰
                    const protocol = window.location.protocol; // http: æˆ– https:
                    const host = window.location.host; // domain.com:port
                    const currentPath = window.location.pathname;
                    const dirPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
                    // æ§‹å»ºå®Œæ•´çš„çµ•å°ç¶²å€
                    shareUrl = `${protocol}//${host}${dirPath}buyROnobuy.html?c=${configBase64}`;
                }

                return shareUrl;
            } catch (error) {
                console.error('ç”Ÿæˆåˆ†äº«é€£çµéŒ¯èª¤:', error);
                throw error;
            }
        }

        // çŸ­ç¸®URLåŠŸèƒ½
        async function shortenUrl(longUrl) {
            return await new Promise((resolve, reject) => {
                const callbackName = 'shortenUrlCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                window[callbackName] = function(data) {
                    try {
                        delete window[callbackName];
                        if (script && script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                    } catch (e) {}

                    if (data && data.shorturl) {
                        resolve(data.shorturl);
                    } else {
                        reject(new Error(data ? (data.errormessage || 'çŸ­ç¸®å¤±æ•—') : 'æœªçŸ¥éŒ¯èª¤'));
                    }
                };

                const script = document.createElement('script');
                script.src = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}&callback=${callbackName}`;

                script.onerror = () => {
                    try {
                        delete window[callbackName];
                        if (script && script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                    } catch (e) {}
                    reject(new Error('ç„¡æ³•é€£æ¥åˆ°çŸ­ç¸®æœå‹™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥'));
                };

                document.body.appendChild(script);

                setTimeout(() => {
                    if (window[callbackName]) {
                        try {
                            delete window[callbackName];
                            if (script && script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                        } catch (e) {}
                        reject(new Error('è«‹æ±‚è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦'));
                    }
                }, 8000);
            });
        }

        // é¡¯ç¤ºåˆ†äº«å½ˆçª—
        const shareBtn = document.getElementById('shareBtn');
        if (shareBtn) {
            shareBtn.addEventListener('click', () => {
                try {
                    updateConfigFromDOM();

                    if (!config.segments || config.segments.length < 2) {
                        alert('è‡³å°‘éœ€è¦ 2 å€‹é¸é …æ‰èƒ½åˆ†äº«ï¼');
                        return;
                    }

                    const visualTotal = config.segments.reduce((sum, s) => sum + (s.visualPercent || 0), 0);
                    if (Math.abs(visualTotal - 100) > 0.01) {
                        if (!confirm('è¦–è¦ºé¢ç©ç¸½å’Œä¸æ˜¯ 100%ï¼Œæ˜¯å¦ä»è¦åˆ†äº«ï¼Ÿ\nï¼ˆå»ºè­°å…ˆèª¿æ•´ç‚º 100%ï¼‰')) {
                            return;
                        }
                    }

                    const shareUrl = generateShareUrl();
                    const shareUrlInput = document.getElementById('shareUrl');
                    const shareModal = document.getElementById('shareModal');
                    const copySuccessMsg = document.getElementById('copySuccessMsg');
                    const shorteningStatus = document.getElementById('shorteningStatus');
                    const shortenUrlBtn = document.getElementById('shortenUrlBtn');

                    if (shareUrlInput) shareUrlInput.value = shareUrl;
                    if (shareModal) shareModal.classList.remove('hidden');
                    if (copySuccessMsg) copySuccessMsg.classList.add('hidden');
                    if (shorteningStatus) shorteningStatus.classList.add('hidden');
                    if (shortenUrlBtn) shortenUrlBtn.disabled = false;

                    // ä¿å­˜åˆ†äº«é€£çµåˆ° localStorageï¼ˆæ–¹ä¾¿ä¹‹å¾ŒæŸ¥çœ‹ï¼‰
                    try {
                        const savedLinks = JSON.parse(localStorage.getItem('wheelShareLinks') || '[]');
                        const linkInfo = {
                            url: shareUrl,
                            title: config.title || 'æœªå‘½åè½‰ç›¤',
                            date: new Date().toISOString(),
                            segments: config.segments.map(s => s.label).join(', ')
                        };
                        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„é€£çµï¼Œé¿å…é‡è¤‡
                        const exists = savedLinks.some(link => link.url === shareUrl);
                        if (!exists) {
                            savedLinks.unshift(linkInfo); // æ·»åŠ åˆ°é–‹é ­
                            // åªä¿ç•™æœ€è¿‘ 10 å€‹åˆ†äº«é€£çµ
                            if (savedLinks.length > 10) {
                                savedLinks.pop();
                            }
                            localStorage.setItem('wheelShareLinks', JSON.stringify(savedLinks));
                        }
                    } catch (e) {
                        console.warn('ä¿å­˜åˆ†äº«é€£çµå¤±æ•—:', e);
                    }
                } catch (error) {
                    console.error('åˆ†äº«åŠŸèƒ½éŒ¯èª¤:', error);
                    alert('åˆ†äº«åŠŸèƒ½ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                }
            });
        }

        // é—œé–‰åˆ†äº«å½ˆçª—
        document.getElementById('closeShareModal').addEventListener('click', () => {
            document.getElementById('shareModal').classList.add('hidden');
        });

        document.getElementById('shareModal').addEventListener('click', (e) => {
            if (e.target.id === 'shareModal') {
                document.getElementById('shareModal').classList.add('hidden');
            }
        });

        // è¤‡è£½é€£çµ
        document.getElementById('copyShareUrlBtn').addEventListener('click', async () => {
            const shareUrlInput = document.getElementById('shareUrl');
            shareUrlInput.select();
            shareUrlInput.setSelectionRange(0, 99999);

            try {
                await navigator.clipboard.writeText(shareUrlInput.value);
                document.getElementById('copySuccessMsg').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('copySuccessMsg').classList.add('hidden');
                }, 3000);
            } catch (err) {
                document.execCommand('copy');
                document.getElementById('copySuccessMsg').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('copySuccessMsg').classList.add('hidden');
                }, 3000);
            }
        });

        // çŸ­ç¸®é€£çµæŒ‰éˆ•
        document.getElementById('shortenUrlBtn').addEventListener('click', async () => {
            const shareUrlInput = document.getElementById('shareUrl');
            const longUrl = shareUrlInput.value;
            const shortenBtn = document.getElementById('shortenUrlBtn');
            const statusSpan = document.getElementById('shorteningStatus');

            if (!longUrl) {
                alert('è«‹å…ˆç”Ÿæˆåˆ†äº«é€£çµï¼');
                return;
            }

            if (longUrl.includes('is.gd/') || longUrl.includes('v.gd/')) {
                alert('é€£çµå·²ç¶“æ˜¯çŸ­ç¸®å¾Œçš„äº†ï¼');
                return;
            }

            try {
                shortenBtn.disabled = true;
                statusSpan.classList.remove('hidden');
                statusSpan.textContent = 'æ­£åœ¨ç¸®çŸ­é€£çµ...';

                const shortUrl = await shortenUrl(longUrl);
                shareUrlInput.value = shortUrl;
                statusSpan.textContent = 'âœ“ é€£çµå·²ç¸®çŸ­ï¼';
                statusSpan.classList.remove('hidden');
                statusSpan.classList.add('text-green-600');

                setTimeout(() => {
                    statusSpan.classList.add('hidden');
                    statusSpan.classList.remove('text-green-600');
                }, 3000);
            } catch (error) {
                statusSpan.textContent = 'âœ— çŸ­ç¸®å¤±æ•—ï¼Œè«‹ä½¿ç”¨åŸé€£çµ';
                statusSpan.classList.remove('hidden');
                statusSpan.classList.add('text-red-600');

                setTimeout(() => {
                    statusSpan.classList.add('hidden');
                    statusSpan.classList.remove('text-red-600');
                    statusSpan.textContent = 'æ­£åœ¨ç¸®çŸ­é€£çµ...';
                }, 3000);

                alert('é€£çµçŸ­ç¸®å¤±æ•—ï¼Œæ‚¨ä»å¯ä»¥ä½¿ç”¨åŸå§‹é€£çµé€²è¡Œåˆ†äº«ã€‚\néŒ¯èª¤ï¼š' + error.message);
            } finally {
                shortenBtn.disabled = false;
            }
        });

        // é–‹å•Ÿåˆ†äº«é€£çµ
        document.getElementById('openShareUrlBtn').addEventListener('click', () => {
            const shareUrl = document.getElementById('shareUrl').value;
            window.open(shareUrl, '_blank');
        });

        // ç›£è½é…ç½®è®ŠåŒ–ï¼ˆç•¶å…¶ä»–é é¢æ›´æ–°é…ç½®æ™‚ï¼‰
        window.addEventListener('storage', (e) => {
            if (e.key === 'wheelConfig' && !isEditing) {
                config = loadConfig();
                loadTitleAndDescription();
                renderSegments();
            }
        });

        // å®šæœŸæª¢æŸ¥é…ç½®è®ŠåŒ–ï¼ˆåŒé é¢å…§æ›´æ–°ï¼‰- åªåœ¨éç·¨è¼¯ç‹€æ…‹ä¸‹æª¢æŸ¥
        setInterval(() => {
            if (!isEditing) {
                const newConfig = loadConfig();
                if (JSON.stringify(newConfig) !== JSON.stringify(config)) {
                    config = newConfig;
                    loadTitleAndDescription();
                    renderSegments();
                }
            }
        }, 1000); // æ”¹ç‚º1ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œæ¸›å°‘é »ç‡

        // åˆå§‹åŒ–
        loadTitleAndDescription();
        renderSegments();
    </script>
</body>
</html>

