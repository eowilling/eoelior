<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eoElior | ç§˜å¯†è½‰ç›¤</title>
    <!-- Firebase é…ç½®ï¼ˆå¿…é ˆåœ¨ Firebase SDK ä¹‹å‰è¼‰å…¥ï¼‰ -->
    <script src="firebase-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        #wheelCanvas {
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4), 0 0 0 4px rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            transition: transform 3000ms cubic-bezier(0.17, 0.67, 0.12, 0.99);
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1), transparent);
        }
        .pointer {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 38px solid #ffffff;
            z-index: 20;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
        }
        .pointer::before {
            content: '';
            position: absolute;
            top: -38px;
            left: -14px;
            width: 0;
            height: 0;
            border-left: 14px solid transparent;
            border-right: 14px solid transparent;
            border-top: 24px solid #f1f5f9;
            z-index: 1;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4 flex flex-col items-center justify-center font-sans">

    <nav class="absolute top-0 w-full p-6 flex justify-between items-center">
        <a href="../index.html" class="text-slate-400 hover:text-white"><i class="fa-solid fa-arrow-left"></i> å›ç©å…·ç›’å­</a>
        <div class="flex items-center gap-4">
            <a href="admin.html" class="text-slate-400 hover:text-white text-sm">å¾Œå°ç®¡ç†</a>
            <div id="dbStatus" class="text-[10px] text-slate-500">æœªé€£ç·š</div>
        </div>
    </nav>

    <div class="max-w-7xl w-full grid grid-cols-1 lg:grid-cols-3 gap-8 mt-12">
        <!-- å·¦å´ï¼šè½‰ç›¤å€åŸŸ -->
        <div class="lg:col-span-2 glass-card p-8 rounded-3xl">
            <h2 id="wheelTitle" class="text-3xl font-bold mb-8 text-center cursor-pointer hover:text-indigo-400 transition-colors" title="é›™æ“Šé€²å…¥å®Œæ•´æ¬Šé™å¾Œå°">å‘½é‹è¼ªç›¤</h2>
            <p id="wheelDescription" class="text-center text-slate-400 mb-8" style="display: none;"></p>

            <div class="relative w-full max-w-[600px] aspect-square mx-auto mb-8">
                <div class="pointer"></div>
                <canvas id="wheelCanvas" width="800" height="800" class="w-full h-full"></canvas>
            </div>

            <div class="flex flex-col items-center space-y-4">
                <button id="spinBtn" class="bg-indigo-600 px-12 py-3 rounded-xl font-bold hover:bg-indigo-500 transition-all">é–‹å§‹æ—‹è½‰</button>
                <p id="resultDisplay" class="mt-4 text-indigo-300 font-bold h-6"></p>
            </div>

            <!-- ä¸­çæ©Ÿç‡è¡¨æ ¼ -->
            <div class="mt-8 pt-6 border-t border-slate-700">
                <h3 class="text-lg font-semibold text-slate-300 mb-4 text-center">ä¸­çæ©Ÿç‡</h3>
                <div class="overflow-x-auto">
                    <table id="optionsDisplay" class="w-full border-collapse">
                        <thead>
                            <tr class="bg-slate-800/50">
                                <th class="border border-slate-600 px-4 py-2 text-left text-slate-300">é¸é …</th>
                                <th class="border border-slate-600 px-4 py-2 text-center text-slate-300">ä¸­çæ©Ÿç‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- é¸é …å°‡å‹•æ…‹é¡¯ç¤ºåœ¨é€™è£¡ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šè¨˜éŒ„æ˜ç´°å’Œé›²ç«¯åˆ†äº« -->
        <div class="space-y-6">
            <!-- è½‰ç›¤è¨˜éŒ„ -->
            <div class="glass-card p-6 rounded-3xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-300">è½‰ç›¤è¨˜éŒ„</h3>
                    <button id="resetHistoryBtn" class="px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition">é‡ç½®</button>
                </div>
                <div id="historyDisplay" class="space-y-2 max-h-[400px] overflow-y-auto">
                    <p class="text-slate-500 text-sm text-center py-4">å°šç„¡è¨˜éŒ„</p>
                </div>
            </div>

            <!-- é›²ç«¯åŒæ­¥åˆ†äº« -->
            <div class="glass-card p-6 rounded-3xl space-y-4">
                <h3 class="font-bold text-sm text-slate-400 uppercase tracking-widest">é›²ç«¯åŒæ­¥åˆ†äº«</h3>
                <button id="cloudShareBtn" class="w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-xl text-xs font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed">ç”Ÿæˆåˆ†äº«é€£çµ</button>
                <div id="shareArea" class="hidden space-y-2">
                    <input type="text" id="shareUrlInput" readonly class="w-full bg-black/40 border border-slate-700 rounded-lg px-3 py-2 text-[10px] text-indigo-300 focus:outline-none">
                    <button id="copyBtn" class="w-full bg-indigo-600/20 text-indigo-300 py-2 rounded-lg text-[10px] hover:bg-indigo-600/40">è¤‡è£½é€£çµ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // ğŸ” Firebase é…ç½® - å®‰å…¨å¤–éƒ¨æ³¨å…¥æ–¹å¼
        // ==========================================
        // æ–¹å¼ 1: åœ¨ HTML ä¸­é€šé <script> æ¨™ç±¤å®šç¾© __firebase_config
        // æ–¹å¼ 2: é€šéå¤–éƒ¨é…ç½®æ–‡ä»¶è¼‰å…¥ï¼ˆæ¨è–¦ï¼‰
        // æ–¹å¼ 3: å¦‚æœéƒ½æ²’æœ‰ï¼Œä½¿ç”¨é è¨­é…ç½®ï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼æ¸¬è©¦ï¼‰

        let firebaseConfig;
        let firebaseEnabled = false;

        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                // å¤–éƒ¨æ³¨å…¥çš„é…ç½®ï¼ˆæœ€å®‰å…¨ï¼‰
                firebaseConfig = typeof __firebase_config === 'string'
                    ? JSON.parse(__firebase_config)
                    : __firebase_config;
                firebaseEnabled = true;
            } else {
                // é è¨­é…ç½®ï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼ï¼Œç”Ÿç”¢ç’°å¢ƒæ‡‰ç§»é™¤ï¼‰
                console.warn('âš ï¸ æœªæª¢æ¸¬åˆ°å¤–éƒ¨ Firebase é…ç½®ï¼Œä½¿ç”¨é è¨­é…ç½®ï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼ï¼‰');
                firebaseConfig = {
                    projectId: "studio-2298218799-c99fe",
                    appId: "1:848457307119:web:d0c416db3468efb9ef5c1a",
                    apiKey: "AIzaSyDDgQUZH5N1IaNR2-CeOIHCQjccsJEYD5s",
                    authDomain: "studio-2298218799-c99fe.firebaseapp.com",
                    messagingSenderId: "848457307119"
                };
                firebaseEnabled = true; // é–‹ç™¼æ¨¡å¼å•Ÿç”¨
            }
        } catch (e) {
            console.error('âŒ Firebase é…ç½®è§£æå¤±æ•—:', e);
            firebaseEnabled = false;
        }

        // Firebase æ‡‰ç”¨ç¨‹å¼è­˜åˆ¥ç¢¼
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'eoelior-wheel-data';

        // åˆå§‹åŒ– Firebaseï¼ˆå¦‚æœé…ç½®å¯ç”¨ï¼‰
        let app, auth, db;
        if (firebaseEnabled) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', e);
                firebaseEnabled = false;
            }
        }

        // ==========================================
        // ğŸ¡ è½‰ç›¤æ ¸å¿ƒé‚è¼¯
        // ==========================================

        // é è¨­é…ç½®
        const defaultConfig = {
            title: "å‘½é‹è¼ªç›¤",
            description: "",
            segments: [
                {label: "è²·", color: "#10b981", visualPercent: 50, realPercent: 80},
                {label: "ä¸è²·", color: "#ef4444", visualPercent: 50, realPercent: 20}
            ]
        };

        // å¾ URL åƒæ•¸è®€å–é…ç½®ï¼ˆæ”¯æ´å¾Œå°åˆ†äº«é€£çµï¼‰
        function loadConfigFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('c') || urlParams.get('config');

            if (configParam) {
                try {
                    // Base64 è½‰ UTF-8 çš„å‡½æ•¸
                    function base64ToUtf8(base64Str) {
                        const normalized = base64Str.replace(/-/g, '+').replace(/_/g, '/');
                        const padded = normalized + '='.repeat((4 - normalized.length % 4) % 4);
                        try {
                            const binaryString = atob(padded);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            const decoder = new TextDecoder('utf-8');
                            return decoder.decode(bytes);
                        } catch (e) {
                            try {
                                return decodeURIComponent(escape(atob(padded)));
                            } catch (e2) {
                                return atob(padded);
                            }
                        }
                    }

                    const configJson = base64ToUtf8(configParam);
                    const sharedConfig = JSON.parse(configJson);

                    // æ”¯æ´ç·Šæ¹Šæ ¼å¼å’Œå®Œæ•´æ ¼å¼
                    const config = {
                        title: sharedConfig.t || sharedConfig.title || defaultConfig.title,
                        description: sharedConfig.d || sharedConfig.description || defaultConfig.description,
                        segments: (sharedConfig.s || sharedConfig.segments || []).map(seg => ({
                            label: seg.l || seg.label,
                            color: seg.c || seg.color,
                            visualPercent: seg.v || seg.visualPercent,
                            realPercent: seg.r !== undefined ? seg.r : (seg.v || seg.visualPercent || seg.realPercent || 50)
                        }))
                    };

                    // ä¿å­˜åˆ° localStorage
                    saveConfig(config);
                    return config;
                } catch (e) {
                    console.error('å¾ URL è¼‰å…¥é…ç½®å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼', e);
                    return null;
                }
            }
            return null;
        }

        // å¾ localStorage è¼‰å…¥é…ç½®
        function loadConfig() {
            // å„ªå…ˆå¾ URL åƒæ•¸è®€å–
            const urlConfig = loadConfigFromUrl();
            if (urlConfig) {
                return urlConfig;
            }

            // å¦å‰‡å¾ localStorage è®€å–
            const saved = localStorage.getItem('wheelConfig');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('è¼‰å…¥é…ç½®å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼', e);
                }
            }
            return defaultConfig;
        }

        // å„²å­˜é…ç½®
        function saveConfig(config) {
            localStorage.setItem('wheelConfig', JSON.stringify(config));
        }

        // è¼‰å…¥é…ç½®
        let config = loadConfig();
        let currentRotation = 0;

        // æ›´æ–°æ¨™é¡Œå’Œèªªæ˜é¡¯ç¤º
        function updateTitleAndDescription() {
            const titleElement = document.getElementById('wheelTitle');
            const descriptionElement = document.getElementById('wheelDescription');

            if (titleElement) {
                titleElement.textContent = config.title || 'å‘½é‹è¼ªç›¤';
            }

            if (descriptionElement) {
                if (config.description && config.description.trim()) {
                    descriptionElement.textContent = config.description;
                    descriptionElement.style.display = 'block';
                } else {
                    descriptionElement.style.display = 'none';
                }
            }
        }

        // æ›´æ–°é¸é …é¡¯ç¤ºï¼ˆè¡¨æ ¼æ ¼å¼ï¼‰
        function updateOptionsDisplay() {
            const optionsDisplay = document.getElementById('optionsDisplay');
            if (!optionsDisplay) return;

            let html = '';
            config.segments.forEach(segment => {
                html += `
                    <tr>
                        <td class="border border-slate-600 px-4 py-2">
                            <span class="inline-block px-3 py-1 rounded text-white font-semibold text-sm" style="background-color: ${segment.color};">
                                ${segment.label}
                            </span>
                        </td>
                        <td class="border border-slate-600 px-4 py-2 text-center font-semibold text-slate-300">
                            ${segment.visualPercent.toFixed(1)}%
                        </td>
                    </tr>
                `;
            });
            const tbody = optionsDisplay.querySelector('tbody');
            if (tbody) {
                tbody.innerHTML = html;
            }
        }

        // ==========================================
        // ğŸ“ æ­·å²è¨˜éŒ„åŠŸèƒ½
        // ==========================================

        // è¼‰å…¥æ­·å²è¨˜éŒ„
        function loadHistory() {
            const saved = localStorage.getItem('wheelHistory');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—', e);
                }
            }
            return [];
        }

        // å„²å­˜æ­·å²è¨˜éŒ„
        function saveHistory(history) {
            localStorage.setItem('wheelHistory', JSON.stringify(history));
        }

        // æ·»åŠ è¨˜éŒ„
        function addHistoryRecord(label, color) {
            const history = loadHistory();
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            const dateStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;

            history.unshift({
                label: label,
                color: color,
                time: timeStr,
                date: dateStr,
                timestamp: now.getTime(),
                protected: false
            });

            // æœ€å¤šä¿ç•™ 100 ç­†è¨˜éŒ„ï¼ˆä¸åŒ…æ‹¬å—ä¿è­·çš„ï¼‰
            if (history.length > 100) {
                for (let i = history.length - 1; i >= 0; i--) {
                    if (!history[i].protected) {
                        history.splice(i, 1);
                        break;
                    }
                }
            }

            saveHistory(history);
            renderHistory();
        }

        // æ¸²æŸ“æ­·å²è¨˜éŒ„
        function renderHistory() {
            const history = loadHistory();
            const historyDisplay = document.getElementById('historyDisplay');

            if (history.length === 0) {
                historyDisplay.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">å°šç„¡è¨˜éŒ„</p>';
                return;
            }

            let html = '';
            history.forEach((record, index) => {
                const protectedClass = record.protected ? 'bg-yellow-900/20 border-yellow-600' : '';
                const protectIcon = record.protected ? 'âœ“' : 'â—‹';
                const protectColor = record.protected ? 'text-green-400' : 'text-slate-400';
                const deleteButtonClass = record.protected ? 'text-slate-500 cursor-not-allowed' : 'text-red-400 hover:text-red-300 hover:bg-red-900/20';

                html += `
                    <div class="p-3 border border-slate-600 rounded-lg hover:bg-slate-800/50 transition ${protectedClass}" data-index="${index}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="inline-block px-3 py-1 rounded text-white font-semibold text-sm" style="background-color: ${record.color};">
                                ${record.label}
                            </span>
                            <span class="text-xs text-slate-400">${record.date} ${record.time}</span>
                        </div>
                        <div class="flex items-center justify-end gap-2 mt-2">
                            <button class="protect-btn px-2 py-1 text-sm rounded transition ${protectColor} hover:bg-slate-700"
                                    data-index="${index}"
                                    title="${record.protected ? 'å–æ¶ˆä¿è­·' : 'ä¿è­·æ­¤è¨˜éŒ„'}">
                                ${protectIcon}
                            </button>
                            <button class="delete-btn px-2 py-1 text-sm rounded transition ${deleteButtonClass}"
                                    data-index="${index}"
                                    ${record.protected ? 'disabled title="å—ä¿è­·çš„è¨˜éŒ„ç„¡æ³•åˆªé™¤"' : 'title="åˆªé™¤æ­¤è¨˜éŒ„"'}>
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            });
            historyDisplay.innerHTML = html;

            // ç¶å®šäº‹ä»¶
            historyDisplay.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    deleteHistoryRecord(index);
                });
            });

            historyDisplay.querySelectorAll('.protect-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    toggleProtectRecord(index);
                });
            });
        }

        // åˆªé™¤å–®ç­†è¨˜éŒ„
        function deleteHistoryRecord(index) {
            const history = loadHistory();
            if (index >= 0 && index < history.length) {
                if (history[index].protected) {
                    alert('æ­¤è¨˜éŒ„å·²å—ä¿è­·ï¼Œç„¡æ³•åˆªé™¤ï¼');
                    return;
                }
                if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜éŒ„å—ï¼Ÿ')) {
                    history.splice(index, 1);
                    saveHistory(history);
                    renderHistory();
                }
            }
        }

        // åˆ‡æ›ä¿è­·ç‹€æ…‹
        function toggleProtectRecord(index) {
            const history = loadHistory();
            if (index >= 0 && index < history.length) {
                history[index].protected = !history[index].protected;
                saveHistory(history);
                renderHistory();
            }
        }

        // é‡ç½®æ­·å²è¨˜éŒ„
        function resetHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è½‰ç›¤è¨˜éŒ„å—ï¼Ÿ\nï¼ˆåŒ…æ‹¬å—ä¿è­·çš„è¨˜éŒ„ä¹Ÿæœƒè¢«æ¸…é™¤ï¼‰')) {
                localStorage.removeItem('wheelHistory');
                renderHistory();
            }
        }

        // æ›´æ–°é€£ç·šç‹€æ…‹é¡¯ç¤º
        function updateDbStatus(status, text) {
            const statusEl = document.getElementById('dbStatus');
            if (statusEl) {
                statusEl.innerText = text || status;
                statusEl.className = `text-[10px] ${
                    status === 'connected' ? 'text-emerald-400' :
                    status === 'connecting' ? 'text-yellow-400' :
                    'text-slate-500'
                }`;
            }
        }

        // åˆå§‹åŒ– Firebase èªè­‰
        async function initFirebase() {
            if (!firebaseEnabled || !auth) {
                updateDbStatus('disabled', 'æœªå•Ÿç”¨');
                console.warn('âš ï¸ Firebase æœªå•Ÿç”¨æˆ–æœªåˆå§‹åŒ–');
                return;
            }

            try {
                updateDbStatus('connecting', 'é€£ç·šä¸­...');
                console.log('ğŸ”„ é–‹å§‹ Firebase åŒ¿åèªè­‰...');

                // è¨­å®šèªè­‰ç‹€æ…‹ç›£è½å™¨ï¼ˆåœ¨å˜—è©¦ç™»å…¥ä¹‹å‰ï¼‰
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log('âœ… Firebase èªè­‰æˆåŠŸï¼ŒUID:', user.uid.substring(0, 8) + '...');
                        updateDbStatus('connected', 'é›²ç«¯å·²é€£ç·š');

                        // æª¢æŸ¥ URL åƒæ•¸æ˜¯å¦æœ‰åˆ†äº« ID
                        const params = new URLSearchParams(window.location.search);
                        const shareId = params.get('share');

                        if (shareId) {
                            try {
                                console.log('ğŸ“¥ è¼‰å…¥åˆ†äº«é…ç½®ï¼ŒID:', shareId);
                                const snap = await getDoc(
                                    doc(db, 'artifacts', APP_ID, 'public', 'data', 'shared_wheels', shareId)
                                );
                                if (snap.exists()) {
                                    const firebaseConfig = snap.data();
                                    config = firebaseConfig;
                                    // ä¿å­˜åˆ° localStorageï¼Œä»¥ä¾¿ä¹‹å¾Œä¹Ÿèƒ½ä½¿ç”¨
                                    saveConfig(config);
                                    updateTitleAndDescription();
                                    updateOptionsDisplay();
                                    drawWheel();
                                    console.log('âœ… Firebase åˆ†äº«é…ç½®è¼‰å…¥æˆåŠŸ');
                                } else {
                                    console.warn('âš ï¸ Firebase åˆ†äº«é…ç½®ä¸å­˜åœ¨');
                                }
                            } catch (e) {
                                console.error('âŒ è¼‰å…¥åˆ†äº«é…ç½®å¤±æ•—:', e);
                                if (e.code === 'permission-denied') {
                                    console.error('   åŸå› ï¼šFirestore å®‰å…¨è¦å‰‡æ‹’çµ•å­˜å–');
                                    console.error('   è§£æ±ºï¼šè«‹æª¢æŸ¥ Firestore è¦å‰‡æ˜¯å¦å…è¨±è®€å–');
                                }
                            }
                        }

                        // èªè­‰æˆåŠŸå¾Œå–æ¶ˆè¨‚é–±ï¼ˆé¿å…é‡è¤‡åŸ·è¡Œï¼‰
                        unsubscribe();
                    } else {
                        console.warn('âš ï¸ ä½¿ç”¨è€…æœªèªè­‰');
                    }
                });

                // å˜—è©¦åŒ¿åç™»å…¥
                try {
                    const userCredential = await signInAnonymously(auth);
                    console.log('âœ… åŒ¿åç™»å…¥è«‹æ±‚æˆåŠŸ');
                } catch (authError) {
                    // èªè­‰éŒ¯èª¤è™•ç†
                    console.error('âŒ Firebase åŒ¿åèªè­‰å¤±æ•—:', authError);

                    let errorMessage = 'èªè­‰å¤±æ•—';
                    let errorDetails = '';

                    // æ ¹æ“šéŒ¯èª¤ä»£ç¢¼æä¾›å…·é«”è¨Šæ¯
                    switch (authError.code) {
                        case 'auth/operation-not-allowed':
                            errorMessage = 'åŒ¿åèªè­‰æœªå•Ÿç”¨';
                            errorDetails = 'è«‹åœ¨ Firebase Console ä¸­å•Ÿç”¨ã€ŒåŒ¿åã€ç™»å…¥æ–¹å¼';
                            console.error('   è§£æ±ºæ–¹æ¡ˆï¼š');
                            console.error('   1. å‰å¾€ Firebase Console â†’ Authentication â†’ ç™»å…¥æ–¹å¼');
                            console.error('   2. å•Ÿç”¨ã€ŒåŒ¿åã€ç™»å…¥æ–¹å¼');
                            break;
                        case 'auth/api-key-not-valid':
                            errorMessage = 'API Key ç„¡æ•ˆ';
                            errorDetails = 'è«‹æª¢æŸ¥ firebase-config.js ä¸­çš„ apiKey æ˜¯å¦æ­£ç¢º';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'ç¶²è·¯é€£ç·šå¤±æ•—';
                            errorDetails = 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– API Key é™åˆ¶è¨­å®š';
                            break;
                        case 'auth/unauthorized-domain':
                            errorMessage = 'æœªæˆæ¬Šçš„ç¶²åŸŸ';
                            errorDetails = 'è«‹åœ¨ Firebase Console ä¸­æ·»åŠ æˆæ¬Šç¶²åŸŸ';
                            console.error('   è§£æ±ºæ–¹æ¡ˆï¼š');
                            console.error('   1. å‰å¾€ Firebase Console â†’ Authentication â†’ è¨­å®š');
                            console.error('   2. åœ¨ã€Œæˆæ¬Šç¶²åŸŸã€ä¸­æ·»åŠ ç•¶å‰ç¶²åŸŸï¼ˆä¾‹å¦‚ï¼šlocalhostï¼‰');
                            break;
                        default:
                            errorDetails = authError.message || 'æœªçŸ¥éŒ¯èª¤';
                    }

                    updateDbStatus('error', errorMessage);
                    console.error('   éŒ¯èª¤ä»£ç¢¼:', authError.code);
                    console.error('   éŒ¯èª¤è¨Šæ¯:', errorDetails);

                    // å–æ¶ˆè¨‚é–±ä»¥é¿å…è¨˜æ†¶é«”æ´©æ¼
                    unsubscribe();

                    // é¡¯ç¤ºç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤è¨Šæ¯
                    setTimeout(() => {
                        const statusEl = document.getElementById('dbStatus');
                        if (statusEl && statusEl.title !== errorDetails) {
                            statusEl.title = errorDetails;
                            statusEl.style.cursor = 'help';
                        }
                    }, 100);
                }

            } catch (e) {
                console.error('âŒ Firebase åˆå§‹åŒ–éŒ¯èª¤:', e);
                updateDbStatus('error', 'åˆå§‹åŒ–å¤±æ•—');
                console.error('   éŒ¯èª¤è©³æƒ…:', e.message);
            }
        }

        // åˆå§‹åŒ–è½‰ç›¤
        function init() {
            updateTitleAndDescription();
            updateOptionsDisplay();
            drawWheel();
            renderHistory();

            // å¦‚æœ Firebase å¯ç”¨ï¼Œåˆå§‹åŒ–é€£ç·š
            if (firebaseEnabled) {
                initFirebase();
            } else {
                updateDbStatus('disabled', 'æœªå•Ÿç”¨');
            }

            // ç¶å®šé‡ç½®æŒ‰éˆ•
            document.getElementById('resetHistoryBtn').onclick = resetHistory;

            // éš±è—è§¸ç™¼ï¼šé›™æ“Šæ¨™é¡Œé€²å…¥å®Œæ•´æ¬Šé™å¾Œå°ï¼ˆadminplusï¼‰
            const wheelTitle = document.getElementById('wheelTitle');
            if (wheelTitle) {
                let clickCount = 0;
                let clickTimer;
                wheelTitle.addEventListener('click', function() {
                    clickCount++;
                    if (clickCount === 1) {
                        clickTimer = setTimeout(function() {
                            clickCount = 0;
                        }, 300);
                    } else if (clickCount === 2) {
                        clearTimeout(clickTimer);
                        clickCount = 0;
                        window.location.href = 'adminplus.html';
                    }
                });
            }
        }

        // è¨ˆç®—é¡è‰²çš„äº®åº¦ï¼ˆç”¨æ–¼æ±ºå®šæ–‡å­—é¡è‰²ï¼‰
        function getLuminance(color) {
            // å°‡ hex è½‰æ›ç‚º RGB
            const hex = color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16) / 255;
            const g = parseInt(hex.substr(2, 2), 16) / 255;
            const b = parseInt(hex.substr(4, 2), 16) / 255;

            // è¨ˆç®—ç›¸å°äº®åº¦
            const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
            return luminance;
        }

        // ç¹ªè£½è½‰ç›¤
        function drawWheel() {
            const ctx = document.getElementById('wheelCanvas').getContext('2d');
            const canvas = ctx.canvas;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.95;
            let angle = 0;

            // ç¹ªè£½å¤–åœˆé™°å½±ï¼ˆæ•´é«”è½‰ç›¤é™°å½±ï¼‰
            ctx.save();
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 20;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 5;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.fillStyle = 'transparent';
            ctx.fill();
            ctx.restore();

            config.segments.forEach((seg, index) => {
                const arc = (seg.visualPercent / 100) * Math.PI * 2;
                const midAngle = angle + arc / 2;
                const startAngle = angle;
                const endAngle = angle + arc;

                // å‰µå»ºæ¼¸è®Šæ•ˆæœï¼ˆå¾ä¸­å¿ƒåˆ°é‚Šç·£ï¼‰
                const gradient = ctx.createRadialGradient(
                    centerX, centerY, radius * 0.3,
                    centerX, centerY, radius
                );

                // æ ¹æ“šé¡è‰²å‰µå»ºæ¼¸è®Š
                const baseColor = seg.color;
                const hex = baseColor.replace('#', '');
                const r = parseInt(hex.substr(0, 2), 16);
                const g = parseInt(hex.substr(2, 2), 16);
                const b = parseInt(hex.substr(4, 2), 16);

                // ä¸­å¿ƒè¼ƒäº®ï¼Œé‚Šç·£è¼ƒæš—
                gradient.addColorStop(0, `rgba(${Math.min(255, r + 40)}, ${Math.min(255, g + 40)}, ${Math.min(255, b + 40)}, 1)`);
                gradient.addColorStop(0.7, baseColor);
                gradient.addColorStop(1, `rgba(${Math.max(0, r - 30)}, ${Math.max(0, g - 30)}, ${Math.max(0, b - 30)}, 1)`);

                // ç¹ªè£½æ‰‡å€
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();

                // ç¹ªè£½æ‰‡å€é‚Šç•Œç·šï¼ˆç™½è‰²åˆ†éš”ç·šï¼Œæ›´æ¸…æ™°ï¼‰
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.lineWidth = 3;
                ctx.stroke();

                // ç¹ªè£½å…§åœˆé«˜å…‰æ•ˆæœï¼ˆè®“è½‰ç›¤æ›´æœ‰ç«‹é«”æ„Ÿï¼‰
                const highlightRadius = radius * 0.85;
                const highlightStartX = centerX + Math.cos(startAngle) * highlightRadius;
                const highlightStartY = centerY + Math.sin(startAngle) * highlightRadius;
                const highlightEndX = centerX + Math.cos(endAngle) * highlightRadius;
                const highlightEndY = centerY + Math.sin(endAngle) * highlightRadius;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(highlightStartX, highlightStartY);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.stroke();

                // è¨ˆç®—æ–‡å­—ä½ç½®ï¼ˆåœ¨æ‰‡å€ä¸­å¿ƒï¼Œè·é›¢ä¸­å¿ƒ 70% åŠå¾‘ï¼‰
                const textRadius = radius * 0.70;
                const textX = centerX + Math.cos(midAngle) * textRadius;
                const textY = centerY + Math.sin(midAngle) * textRadius;

                // æ ¹æ“šèƒŒæ™¯é¡è‰²æ±ºå®šæ–‡å­—é¡è‰²èˆ‡æé‚Šé¡è‰²
                const luminance = getLuminance(seg.color);
                const isLightBackground = luminance > 0.5;
                const textColor = isLightBackground ? '#1a1a1a' : '#FFFFFF';
                const strokeColor = isLightBackground ? '#FFFFFF' : 'rgba(0,0,0,0.8)';

                ctx.save();
                ctx.translate(textX, textY);
                ctx.rotate(midAngle + Math.PI / 2);
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // æ¸…é™¤é™°å½±è¨­å®š
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;

                // ç¹ªè£½æ–‡å­—æé‚Šï¼ˆé«˜å°æ¯”æé‚Šï¼Œç¢ºä¿æ¸…æ™°åº¦ï¼‰
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = 3; // èª¿æ•´ç‚º 3pxï¼Œé¿å…ä¸­æ–‡å­—ç³Šæ‰
                ctx.lineJoin = 'round';
                ctx.font = 'bold 26px "Noto Sans TC", "Microsoft JhengHei", "PingFang TC", sans-serif';
                ctx.strokeText(seg.label, 0, 0);

                // ç¹ªè£½æ–‡å­—
                ctx.fillStyle = textColor;
                ctx.fillText(seg.label, 0, 0);

                ctx.restore();
                angle += arc;
            });

            // ç¹ªè£½ä¸­å¿ƒè£é£¾åœ“ï¼ˆå¤šå±¤æ¬¡è¨­è¨ˆï¼‰
            // å¤–åœˆ
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.18, 0, 2 * Math.PI);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.15)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // å…§åœˆï¼ˆè£é£¾ï¼‰
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.12, 0, 2 * Math.PI);
            const centerGradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius * 0.12);
            centerGradient.addColorStop(0, '#f8f9fa');
            centerGradient.addColorStop(1, '#e9ecef');
            ctx.fillStyle = centerGradient;
            ctx.fill();
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // ä¸­å¿ƒé»
            ctx.beginPath();
            ctx.arc(centerX, centerY, 4, 0, 2 * Math.PI);
            ctx.fillStyle = '#374151';
            ctx.fill();
        }

        // æ—‹è½‰æŒ‰éˆ•äº‹ä»¶
        document.getElementById('spinBtn').onclick = () => {
            const random = Math.random() * 100;
            let cumulative = 0, selected = 0;
            for(let i=0; i<config.segments.length; i++) {
                cumulative += config.segments[i].realPercent;
                if(random <= cumulative) { selected = i; break; }
            }
            const seg = config.segments[selected];
            let start = 0;
            for(let i=0; i<selected; i++) start += (config.segments[i].visualPercent/100)*360;
            const mid = start + (seg.visualPercent/100)*180;

            // å›ºå®šæ—‹è½‰åƒæ•¸
            const FIXED_ROTATIONS = 10; // å›ºå®šè½‰ 10 åœˆ
            const FIXED_DURATION = 3000; // å›ºå®š 3 ç§’

            // è¨ˆç®—ç›®æ¨™è§’åº¦ï¼ˆæŒ‡é‡åœ¨é ‚éƒ¨ï¼Œæ‰€ä»¥ç›®æ¨™æ˜¯è®“é¸é …ä¸­å¿ƒå°æº–æŒ‡é‡ï¼‰
            // æŒ‡é‡åœ¨ 270 åº¦ä½ç½®ï¼ˆé ‚éƒ¨ï¼‰ï¼Œæ‰€ä»¥ç›®æ¨™è§’åº¦ = 270 - é¸é …ä¸­å¿ƒè§’åº¦
            const targetAngle = (270 - mid + 360) % 360;

            // æ¨™æº–åŒ–ç•¶å‰è§’åº¦åˆ° 0-360 ç¯„åœ
            const normalizedCurrent = ((currentRotation % 360) + 360) % 360;

            // è¨ˆç®—éœ€è¦æ—‹è½‰çš„è§’åº¦ï¼ˆç¢ºä¿é †æ™‚é‡æ–¹å‘ï¼‰
            let rotationNeeded = targetAngle - normalizedCurrent;
            if (rotationNeeded < 0) {
                rotationNeeded += 360; // ç¢ºä¿æ˜¯æ­£æ•¸ï¼ˆé †æ™‚é‡ï¼‰
            }

            // å›ºå®šæ–¹å‘ï¼šç¸½æ˜¯é †æ™‚é‡æ—‹è½‰å›ºå®šåœˆæ•¸
            const final = currentRotation + (FIXED_ROTATIONS * 360) + rotationNeeded;

            // è¨­å®šå›ºå®šçš„éæ¸¡æ™‚é–“å’Œç·©å‹•å‡½æ•¸ï¼ˆç¢ºä¿æ¯æ¬¡æ—‹è½‰é€Ÿåº¦ä¸€è‡´ï¼‰
            const wheelCanvas = document.getElementById('wheelCanvas');
            wheelCanvas.style.transition = `transform ${FIXED_DURATION}ms cubic-bezier(0.17, 0.67, 0.12, 0.99)`;
            wheelCanvas.style.transform = `rotate(${final}deg)`;
            currentRotation = final;
            document.getElementById('resultDisplay').innerText = "æ—‹è½‰ä¸­...";
            setTimeout(() => {
                document.getElementById('resultDisplay').innerText = "ğŸ‰ çµæœï¼š" + seg.label;
                // æ·»åŠ æ­·å²è¨˜éŒ„
                addHistoryRecord(seg.label, seg.color);
            }, FIXED_DURATION);
        };

        // é›²ç«¯åˆ†äº«åŠŸèƒ½
        document.getElementById('cloudShareBtn').onclick = async () => {
            if (!firebaseEnabled || !db) {
                alert('é›²ç«¯åŠŸèƒ½æœªå•Ÿç”¨ï¼Œè«‹æª¢æŸ¥ Firebase é…ç½®');
                return;
            }

            const btn = document.getElementById('cloudShareBtn');
            btn.disabled = true;
            btn.innerText = "å„²å­˜ä¸­...";

            try {
                const docRef = await addDoc(
                    collection(db, 'artifacts', APP_ID, 'public', 'data', 'shared_wheels'),
                    config
                );

                const shareUrl = window.location.origin + window.location.pathname + "?share=" + docRef.id;
                document.getElementById('shareUrlInput').value = shareUrl;
                document.getElementById('shareArea').classList.remove('hidden');
            } catch (e) {
                console.error('åˆ†äº«å¤±æ•—:', e);
                alert('åˆ†äº«å¤±æ•—ï¼š' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆåˆ†äº«é€£çµ";
            }
        };

        // è¤‡è£½é€£çµåŠŸèƒ½
        document.getElementById('copyBtn').onclick = () => {
            const input = document.getElementById('shareUrlInput');
            input.select();
            document.execCommand('copy');
            const btn = document.getElementById('copyBtn');
            const originalText = btn.innerText;
            btn.innerText = 'å·²è¤‡è£½ï¼';
            setTimeout(() => { btn.innerText = originalText; }, 2000);
        };

        // é‡æ–°è¼‰å…¥é…ç½®ä¸¦æ›´æ–°è½‰ç›¤
        function reloadConfig() {
            const newConfig = loadConfig();
            const configChanged = JSON.stringify(newConfig) !== JSON.stringify(config);

            if (configChanged) {
                console.log('ğŸ”„ æª¢æ¸¬åˆ°é…ç½®è®ŠåŒ–ï¼Œé‡æ–°è¼‰å…¥...');
                config = newConfig;
                updateTitleAndDescription();
                updateOptionsDisplay();
                drawWheel();
            }
        }

        // ç›£è½é…ç½®è®ŠåŒ–ï¼ˆç•¶å¾Œå°æ›´æ–°é…ç½®æ™‚ - è·¨æ¨™ç±¤é ï¼‰
        window.addEventListener('storage', (e) => {
            if (e.key === 'wheelConfig') {
                console.log('ğŸ“¦ æ”¶åˆ° storage äº‹ä»¶ï¼Œé…ç½®å·²æ›´æ–°');
                reloadConfig();
            }
        });

        // ç›£è½è‡ªå®šç¾©é…ç½®æ›´æ–°äº‹ä»¶ï¼ˆåŒé é¢å…§æ›´æ–°ï¼‰
        window.addEventListener('wheelConfigUpdated', (e) => {
            console.log('ğŸ”„ æ”¶åˆ°é…ç½®æ›´æ–°äº‹ä»¶');
            reloadConfig();
        });

        // å®šæœŸæª¢æŸ¥é…ç½®è®ŠåŒ–ï¼ˆåŒé é¢å…§æ›´æ–°ï¼‰
        setInterval(() => {
            reloadConfig();
        }, 300); // æ¯ 300ms æª¢æŸ¥ä¸€æ¬¡

        // ç•¶é é¢é‡æ–°å¯è¦‹æ™‚ï¼ˆå¾å¾Œå°è¿”å›ï¼‰ï¼Œç«‹å³æª¢æŸ¥é…ç½®
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // é é¢è®Šç‚ºå¯è¦‹æ™‚ï¼Œç«‹å³é‡æ–°è¼‰å…¥é…ç½®
                console.log('ğŸ‘ï¸ é é¢å¯è¦‹ï¼Œæª¢æŸ¥é…ç½®æ›´æ–°...');
                reloadConfig();
            }
        });

        // ç•¶é é¢ç²å¾—ç„¦é»æ™‚ï¼ˆåˆ‡æ›æ¨™ç±¤é è¿”å›ï¼‰ï¼Œç«‹å³æª¢æŸ¥é…ç½®
        window.addEventListener('focus', () => {
            console.log('ğŸ¯ é é¢ç²å¾—ç„¦é»ï¼Œæª¢æŸ¥é…ç½®æ›´æ–°...');
            reloadConfig();
        });

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        init();
    </script>
</body>
</html>
