<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eoElior | ç§˜å¯†è½‰ç›¤</title>
    <!-- Firebase é…ç½®ï¼ˆå¿…é ˆåœ¨ Firebase SDK ä¹‹å‰è¼‰å…¥ï¼‰ -->
    <script src="firebase-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        #wheelCanvas { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); border-radius: 9999px; transition: transform 5000ms cubic-bezier(0.17, 0.67, 0.12, 0.99); }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #fff; z-index: 20; }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4 flex flex-col items-center justify-center font-sans">

    <nav class="absolute top-0 w-full p-6 flex justify-between items-center">
        <a href="../index.html" class="text-slate-400 hover:text-white"><i class="fa-solid fa-arrow-left"></i> å›ç©å…·ç›’å­</a>
        <div id="dbStatus" class="text-[10px] text-slate-500">æœªé€£ç·š</div>
    </nav>

    <div class="max-w-4xl w-full grid grid-cols-1 lg:grid-cols-3 gap-8 mt-12">
        <div class="lg:col-span-2 glass-card p-8 rounded-3xl text-center">
            <h2 id="wheelTitle" class="text-3xl font-bold mb-8">å‘½é‹è¼ªç›¤</h2>
            <div class="relative w-full max-w-[320px] aspect-square mx-auto mb-8">
                <div class="pointer"></div>
                <canvas id="wheelCanvas" width="400" height="400" class="w-full h-full"></canvas>
            </div>
            <button id="spinBtn" class="bg-indigo-600 px-12 py-3 rounded-xl font-bold hover:bg-indigo-500 transition-all">é–‹å§‹æ—‹è½‰</button>
            <p id="resultDisplay" class="mt-4 text-indigo-300 font-bold h-6"></p>
        </div>

        <div class="glass-card p-6 rounded-3xl space-y-4">
            <h3 class="font-bold text-sm text-slate-400 uppercase tracking-widest">é›²ç«¯åŒæ­¥åˆ†äº«</h3>
            <button id="cloudShareBtn" class="w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-xl text-xs font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed">ç”Ÿæˆåˆ†äº«é€£çµ</button>
            <div id="shareArea" class="hidden space-y-2">
                <input type="text" id="shareUrlInput" readonly class="w-full bg-black/40 border border-slate-700 rounded-lg px-3 py-2 text-[10px] text-indigo-300 focus:outline-none">
                <button id="copyBtn" class="w-full bg-indigo-600/20 text-indigo-300 py-2 rounded-lg text-[10px] hover:bg-indigo-600/40">è¤‡è£½é€£çµ</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // ğŸ” Firebase é…ç½® - å®‰å…¨å¤–éƒ¨æ³¨å…¥æ–¹å¼
        // ==========================================
        // æ–¹å¼ 1: åœ¨ HTML ä¸­é€šé <script> æ¨™ç±¤å®šç¾© __firebase_config
        // æ–¹å¼ 2: é€šéå¤–éƒ¨é…ç½®æ–‡ä»¶è¼‰å…¥ï¼ˆæ¨è–¦ï¼‰
        // æ–¹å¼ 3: å¦‚æœéƒ½æ²’æœ‰ï¼Œä½¿ç”¨é è¨­é…ç½®ï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼æ¸¬è©¦ï¼‰

        let firebaseConfig;
        let firebaseEnabled = false;

        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                // å¤–éƒ¨æ³¨å…¥çš„é…ç½®ï¼ˆæœ€å®‰å…¨ï¼‰
                firebaseConfig = typeof __firebase_config === 'string'
                    ? JSON.parse(__firebase_config)
                    : __firebase_config;
                firebaseEnabled = true;
            } else {
                // é è¨­é…ç½®ï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼ï¼Œç”Ÿç”¢ç’°å¢ƒæ‡‰ç§»é™¤ï¼‰
                console.warn('âš ï¸ æœªæª¢æ¸¬åˆ°å¤–éƒ¨ Firebase é…ç½®ï¼Œä½¿ç”¨é è¨­é…ç½®ï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼ï¼‰');
                firebaseConfig = {
                    projectId: "studio-2298218799-c99fe",
                    appId: "1:848457307119:web:d0c416db3468efb9ef5c1a",
                    apiKey: "AIzaSyDDgQUZH5N1IaNR2-CeOIHCQjccsJEYD5s",
                    authDomain: "studio-2298218799-c99fe.firebaseapp.com",
                    messagingSenderId: "848457307119"
                };
                firebaseEnabled = true; // é–‹ç™¼æ¨¡å¼å•Ÿç”¨
            }
        } catch (e) {
            console.error('âŒ Firebase é…ç½®è§£æå¤±æ•—:', e);
            firebaseEnabled = false;
        }

        // Firebase æ‡‰ç”¨ç¨‹å¼è­˜åˆ¥ç¢¼
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'eoelior-wheel-data';

        // åˆå§‹åŒ– Firebaseï¼ˆå¦‚æœé…ç½®å¯ç”¨ï¼‰
        let app, auth, db;
        if (firebaseEnabled) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', e);
                firebaseEnabled = false;
            }
        }

        // ==========================================
        // ğŸ¡ è½‰ç›¤æ ¸å¿ƒé‚è¼¯
        // ==========================================
        let config = {
            title: "å‘½é‹è¼ªç›¤",
            segments: [
                {label: "è²·", color: "#10b981", visualPercent: 50, realPercent: 80},
                {label: "ä¸è²·", color: "#ef4444", visualPercent: 50, realPercent: 20}
            ]
        };
        let currentRotation = 0;

        // æ›´æ–°é€£ç·šç‹€æ…‹é¡¯ç¤º
        function updateDbStatus(status, text) {
            const statusEl = document.getElementById('dbStatus');
            if (statusEl) {
                statusEl.innerText = text || status;
                statusEl.className = `text-[10px] ${
                    status === 'connected' ? 'text-emerald-400' :
                    status === 'connecting' ? 'text-yellow-400' :
                    'text-slate-500'
                }`;
            }
        }

        // åˆå§‹åŒ– Firebase èªè­‰
        async function initFirebase() {
            if (!firebaseEnabled || !auth) {
                updateDbStatus('disabled', 'æœªå•Ÿç”¨');
                console.warn('âš ï¸ Firebase æœªå•Ÿç”¨æˆ–æœªåˆå§‹åŒ–');
                return;
            }

            try {
                updateDbStatus('connecting', 'é€£ç·šä¸­...');
                console.log('ğŸ”„ é–‹å§‹ Firebase åŒ¿åèªè­‰...');

                // è¨­å®šèªè­‰ç‹€æ…‹ç›£è½å™¨ï¼ˆåœ¨å˜—è©¦ç™»å…¥ä¹‹å‰ï¼‰
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log('âœ… Firebase èªè­‰æˆåŠŸï¼ŒUID:', user.uid.substring(0, 8) + '...');
                        updateDbStatus('connected', 'é›²ç«¯å·²é€£ç·š');

                        // æª¢æŸ¥ URL åƒæ•¸æ˜¯å¦æœ‰åˆ†äº« ID
                        const params = new URLSearchParams(window.location.search);
                        const shareId = params.get('share');

                        if (shareId) {
                            try {
                                console.log('ğŸ“¥ è¼‰å…¥åˆ†äº«é…ç½®ï¼ŒID:', shareId);
                                const snap = await getDoc(
                                    doc(db, 'artifacts', APP_ID, 'public', 'data', 'shared_wheels', shareId)
                                );
                                if (snap.exists()) {
                                    config = snap.data();
                                    document.getElementById('wheelTitle').innerText = config.title || 'å‘½é‹è¼ªç›¤';
                                    drawWheel();
                                    console.log('âœ… åˆ†äº«é…ç½®è¼‰å…¥æˆåŠŸ');
                                } else {
                                    console.warn('âš ï¸ åˆ†äº«é…ç½®ä¸å­˜åœ¨');
                                }
                            } catch (e) {
                                console.error('âŒ è¼‰å…¥åˆ†äº«é…ç½®å¤±æ•—:', e);
                                if (e.code === 'permission-denied') {
                                    console.error('   åŸå› ï¼šFirestore å®‰å…¨è¦å‰‡æ‹’çµ•å­˜å–');
                                    console.error('   è§£æ±ºï¼šè«‹æª¢æŸ¥ Firestore è¦å‰‡æ˜¯å¦å…è¨±è®€å–');
                                }
                            }
                        }

                        // èªè­‰æˆåŠŸå¾Œå–æ¶ˆè¨‚é–±ï¼ˆé¿å…é‡è¤‡åŸ·è¡Œï¼‰
                        unsubscribe();
                    } else {
                        console.warn('âš ï¸ ä½¿ç”¨è€…æœªèªè­‰');
                    }
                });

                // å˜—è©¦åŒ¿åç™»å…¥
                try {
                    const userCredential = await signInAnonymously(auth);
                    console.log('âœ… åŒ¿åç™»å…¥è«‹æ±‚æˆåŠŸ');
                } catch (authError) {
                    // èªè­‰éŒ¯èª¤è™•ç†
                    console.error('âŒ Firebase åŒ¿åèªè­‰å¤±æ•—:', authError);

                    let errorMessage = 'èªè­‰å¤±æ•—';
                    let errorDetails = '';

                    // æ ¹æ“šéŒ¯èª¤ä»£ç¢¼æä¾›å…·é«”è¨Šæ¯
                    switch (authError.code) {
                        case 'auth/operation-not-allowed':
                            errorMessage = 'åŒ¿åèªè­‰æœªå•Ÿç”¨';
                            errorDetails = 'è«‹åœ¨ Firebase Console ä¸­å•Ÿç”¨ã€ŒåŒ¿åã€ç™»å…¥æ–¹å¼';
                            console.error('   è§£æ±ºæ–¹æ¡ˆï¼š');
                            console.error('   1. å‰å¾€ Firebase Console â†’ Authentication â†’ ç™»å…¥æ–¹å¼');
                            console.error('   2. å•Ÿç”¨ã€ŒåŒ¿åã€ç™»å…¥æ–¹å¼');
                            break;
                        case 'auth/api-key-not-valid':
                            errorMessage = 'API Key ç„¡æ•ˆ';
                            errorDetails = 'è«‹æª¢æŸ¥ firebase-config.js ä¸­çš„ apiKey æ˜¯å¦æ­£ç¢º';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'ç¶²è·¯é€£ç·šå¤±æ•—';
                            errorDetails = 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– API Key é™åˆ¶è¨­å®š';
                            break;
                        case 'auth/unauthorized-domain':
                            errorMessage = 'æœªæˆæ¬Šçš„ç¶²åŸŸ';
                            errorDetails = 'è«‹åœ¨ Firebase Console ä¸­æ·»åŠ æˆæ¬Šç¶²åŸŸ';
                            console.error('   è§£æ±ºæ–¹æ¡ˆï¼š');
                            console.error('   1. å‰å¾€ Firebase Console â†’ Authentication â†’ è¨­å®š');
                            console.error('   2. åœ¨ã€Œæˆæ¬Šç¶²åŸŸã€ä¸­æ·»åŠ ç•¶å‰ç¶²åŸŸï¼ˆä¾‹å¦‚ï¼šlocalhostï¼‰');
                            break;
                        default:
                            errorDetails = authError.message || 'æœªçŸ¥éŒ¯èª¤';
                    }

                    updateDbStatus('error', errorMessage);
                    console.error('   éŒ¯èª¤ä»£ç¢¼:', authError.code);
                    console.error('   éŒ¯èª¤è¨Šæ¯:', errorDetails);

                    // å–æ¶ˆè¨‚é–±ä»¥é¿å…è¨˜æ†¶é«”æ´©æ¼
                    unsubscribe();

                    // é¡¯ç¤ºç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤è¨Šæ¯
                    setTimeout(() => {
                        const statusEl = document.getElementById('dbStatus');
                        if (statusEl && statusEl.title !== errorDetails) {
                            statusEl.title = errorDetails;
                            statusEl.style.cursor = 'help';
                        }
                    }, 100);
                }

            } catch (e) {
                console.error('âŒ Firebase åˆå§‹åŒ–éŒ¯èª¤:', e);
                updateDbStatus('error', 'åˆå§‹åŒ–å¤±æ•—');
                console.error('   éŒ¯èª¤è©³æƒ…:', e.message);
            }
        }

        // åˆå§‹åŒ–è½‰ç›¤
        function init() {
            document.getElementById('wheelTitle').innerText = config.title;
            drawWheel();

            // å¦‚æœ Firebase å¯ç”¨ï¼Œåˆå§‹åŒ–é€£ç·š
            if (firebaseEnabled) {
                initFirebase();
            } else {
                updateDbStatus('disabled', 'æœªå•Ÿç”¨');
            }
        }

        // ç¹ªè£½è½‰ç›¤
        function drawWheel() {
            const ctx = document.getElementById('wheelCanvas').getContext('2d');
            ctx.clearRect(0,0,400,400);
            let angle = 0;
            config.segments.forEach(seg => {
                const arc = (seg.visualPercent / 100) * Math.PI * 2;
                ctx.beginPath();
                ctx.moveTo(200,200);
                ctx.arc(200,200,190,angle,angle+arc);
                ctx.fillStyle = seg.color;
                ctx.fill();
                ctx.save();
                ctx.translate(200,200);
                ctx.rotate(angle+arc/2);
                ctx.textAlign="right";
                ctx.fillStyle="white";
                ctx.font="bold 16px Inter";
                ctx.fillText(seg.label, 170, 5);
                ctx.restore();
                angle += arc;
            });
        }

        // æ—‹è½‰æŒ‰éˆ•äº‹ä»¶
        document.getElementById('spinBtn').onclick = () => {
            const random = Math.random() * 100;
            let cumulative = 0, selected = 0;
            for(let i=0; i<config.segments.length; i++) {
                cumulative += config.segments[i].realPercent;
                if(random <= cumulative) { selected = i; break; }
            }
            const seg = config.segments[selected];
            let start = 0;
            for(let i=0; i<selected; i++) start += (config.segments[i].visualPercent/100)*360;
            const mid = start + (seg.visualPercent/100)*180;
            const target = (270 - mid + 360) % 360;
            const final = currentRotation + (10 * 360) + target - (currentRotation % 360);
            document.getElementById('wheelCanvas').style.transform = `rotate(${final}deg)`;
            currentRotation = final;
            document.getElementById('resultDisplay').innerText = "æ—‹è½‰ä¸­...";
            setTimeout(() => {
                document.getElementById('resultDisplay').innerText = "ğŸ‰ çµæœï¼š" + seg.label;
            }, 5000);
        };

        // é›²ç«¯åˆ†äº«åŠŸèƒ½
        document.getElementById('cloudShareBtn').onclick = async () => {
            if (!firebaseEnabled || !db) {
                alert('é›²ç«¯åŠŸèƒ½æœªå•Ÿç”¨ï¼Œè«‹æª¢æŸ¥ Firebase é…ç½®');
                return;
            }

            const btn = document.getElementById('cloudShareBtn');
            btn.disabled = true;
            btn.innerText = "å„²å­˜ä¸­...";

            try {
                const docRef = await addDoc(
                    collection(db, 'artifacts', APP_ID, 'public', 'data', 'shared_wheels'),
                    config
                );

                const shareUrl = window.location.origin + window.location.pathname + "?share=" + docRef.id;
                document.getElementById('shareUrlInput').value = shareUrl;
                document.getElementById('shareArea').classList.remove('hidden');
            } catch (e) {
                console.error('åˆ†äº«å¤±æ•—:', e);
                alert('åˆ†äº«å¤±æ•—ï¼š' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆåˆ†äº«é€£çµ";
            }
        };

        // è¤‡è£½é€£çµåŠŸèƒ½
        document.getElementById('copyBtn').onclick = () => {
            const input = document.getElementById('shareUrlInput');
            input.select();
            document.execCommand('copy');
            const btn = document.getElementById('copyBtn');
            const originalText = btn.innerText;
            btn.innerText = 'å·²è¤‡è£½ï¼';
            setTimeout(() => { btn.innerText = originalText; }, 2000);
        };

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        init();
    </script>
</body>
</html>
