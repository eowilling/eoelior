<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½‰ç›¤éŠæˆ²</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // è¨­å®š Tailwind é…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        'primary-buy': '#10b981', // Emerald green
                        'secondary-bad': '#ef4444', // Red
                        'accent-spin': '#fcd34d', // Amber
                    }
                }
            }
        }
    </script>
    <style>
        /* ç¢ºä¿ Canvas å±…ä¸­ä¸”éŸ¿æ‡‰å¼ */
        #wheelCanvas {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 9999px; /* åœ“å½¢é™°å½± */
            transition: transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99); /* æ›´è‡ªç„¶çš„æ¸›é€Ÿæ›²ç·š */
        }

        /* æŒ‡é‡æ¨£å¼ */
        .pointer {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #374151; /* Dark gray triangle */
            z-index: 10;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 400px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            margin: auto;
            aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
        }

        /* ç¦ç”¨æŒ‰éˆ•æ¨£å¼ */
        .delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #9ca3af !important;
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-800">è½‰ç›¤éŠæˆ²</h1>
                </div>
                <div class="flex items-center gap-4">
                    <a href="admin.html"
                       class="text-gray-600 hover:text-gray-800 px-3 py-2 rounded-md text-sm font-medium transition">
                        å¾Œå°ç®¡ç†
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€åŸŸ -->
    <main class="flex-grow bg-gray-50 p-4 font-sans">
        <div class="max-w-7xl mx-auto">
            <p id="wheelDescription" class="text-center text-gray-600 mb-8" style="display: none;">
                <!-- èªªæ˜å°‡å‹•æ…‹é¡¯ç¤ºåœ¨é€™è£¡ -->
            </p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- å·¦å´ï¼šè½‰ç›¤å€åŸŸ -->
                <div class="lg:col-span-2 bg-white p-6 md:p-10 rounded-xl shadow-2xl">
                    <div class="text-center mb-4">
                        <h2 class="text-3xl font-bold text-gray-800" id="wheelTitle">
                            å‘½é‹è¼ªç›¤
                        </h2>
                    </div>

                    <!-- è½‰ç›¤å’ŒæŒ‡é‡å®¹å™¨ -->
                    <div class="canvas-container">
                        <!-- æŒ‡é‡ (ä½æ–¼é ‚éƒ¨ä¸­å¿ƒ) -->
                        <div class="pointer"></div>

                        <!-- è½‰ç›¤ Canvas -->
                        <canvas id="wheelCanvas" width="400" height="400" class="w-full h-full"></canvas>
                    </div>

                    <!-- æ—‹è½‰æŒ‰éˆ•å’Œçµæœé¡¯ç¤º -->
                    <div class="flex flex-col items-center mt-8 space-y-4">
                        <button id="spinButton"
                                class="w-full md:w-auto px-10 py-4 text-xl font-bold text-gray-900 bg-accent-spin rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed border-b-4 border-yellow-700/50">
                            é–‹å§‹æ—‹è½‰ï¼
                        </button>
                        <div id="resultDisplay"
                             class="min-h-[50px] w-full text-center text-2xl font-extrabold text-gray-700 p-3 rounded-lg bg-gray-100 transition-all duration-500 shadow-inner">
                            æŒ‰ä¸‹æŒ‰éˆ•é–‹å§‹
                        </div>
                    </div>

                    <!-- ä¸­çæ©Ÿç‡è¡¨æ ¼ -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">ä¸­çæ©Ÿç‡</h3>
                        <div class="overflow-x-auto">
                            <table id="optionsDisplay" class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-gray-300 px-4 py-2 text-left">é¸é …</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">ä¸­çæ©Ÿç‡</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- é¸é …å°‡å‹•æ…‹é¡¯ç¤ºåœ¨é€™è£¡ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šè¨˜éŒ„æ˜ç´° -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">è½‰ç›¤è¨˜éŒ„</h2>
                        <button id="resetHistoryBtn"
                                class="px-4 py-2 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition">
                            é‡ç½®
                        </button>
                    </div>
                    <div id="historyDisplay" class="space-y-2 max-h-[600px] overflow-y-auto">
                        <p class="text-gray-500 text-sm text-center py-4">å°šç„¡è¨˜éŒ„</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- é è…³ -->
    <footer class="bg-white border-t">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <p class="text-center text-gray-500 text-sm">
                Â© 2024 è½‰ç›¤éŠæˆ² - æ‰€æœ‰æ¬Šåˆ©ä¿ç•™
            </p>
        </div>
    </footer>

    <script>
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spinButton');
        const resultDisplay = document.getElementById('resultDisplay');
        const visualInfo = document.getElementById('visualInfo');

        // é è¨­é…ç½®
        const defaultConfig = {
            title: "å‘½é‹è¼ªç›¤",
            description: "",
            segments: [
                { label: "è²·", color: '#10b981', visualPercent: 50, realPercent: 80 },
                { label: "ä¸å¥½", color: '#ef4444', visualPercent: 50, realPercent: 20 }
            ]
        };

        // å¾ URL åƒæ•¸è®€å–é…ç½®
        function loadConfigFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            // æ”¯æ´æ–°æ ¼å¼ 'c' å’ŒèˆŠæ ¼å¼ 'config'
            const configParam = urlParams.get('c') || urlParams.get('config');

            if (configParam) {
                try {
                    // è§£ç¢¼ Base64ï¼ˆæ”¯æ´æ–°èˆŠå…©ç¨®ç·¨ç¢¼æ ¼å¼ï¼‰
                    let configJson;
                    try {
                        // æ–°æ ¼å¼ï¼šURLå®‰å…¨çš„Base64ï¼ˆ- å’Œ _ ä»£æ›¿ + å’Œ /ï¼‰
                        const normalizedBase64 = configParam.replace(/-/g, '+').replace(/_/g, '/');
                        // è£œé½Šå¡«å……
                        const paddedBase64 = normalizedBase64 + '='.repeat((4 - normalizedBase64.length % 4) % 4);
                        const decodedBase64 = atob(paddedBase64);
                        // å…ˆå˜—è©¦ decodeURIComponentï¼ˆæ–°æ ¼å¼ä½¿ç”¨ encodeURIComponent ç·¨ç¢¼ï¼‰
                        try {
                            configJson = decodeURIComponent(decodedBase64);
                        } catch (e) {
                            // å¦‚æœå¤±æ•—ï¼Œå¯èƒ½æ˜¯èˆŠæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                            configJson = decodedBase64;
                        }
                    } catch (e) {
                        // èˆŠæ ¼å¼ï¼šç›´æ¥è§£ç¢¼
                        try {
                            configJson = decodeURIComponent(atob(configParam));
                        } catch (e2) {
                            configJson = atob(configParam);
                        }
                    }

                    const sharedConfig = JSON.parse(configJson);

                    // æ”¯æ´ç·Šæ¹Šæ ¼å¼ï¼ˆç¸®å¯«å­—æ®µï¼‰å’Œå®Œæ•´æ ¼å¼
                    const config = {
                        title: sharedConfig.t || sharedConfig.title || defaultConfig.title,
                        description: sharedConfig.d || sharedConfig.description || defaultConfig.description,
                        segments: (sharedConfig.s || sharedConfig.segments || []).map(seg => ({
                            label: seg.l || seg.label,
                            color: seg.c || seg.color,
                            visualPercent: seg.v || seg.visualPercent,
                            realPercent: seg.v || seg.visualPercent || seg.realPercent // åˆ†äº«æ™‚ä½¿ç”¨è¦–è¦ºæ¯”ä¾‹ä½œç‚ºçœŸå¯¦æ©Ÿç‡
                        }))
                    };

                    // ä¿å­˜åˆ° localStorageï¼ˆå¯é¸ï¼Œè®“ç”¨æˆ¶ä¹‹å¾Œä¹Ÿèƒ½ä½¿ç”¨ï¼‰
                    saveConfig(config);

                    return config;
                } catch (e) {
                    console.error('å¾ URL è¼‰å…¥é…ç½®å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼', e);
                    return null;
                }
            }
            return null;
        }

        // å¾ localStorage è¼‰å…¥é…ç½®
        function loadConfig() {
            // å„ªå…ˆå¾ URL åƒæ•¸è®€å–
            const urlConfig = loadConfigFromUrl();
            if (urlConfig) {
                return urlConfig;
            }

            // å¦å‰‡å¾ localStorage è®€å–
            const saved = localStorage.getItem('wheelConfig');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('è¼‰å…¥é…ç½®å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼', e);
                }
            }
            return defaultConfig;
        }

        // å„²å­˜é…ç½®
        function saveConfig(config) {
            localStorage.setItem('wheelConfig', JSON.stringify(config));
        }

        // è¼‰å…¥é…ç½®
        let config = loadConfig();
        let segments = [];
        const optionsDisplay = document.getElementById('optionsDisplay');

        // åˆå§‹åŒ–è½‰ç›¤æ•¸æ“š
        function initSegments() {
            segments = config.segments.map((seg, index) => {
                const degrees = (seg.visualPercent / 100) * 360;
                return {
                    label: seg.label,
                    color: seg.color,
                    degrees: degrees,
                    visualPercent: seg.visualPercent,
                    realPercent: seg.realPercent,
                    startAngleDeg: 0, // èµ·å§‹è§’åº¦ï¼ˆåº¦æ•¸ï¼‰
                    endAngleDeg: 0    // çµæŸè§’åº¦ï¼ˆåº¦æ•¸ï¼‰
                };
            });

            // è¨ˆç®—æ¯å€‹æ‰‡å€çš„èµ·å§‹å’ŒçµæŸè§’åº¦ï¼ˆåº¦æ•¸ï¼Œ0åº¦åœ¨å³å´3é»é˜æ–¹å‘ï¼‰
            let currentAngle = 0;
            segments.forEach(seg => {
                seg.startAngleDeg = currentAngle;
                seg.endAngleDeg = currentAngle + seg.degrees;
                currentAngle = seg.endAngleDeg;
            });

            updateOptionsDisplay();
            updateTitleAndDescription();
        }

        // æ›´æ–°æ¨™é¡Œå’Œèªªæ˜é¡¯ç¤º
        function updateTitleAndDescription() {
            const titleElement = document.getElementById('wheelTitle');
            const descriptionElement = document.getElementById('wheelDescription');

            if (titleElement) {
                titleElement.textContent = config.title || defaultConfig.title;
            }

            if (descriptionElement) {
                if (config.description && config.description.trim()) {
                    descriptionElement.textContent = config.description;
                    descriptionElement.style.display = 'block';
                } else {
                    descriptionElement.style.display = 'none';
                }
            }
        }

        // æ›´æ–°é¸é …é¡¯ç¤ºï¼ˆè¡¨æ ¼æ ¼å¼ï¼‰
        function updateOptionsDisplay() {
            let html = '';
            config.segments.forEach(segment => {
                html += `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2">
                            <span class="inline-block px-3 py-1 rounded text-white font-semibold" style="background-color: ${segment.color};">
                                ${segment.label}
                            </span>
                        </td>
                        <td class="border border-gray-300 px-4 py-2 text-center font-semibold">
                            ${segment.visualPercent.toFixed(1)}%
                        </td>
                    </tr>
                `;
            });
            const tbody = optionsDisplay.querySelector('tbody');
            if (tbody) {
                tbody.innerHTML = html;
            }
        }

        // è¼‰å…¥æ­·å²è¨˜éŒ„
        function loadHistory() {
            const saved = localStorage.getItem('wheelHistory');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—', e);
                }
            }
            return [];
        }

        // å„²å­˜æ­·å²è¨˜éŒ„
        function saveHistory(history) {
            localStorage.setItem('wheelHistory', JSON.stringify(history));
        }

        // æ·»åŠ è¨˜éŒ„
        function addHistoryRecord(label, color) {
            const history = loadHistory();
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            const dateStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;

            history.unshift({
                label: label,
                color: color,
                time: timeStr,
                date: dateStr,
                timestamp: now.getTime(),
                protected: false // é è¨­ä¸å—ä¿è­·
            });

            // æœ€å¤šä¿ç•™ 100 ç­†è¨˜éŒ„ï¼ˆä¸åŒ…æ‹¬å—ä¿è­·çš„ï¼‰
            if (history.length > 100) {
                // åªåˆªé™¤ä¸å—ä¿è­·çš„è¨˜éŒ„
                for (let i = history.length - 1; i >= 0; i--) {
                    if (!history[i].protected) {
                        history.splice(i, 1);
                        break;
                    }
                }
            }

            saveHistory(history);
            renderHistory();
        }

        // æ¸²æŸ“æ­·å²è¨˜éŒ„
        function renderHistory() {
            const history = loadHistory();
            const historyDisplay = document.getElementById('historyDisplay');

            if (history.length === 0) {
                historyDisplay.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">å°šç„¡è¨˜éŒ„</p>';
                return;
            }

            let html = '';
            history.forEach((record, index) => {
                const protectedClass = record.protected ? 'bg-yellow-50 border-yellow-300' : '';
                const protectIcon = record.protected ? 'âœ“' : 'â—‹';
                const protectColor = record.protected ? 'text-green-600' : 'text-gray-400';

                html += `
                    <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition ${protectedClass}" data-index="${index}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="inline-block px-3 py-1 rounded text-white font-semibold text-sm" style="background-color: ${record.color};">
                                ${record.label}
                            </span>
                            <span class="text-xs text-gray-500">${record.date} ${record.time}</span>
                        </div>
                        <div class="flex items-center justify-end gap-2 mt-2">
                            <button class="protect-btn px-2 py-1 text-sm rounded transition ${protectColor} hover:bg-gray-100"
                                    data-index="${index}"
                                    title="${record.protected ? 'å–æ¶ˆä¿è­·' : 'ä¿è­·æ­¤è¨˜éŒ„'}">
                                ${protectIcon}
                            </button>
                            <button class="delete-btn px-2 py-1 text-sm text-red-500 rounded hover:text-red-700 hover:bg-red-50 transition"
                                    data-index="${index}"
                                    ${record.protected ? 'disabled title="å—ä¿è­·çš„è¨˜éŒ„ç„¡æ³•åˆªé™¤"' : 'title="åˆªé™¤æ­¤è¨˜éŒ„"'}>
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            });
            historyDisplay.innerHTML = html;

            // ç¶å®šäº‹ä»¶
            historyDisplay.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    deleteHistoryRecord(index);
                });
            });

            historyDisplay.querySelectorAll('.protect-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    toggleProtectRecord(index);
                });
            });
        }

        // åˆªé™¤å–®ç­†è¨˜éŒ„
        function deleteHistoryRecord(index) {
            const history = loadHistory();
            if (index >= 0 && index < history.length) {
                if (history[index].protected) {
                    alert('æ­¤è¨˜éŒ„å·²å—ä¿è­·ï¼Œç„¡æ³•åˆªé™¤ï¼');
                    return;
                }
                if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜éŒ„å—ï¼Ÿ')) {
                    history.splice(index, 1);
                    saveHistory(history);
                    renderHistory();
                }
            }
        }

        // åˆ‡æ›ä¿è­·ç‹€æ…‹
        function toggleProtectRecord(index) {
            const history = loadHistory();
            if (index >= 0 && index < history.length) {
                history[index].protected = !history[index].protected;
                saveHistory(history);
                renderHistory();
            }
        }

        // é‡ç½®æ­·å²è¨˜éŒ„ï¼ˆåŒ…æ‹¬å—ä¿è­·çš„è¨˜éŒ„ï¼‰
        function resetHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è½‰ç›¤è¨˜éŒ„å—ï¼Ÿ\nï¼ˆåŒ…æ‹¬å—ä¿è­·çš„è¨˜éŒ„ä¹Ÿæœƒè¢«æ¸…é™¤ï¼‰')) {
                localStorage.removeItem('wheelHistory');
                renderHistory();
            }
        }

        const totalDegrees = 360;
        let currentRotation = 0; // ç•¶å‰æ—‹è½‰è§’åº¦ (åº¦)
        let isSpinning = false;

        // é‡ç½®è½‰ç›¤ç‚ºåˆå§‹ç‹€æ…‹
        function resetWheel() {
            currentRotation = 0;
            canvas.style.transform = 'rotate(0deg)';
            resultDisplay.textContent = 'æŒ‰ä¸‹æŒ‰éˆ•é–‹å§‹';
            resultDisplay.className = 'min-h-[50px] w-full text-center text-2xl font-extrabold text-gray-700 p-3 rounded-lg bg-gray-100 transition-all duration-500 shadow-inner';
            isSpinning = false;
            spinButton.disabled = false;
        }

        // åˆå§‹åŒ–
        initSegments();
        resetWheel(); // ç¢ºä¿æ¯æ¬¡é–‹å•Ÿéƒ½æ˜¯æ–°çš„è¼ªç›¤

        // ç¹ªè£½è½‰ç›¤
        function drawWheel() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.95;

            segments.forEach(segment => {
                // å°‡åº¦æ•¸è½‰æ›ç‚ºå¼§åº¦ï¼ˆCanvas arc ä½¿ç”¨å¼§åº¦ï¼‰
                // æ³¨æ„ï¼šCanvas 0åº¦åœ¨å³å´ï¼ˆ3é»é˜æ–¹å‘ï¼‰ï¼Œé †æ™‚é‡ç‚ºæ­£
                const startAngleRad = (segment.startAngleDeg * Math.PI) / 180;
                const endAngleRad = (segment.endAngleDeg * Math.PI) / 180;

                // ç¹ªè£½æ‰‡å€
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngleRad, endAngleRad);
                ctx.closePath();
                ctx.fillStyle = segment.color;
                ctx.fill();

                // ç¹ªè£½æ–‡å­— (ä½æ–¼æ‰‡å€ä¸­å¿ƒ)
                const textAngleRad = (startAngleRad + endAngleRad) / 2;
                const textRadius = radius * 0.75;
                const x = centerX + Math.cos(textAngleRad) * textRadius;
                const y = centerY + Math.sin(textAngleRad) * textRadius;

                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(textAngleRad + Math.PI / 2); // æ—‹è½‰æ–‡å­—ä½¿å…¶å‚ç›´æ–¼åŠå¾‘
                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px Noto Sans TC, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(segment.label, 0, 0);
                ctx.restore();
            });

            // ç¹ªè£½ä¸­å¿ƒåœ“
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.15, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 4;
            ctx.stroke();
        }

        // åˆå§‹åŒ–ç¹ªè£½
        drawWheel();

        /**
         * æ ¹æ“šçœŸå¯¦æ©Ÿç‡é¸æ“‡çµæœ
         */
        function selectResultByRealProbability() {
            const random = Math.random() * 100; // 0-100
            let cumulative = 0;

            for (let i = 0; i < config.segments.length; i++) {
                cumulative += config.segments[i].realPercent;
                if (random <= cumulative) {
                    return i; // è¿”å›é¸ä¸­çš„ç´¢å¼•
                }
            }
            // å¦‚æœå› ç‚ºæµ®é»æ•¸èª¤å·®æ²’é¸ä¸­ï¼Œè¿”å›æœ€å¾Œä¸€å€‹
            return config.segments.length - 1;
        }

        /**
         * è¨ˆç®—æŒ‡å®šæ‰‡å€çš„ç›®æ¨™è§’åº¦ï¼ˆæŒ‡é‡æŒ‡å‘è©²æ‰‡å€ä¸­å¿ƒï¼‰
         * Canvas è§’åº¦ç³»çµ±ï¼š0åº¦åœ¨å³å´ï¼ˆ3é»é˜ï¼‰ï¼Œé †æ™‚é‡ç‚ºæ­£
         * æŒ‡é‡åœ¨é ‚éƒ¨ï¼ˆ-90åº¦æˆ–270åº¦ï¼Œ12é»é˜æ–¹å‘ï¼‰
         * éœ€è¦è¨ˆç®—è®“è©²æ‰‡å€ä¸­å¿ƒå°æº–æŒ‡é‡çš„æ—‹è½‰è§’åº¦
         */
        function calculateTargetAngle(segmentIndex) {
            const segment = segments[segmentIndex];
            // æ‰‡å€ä¸­å¿ƒè§’åº¦ï¼ˆåº¦æ•¸ï¼Œç›¸å°æ–¼å³å´3é»é˜æ–¹å‘ï¼‰
            const centerAngleDeg = (segment.startAngleDeg + segment.endAngleDeg) / 2;

            // Canvas è§’åº¦ç³»çµ±ï¼š0åº¦åœ¨å³å´ï¼ˆ3é»é˜ï¼‰ï¼Œé †æ™‚é‡ç‚ºæ­£
            // æŒ‡é‡åœ¨é ‚éƒ¨ï¼ˆ12é»é˜æ–¹å‘ï¼‰ï¼Œå°æ‡‰ -90åº¦ï¼ˆæˆ–270åº¦ï¼‰
            // è¦è®“æ‰‡å€ä¸­å¿ƒå°æº–æŒ‡é‡ï¼Œéœ€è¦å°‡ centerAngleDeg æ—‹è½‰åˆ° -90åº¦ä½ç½®

            // è¨ˆç®—ï¼šå¦‚æœæ‰‡å€ä¸­å¿ƒåœ¨ centerAngleDegï¼ˆåº¦æ•¸ï¼Œ0åº¦åœ¨å³å´ï¼‰ï¼Œ
            // è¦è®“å®ƒå°æº–é ‚éƒ¨ï¼ˆ-90åº¦ï¼‰ï¼Œéœ€è¦æ—‹è½‰çš„è§’åº¦
            // ç›®æ¨™ï¼šcenterAngleDeg + rotation = -90åº¦
            // æ‰€ä»¥ï¼šrotation = -90 - centerAngleDeg
            // ä½† CSS rotate æ˜¯é †æ™‚é‡ï¼Œæ‰€ä»¥ï¼šrotation = 270 - centerAngleDeg
            let targetAngle = 270 - centerAngleDeg;

            // æ¨™æº–åŒ–åˆ° 0-360 ç¯„åœ
            while (targetAngle < 0) targetAngle += 360;
            while (targetAngle >= 360) targetAngle -= 360;

            return targetAngle;
        }

        /**
         * åŸ·è¡Œæ—‹è½‰å‹•ä½œï¼Œæ ¹æ“šçœŸå¯¦æ©Ÿç‡æ±ºå®šçµæœï¼Œä½†è¦–è¦ºä¸Šåœåœ¨å°æ‡‰æ‰‡å€
         */
        function spinWheel() {
            if (isSpinning) return;
            isSpinning = true;
            spinButton.disabled = true;
            resultDisplay.textContent = "è½‰ç›¤é«˜é€Ÿæ—‹è½‰ä¸­...";
            resultDisplay.className = "min-h-[50px] w-full text-center text-2xl font-extrabold text-white p-3 rounded-lg bg-gray-500 transition-all duration-500 shadow-inner";

            // 1. æ ¹æ“šçœŸå¯¦æ©Ÿç‡é¸æ“‡çµæœ
            const selectedIndex = selectResultByRealProbability();
            const selectedSegment = segments[selectedIndex];

            // 2. è¨ˆç®—ç›®æ¨™è§’åº¦ï¼ˆè®“é¸ä¸­çš„æ‰‡å€ä¸­å¿ƒå°æº–æŒ‡é‡ï¼‰
            const baseTargetAngle = calculateTargetAngle(selectedIndex);

            // 3. åœ¨æ‰‡å€å…§æ·»åŠ ä¸€äº›éš¨æ©Ÿåç§»ï¼Œè®“çµæœçœ‹èµ·ä¾†æ›´è‡ªç„¶ï¼ˆä½†ä»åœ¨è©²æ‰‡å€å…§ï¼‰
            const segmentRange = selectedSegment.degrees;
            const randomOffset = (Math.random() - 0.5) * segmentRange * 0.6; // åœ¨æ‰‡å€60%ç¯„åœå…§éš¨æ©Ÿ
            const targetAngle = baseTargetAngle + randomOffset;

            // 4. å¢åŠ å¤šå€‹æ•´åœˆæ—‹è½‰ (è®“æ—‹è½‰çœ‹èµ·ä¾†å¾ˆé•·å¾ˆéš¨æ©Ÿï¼Œè‡³å°‘è½‰8-12åœˆ)
            const fullRotations = Math.floor(Math.random() * 5) + 8; // 8åˆ°12åœˆ
            const totalDegreesToSpin = (fullRotations * totalDegrees) + targetAngle;

            // 5. è¨ˆç®—æœ€çµ‚æ—‹è½‰è§’åº¦ï¼ˆå¾ç•¶å‰è§’åº¦è¨ˆç®—ï¼‰
            const currentRotationInDegrees = currentRotation % totalDegrees;
            const degreesToGo = totalDegreesToSpin - currentRotationInDegrees;
            const finalRotation = currentRotation + degreesToGo;

            // 6. è¨­å®š CSS Transform
            canvas.style.transform = `rotate(${finalRotation}deg)`;

            // 8. æ—‹è½‰å‹•ç•«æŒçºŒæ™‚é–“ (5 ç§’ï¼Œå¿…é ˆèˆ‡ CSS transition ä¿æŒä¸€è‡´)
            const duration = 5000;

            setTimeout(() => {
                isSpinning = false;
                spinButton.disabled = false;
                currentRotation = finalRotation % totalDegrees; // æ›´æ–°ç•¶å‰è§’åº¦

                // 8. é¡¯ç¤ºçµæœä¸¦è¨˜éŒ„
                showResult(selectedSegment.label, selectedSegment.color);
                addHistoryRecord(selectedSegment.label, selectedSegment.color);

            }, duration);
        }

        function showResult(resultLabel, resultColor) {
            // å°‡ hex é¡è‰²è½‰æ›ç‚º RGB ç”¨æ–¼èƒŒæ™¯
            const hex = resultColor.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);

            resultDisplay.textContent = `çµæœæ˜¯... ${resultLabel}ï¼`;
            resultDisplay.style.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.9)`;
            resultDisplay.className = "min-h-[50px] w-full text-center text-2xl font-extrabold text-white p-3 rounded-lg transition-all duration-500 shadow-2xl";
        }

        // ç›£è½é…ç½®è®ŠåŒ–ï¼ˆç•¶å¾Œå°æ›´æ–°é…ç½®æ™‚ï¼‰
        window.addEventListener('storage', (e) => {
            if (e.key === 'wheelConfig') {
                config = loadConfig();
                initSegments();
                drawWheel();
                updateOptionsDisplay();
                updateTitleAndDescription();
                resetWheel(); // é…ç½®æ›´æ–°æ™‚é‡ç½®è½‰ç›¤
            }
        });

        // å®šæœŸæª¢æŸ¥é…ç½®è®ŠåŒ–ï¼ˆåŒé é¢å…§æ›´æ–°ï¼‰
        setInterval(() => {
            const newConfig = loadConfig();
            if (JSON.stringify(newConfig) !== JSON.stringify(config)) {
                config = newConfig;
                initSegments();
                drawWheel();
                updateOptionsDisplay();
                updateTitleAndDescription();
                resetWheel(); // é…ç½®æ›´æ–°æ™‚é‡ç½®è½‰ç›¤
            }
        }, 500);

        // äº‹ä»¶ç›£è½
        spinButton.addEventListener('click', spinWheel);
        document.getElementById('resetHistoryBtn').addEventListener('click', resetHistory);

        // åˆå§‹åŒ–æ­·å²è¨˜éŒ„é¡¯ç¤º
        renderHistory();

        // è®“è½‰ç›¤åœ¨è¦–çª—å¤§å°æ”¹è®Šæ™‚ä¿æŒæ­£ç¢ºçš„å°ºå¯¸
        window.addEventListener('resize', () => {
            // åœ¨é€™è£¡æˆ‘å€‘ä¾è³´ CSS W-full/H-full å’Œ aspect-ratio ä¾†è™•ç†éŸ¿æ‡‰æ€§ï¼Œ
            // åªéœ€è¦é‡æ–°ç¹ªè£½ç¢ºä¿æ–‡å­—æ¸…æ™°ã€‚
            // å¯¦éš› Canvas å°ºå¯¸åœ¨ HTML ä¸­å›ºå®šç‚º 400x400ï¼Œä½†æœƒè¢« CSS ç¸®æ”¾ã€‚
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘åªåœ¨åˆå§‹åŒ–æ™‚ç¹ªè£½ä¸€æ¬¡ï¼Œå¦‚æœéœ€è¦æ›´ç²¾ç¢ºçš„éŸ¿æ‡‰å¼ç¹ªåœ–ï¼Œ
            // å‰‡éœ€è¦æ ¹æ“šå¯¦éš›æ¸²æŸ“å¤§å°èª¿æ•´ `canvas.width/height` å’Œç¹ªåœ–åƒæ•¸ã€‚
        });

    </script>
</body>
</html>
